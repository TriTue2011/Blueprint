blueprint:
  name: Nháº¯c nhá»Ÿ Lá»‹ch Ã‚m + Thá»i Tiáº¿t
  description: >
    Tá»± Ä‘á»™ng nháº¯c nhá»Ÿ cÃ¡c sá»± kiá»‡n Ã¢m lá»‹ch kÃ¨m theo thÃ´ng tin thá»i tiáº¿t.
    Há»— trá»£ gá»­i thÃ´ng bÃ¡o qua Mobile App, Telegram, Zalo Bot, Zalo Custom vÃ  TTS.
    
    - TÃ­ch há»£p thÃ´ng bÃ¡o thá»i tiáº¿t
    - Báº­t/táº¯t riÃªng cho Lá»‹ch Ã¢m vÃ  Thá»i tiáº¿t
    - AI biÃªn táº­p thÃ´ng tin thá»i tiáº¿t vá»›i nháº¯c nhá»Ÿ vÃ  khuyáº¿n cÃ¡o
    - ThÃ´ng bÃ¡o thá»i tiáº¿t theo lá»‹ch trÃ¬nh (khÃ´ng phá»¥ thuá»™c sá»‘ ngÃ y)
    - Khi cÃ³ sá»± kiá»‡n lá»‹ch: káº¿t há»£p cáº£ lá»‹ch + thá»i tiáº¿t
    - Khi khÃ´ng cÃ³ sá»± kiá»‡n: chá»‰ thÃ´ng bÃ¡o thá»i tiáº¿t
    
  domain: automation

  input:
    notification_toggle:
      name: ğŸ›ï¸ Báº­t/Táº¯t ThÃ´ng BÃ¡o
      icon: mdi:toggle-switch
      collapsed: false
      input:
        enable_lunar_notification:
          name: âœ… Báº­t thÃ´ng bÃ¡o Lá»‹ch Ã‚m
          description: Báº­t/táº¯t nháº¯c nhá»Ÿ sá»± kiá»‡n Ã¢m lá»‹ch
          default: true
          selector:
            boolean:

        enable_weather_notification:
          name: âœ… Báº­t thÃ´ng bÃ¡o Thá»i Tiáº¿t
          description: Báº­t/táº¯t thÃ´ng bÃ¡o thá»i tiáº¿t hÃ ng ngÃ y
          default: true
          selector:
            boolean:

    basic_settings:
      name: âš™ï¸ CÃ i Ä‘áº·t cÆ¡ báº£n - Lá»‹ch Ã‚m
      icon: mdi:cog
      collapsed: false
      input:
        days_before:
          name: Nháº¯c trÆ°á»›c bao nhiÃªu ngÃ y
          description: Danh sÃ¡ch sá»‘ ngÃ y, vÃ­ dá»¥ [15, 7, 5, 3, 1]
          default: [15, 7, 5, 3, 1]
          selector:
            object:

        notification_times:
          name: CÃ¡c thá»i Ä‘iá»ƒm thÃ´ng bÃ¡o
          description: Danh sÃ¡ch thá»i gian trong ngÃ y, vÃ­ dá»¥ ["08:00:00", "20:00:00"]
          default: ["08:00:00"]
          selector:
            object:

        event_filter:
          name: Loáº¡i sá»± kiá»‡n
          description: Chá»n loáº¡i sá»± kiá»‡n muá»‘n nháº­n thÃ´ng bÃ¡o
          default: all
          selector:
            select:
              options:
                - label: "Táº¥t cáº£ sá»± kiá»‡n Ã¢m lá»‹ch"
                  value: "all"
                - label: "Chá»‰ ngÃ y giá»—"
                  value: "gio"
                - label: "Chá»‰ Má»“ng 1 vÃ  Ráº±m"
                  value: "ngay_le"
                - label: "TÃ¹y chá»‰nh - Chá»n sensors cá»¥ thá»ƒ"
                  value: "custom"

        custom_sensors:
          name: Chá»n sensors cá»¥ thá»ƒ
          description: Chá»‰ dÃ¹ng khi chá»n TÃ¹y chá»‰nh á»Ÿ trÃªn
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: sensor

        include_description:
          name: Hiá»ƒn thá»‹ mÃ´ táº£ chi tiáº¿t
          description: Báº­t Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng tin Ã¢m lá»‹ch trong thÃ´ng bÃ¡o
          default: true
          selector:
            boolean:

        different_message_by_time:
          name: ThÃ´ng bÃ¡o khÃ¡c nhau theo thá»i gian
          description: Báº­t Ä‘á»ƒ hiá»ƒn thá»‹ emoji khÃ¡c nhau vÃ o sÃ¡ng trÆ°a tá»‘i
          default: true
          selector:
            boolean:

    weather_settings:
      name: ğŸŒ¤ï¸ CÃ i Ä‘áº·t Thá»i Tiáº¿t
      icon: mdi:weather-partly-cloudy
      collapsed: false
      input:
        weather_entity:
          name: Thá»±c thá»ƒ thá»i tiáº¿t
          description: Weather entity chÃ­nh (weather.*)
          default: ''
          selector:
            entity:
              filter:
                - domain: weather

        temperature_sensor:
          name: Cáº£m biáº¿n nhiá»‡t Ä‘á»™ (tÃ¹y chá»n)
          default: ''
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: temperature

        humidity_sensor:
          name: Cáº£m biáº¿n Ä‘á»™ áº©m (tÃ¹y chá»n)
          default: ''
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: humidity

        wind_speed_sensor:
          name: Cáº£m biáº¿n tá»‘c Ä‘á»™ giÃ³ (tÃ¹y chá»n)
          default: ''
          selector:
            entity:
              filter:
                - domain: sensor

        aqi_sensor:
          name: AQI - Chá»‰ sá»‘ cháº¥t lÆ°á»£ng khÃ´ng khÃ­ (tÃ¹y chá»n)
          default: ''
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: aqi

        pm25_sensor:
          name: PM2.5 (tÃ¹y chá»n)
          default: ''
          selector:
            entity:
              filter:
                - domain: sensor

    ai_settings:
      name: ğŸ¤– AI Editing Settings
      icon: mdi:robot
      collapsed: false
      input:
        enable_ai_message_editing:
          name: âœ… Báº­t AI biÃªn táº­p cho tin nháº¯n
          description: AI viáº¿t láº¡i tin nháº¯n (Mobile/Telegram/Zalo) sinh Ä‘á»™ng hÆ¡n, giá»¯ emoji
          default: false
          selector:
            boolean:

        enable_ai_tts_editing:
          name: âœ… Báº­t AI biÃªn táº­p cho TTS
          description: AI viáº¿t láº¡i ná»™i dung TTS tá»± nhiÃªn hÆ¡n, loáº¡i bá» emoji
          default: true
          selector:
            boolean:

        enable_ai_weather_editing:
          name: âœ… Báº­t AI biÃªn táº­p Thá»i Tiáº¿t
          description: AI phÃ¢n tÃ­ch thá»i tiáº¿t vÃ  Ä‘Æ°a ra nháº¯c nhá»Ÿ, khuyáº¿n cÃ¡o phÃ¹ há»£p
          default: true
          selector:
            boolean:

        ai_task_entity:
          name: ğŸ§  AI Task Entity
          description: Entity AI task Ä‘á»ƒ biÃªn táº­p
          default: ai_task.google_ai_task
          selector:
            entity:
              filter:
                - domain: ai_task

    mobile_app_section:
      name: ğŸ“± Mobile App Settings
      icon: mdi:cellphone
      collapsed: true
      input:
        include_mobile_notify:
          name: âœ… Báº­t thÃ´ng bÃ¡o Mobile App
          default: false
          selector:
            boolean:

        is_ios_android:
          name: Loáº¡i thiáº¿t bá»‹
          default: android_device
          selector:
            select:
              options:
                - label: Android
                  value: android_device
                - label: iOS
                  value: ios_device
              sort: false
              multiple: false

        notify_device:
          name: ğŸ“± Thiáº¿t bá»‹ nháº­n thÃ´ng bÃ¡o
          default: []
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true

        mobile_notification_icon:
          name: ğŸ”” Biá»ƒu tÆ°á»£ng thÃ´ng bÃ¡o (Android)
          default: mdi:calendar-star
          selector:
            icon:

        mobile_notification_color:
          name: ğŸ¨ MÃ u thÃ´ng bÃ¡o (Android)
          default: [255, 165, 0]
          selector:
            color_rgb:

        mobile_tap_action:
          name: ğŸ“² HÃ nh Ä‘á»™ng khi nháº¥n
          default: /lovelace/calendar
          selector:
            text:

    telegram_section:
      name: âœˆï¸ Telegram Settings
      icon: mdi:send
      collapsed: true
      input:
        include_telegram_notify:
          name: âœ… Báº­t thÃ´ng bÃ¡o Telegram
          default: false
          selector:
            boolean:

        telegram_config_entry:
          name: Telegram Bot
          default: ''
          selector:
            config_entry:
              integration: telegram_bot

        telegram_target:
          name: Target Chat ID
          default: ''
          selector:
            text:

        telegram_thread_id:
          name: Thread ID (Optional)
          default: ''
          selector:
            text:

    zalo_bot_section:
      name: ğŸ’¬ Zalo Bot Settings (Pyscript)
      icon: mdi:chat
      collapsed: true
      input:
        enable_zalo_bot:
          name: âœ… Báº­t Zalo Bot
          description: Sá»­ dá»¥ng pyscript Ä‘á»ƒ gá»­i thÃ´ng bÃ¡o
          default: false
          selector:
            boolean:

        zalo_bot_chat_id:
          name: Zalo Bot Chat ID
          default: ''
          selector:
            text:

    zalo_custom_section:
      name: ğŸ’¬ Zalo Custom Integration Settings
      icon: mdi:chat-processing
      collapsed: true
      input:
        enable_zalo_custom:
          name: âœ… Báº­t Zalo Custom
          default: false
          selector:
            boolean:

        zalo_custom_account:
          name: ğŸ“± TÃ i khoáº£n Zalo
          description: Sá»‘ Ä‘iá»‡n thoáº¡i gá»­i tin nháº¯n
          default: ''
          selector:
            text:

        zalo_custom_thread_id_1:
          name: ğŸ’¬ Thread ID 1
          description: ID cuá»™c há»™i thoáº¡i thá»© 1
          default: ''
          selector:
            text:

        zalo_custom_thread_id_2:
          name: ğŸ’¬ Thread ID 2
          description: ID cuá»™c há»™i thoáº¡i thá»© 2 (optional)
          default: ''
          selector:
            text:

        zalo_custom_thread_id_3:
          name: ğŸ’¬ Thread ID 3
          description: ID cuá»™c há»™i thoáº¡i thá»© 3 (optional)
          default: ''
          selector:
            text:

        zalo_custom_user_id_1:
          name: ğŸ‘¤ User ID 1
          description: ID ngÆ°á»i dÃ¹ng thá»© 1
          default: ''
          selector:
            text:

        zalo_custom_user_id_2:
          name: ğŸ‘¤ User ID 2
          description: ID ngÆ°á»i dÃ¹ng thá»© 2 (optional)
          default: ''
          selector:
            text:

        zalo_custom_user_id_3:
          name: ğŸ‘¤ User ID 3
          description: ID ngÆ°á»i dÃ¹ng thá»© 3 (optional)
          default: ''
          selector:
            text:

        zalo_custom_receiver_type:
          name: ğŸ‘¥ Loáº¡i ngÆ°á»i nháº­n
          default: '0'
          selector:
            select:
              options:
                - label: User (CÃ¡ nhÃ¢n)
                  value: '0'
                - label: Group (NhÃ³m)
                  value: '1'

        zalo_custom_ttl:
          name: â±ï¸ Message TTL (ms)
          description: Thá»i gian tá»± thu há»“i (0 = khÃ´ng thu há»“i)
          default: 0
          selector:
            number:
              min: 0
              max: 86400000
              step: 1000
              mode: slider

    tts_section:
      name: ğŸ”Š TTS Speaker Settings
      icon: mdi:speaker
      collapsed: true
      input:
        include_tts_announcement:
          name: âœ… Báº­t thÃ´ng bÃ¡o TTS
          default: false
          selector:
            boolean:

        tts_volume:
          name: ğŸ”Š Ã‚m lÆ°á»£ng
          default: 0.5
          selector:
            number:
              min: 0.1
              max: 1.0
              step: 0.1
              mode: slider

        tts_engine:
          name: ğŸ—£ï¸ TTS Engine
          default: []
          selector:
            entity:
              filter:
                - domain: tts
              multiple: false

        media_player:
          name: ğŸ¶ Media Player
          default: []
          selector:
            entity:
              filter:
                - domain: media_player
              multiple: true

mode: parallel
max_exceeded: silent

variables:
  enable_lunar_notification: !input enable_lunar_notification
  enable_weather_notification: !input enable_weather_notification
  
  days_before: !input days_before
  event_filter: !input event_filter
  custom_sensors: !input custom_sensors
  include_description: !input include_description
  different_message_by_time: !input different_message_by_time

  weather_entity: !input weather_entity
  temperature_sensor: !input temperature_sensor
  humidity_sensor: !input humidity_sensor
  wind_speed_sensor: !input wind_speed_sensor
  aqi_sensor: !input aqi_sensor
  pm25_sensor: !input pm25_sensor

  enable_ai_message_editing: !input enable_ai_message_editing
  enable_ai_tts_editing: !input enable_ai_tts_editing
  enable_ai_weather_editing: !input enable_ai_weather_editing
  ai_task_entity: !input ai_task_entity

  include_mobile_notify: !input include_mobile_notify
  is_ios_android: !input is_ios_android
  notify_device: !input notify_device
  mobile_notification_color: !input mobile_notification_color
  mobile_notification_color_hex: '#{{ "%02x%02x%02x" | format(mobile_notification_color[0], mobile_notification_color[1], mobile_notification_color[2]) }}'
  
  include_telegram_notify: !input include_telegram_notify
  telegram_config_entry: !input telegram_config_entry
  telegram_target: !input telegram_target
  telegram_thread_id: !input telegram_thread_id

  enable_zalo_bot: !input enable_zalo_bot
  zalo_bot_chat_id: !input zalo_bot_chat_id

  enable_zalo_custom: !input enable_zalo_custom
  zalo_custom_account: !input zalo_custom_account
  zalo_custom_receiver_type: !input zalo_custom_receiver_type
  zalo_custom_ttl: !input zalo_custom_ttl

  include_tts_announcement: !input include_tts_announcement
  tts_volume: !input tts_volume
  tts_engine: !input tts_engine
  media_player: !input media_player

trigger:
  - platform: time
    at: !input notification_times

condition:
  - condition: template
    value_template: >
      {{ enable_lunar_notification or enable_weather_notification }}

action:
  # Kiá»ƒm tra cÃ³ sá»± kiá»‡n lá»‹ch Ã¢m hay khÃ´ng
  - variables:
      has_lunar_event: >
        {% set ns = namespace(found=false) %}
        {% if enable_lunar_notification %}
          {% set filter = event_filter %}
          {% set days = days_before %}
          
          {% if filter == 'custom' %}
            {% for entity_id in custom_sensors %}
              {% if states(entity_id) not in ['unknown', 'unavailable', 'none'] %}
                {% if state_attr(entity_id, 'days_until') != none %}
                  {% if (state_attr(entity_id, 'days_until') | int) in days %}
                    {% set ns.found = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% for s in states.sensor %}
              {% if state_attr(s.entity_id, 'loaisukien') == 'lunar' %}
                {% if s.state not in ['unknown', 'unavailable', 'none'] %}
                  {% if state_attr(s.entity_id, 'days_until') != none %}
                    {% if (state_attr(s.entity_id, 'days_until') | int) in days %}
                      {% if filter == 'all' %}
                        {% set ns.found = true %}
                      {% elif filter == 'gio' and 'gio_' in s.entity_id %}
                        {% set ns.found = true %}
                      {% elif filter == 'ngay_le' and 'gio_' not in s.entity_id %}
                        {% set ns.found = true %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
        {{ ns.found }}

  # Láº¥y danh sÃ¡ch sensor náº¿u cÃ³ sá»± kiá»‡n lá»‹ch
  - variables:
      sensor_entity_ids: >
        {% set ns = namespace(ids=[]) %}
        {% if enable_lunar_notification and has_lunar_event %}
          {% set filter = event_filter %}
          {% set days = days_before %}
          
          {% if filter == 'custom' %}
            {% for entity_id in custom_sensors %}
              {% if states(entity_id) not in ['unknown', 'unavailable', 'none'] %}
                {% if state_attr(entity_id, 'days_until') != none %}
                  {% if (state_attr(entity_id, 'days_until') | int) in days %}
                    {% set ns.ids = ns.ids + [entity_id] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% for s in states.sensor %}
              {% if state_attr(s.entity_id, 'loaisukien') == 'lunar' %}
                {% if s.state not in ['unknown', 'unavailable', 'none'] %}
                  {% if state_attr(s.entity_id, 'days_until') != none %}
                    {% if (state_attr(s.entity_id, 'days_until') | int) in days %}
                      {% if filter == 'all' %}
                        {% set ns.ids = ns.ids + [s.entity_id] %}
                      {% elif filter == 'gio' and 'gio_' in s.entity_id %}
                        {% set ns.ids = ns.ids + [s.entity_id] %}
                      {% elif filter == 'ngay_le' and 'gio_' not in s.entity_id %}
                        {% set ns.ids = ns.ids + [s.entity_id] %}
                      {% endif %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
        {{ ns.ids }}

  # Chuáº©n bá»‹ thÃ´ng tin thá»i tiáº¿t
  - variables:
      weather_state: >
        {% if enable_weather_notification and weather_entity %}
          {{ states(weather_entity) }}
        {% else %}
          
        {% endif %}
      temperature: >
        {% if enable_weather_notification %}
          {% if temperature_sensor %}
            {{ states(temperature_sensor) | float(0) | round(1) }}
          {% elif weather_entity %}
            {{ state_attr(weather_entity, 'temperature') | float(0) | round(1) }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      humidity: >
        {% if enable_weather_notification %}
          {% if humidity_sensor %}
            {{ states(humidity_sensor) | int(0) }}
          {% elif weather_entity %}
            {{ state_attr(weather_entity, 'humidity') | int(0) }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      wind_speed: >
        {% if enable_weather_notification %}
          {% if wind_speed_sensor %}
            {{ states(wind_speed_sensor) | float(0) | round(1) }}
          {% elif weather_entity %}
            {{ state_attr(weather_entity, 'wind_speed') | float(0) | round(1) }}
          {% else %}
            0
          {% endif %}
        {% else %}
          0
        {% endif %}
      aqi: >
        {% if enable_weather_notification and aqi_sensor %}
          {{ states(aqi_sensor) | int(0) }}
        {% else %}
          0
        {% endif %}
      pm25: >
        {% if enable_weather_notification and pm25_sensor %}
          {{ states(pm25_sensor) | float(0) | round(1) }}
        {% else %}
          0
        {% endif %}

  # Xá»­ lÃ½ khi cÃ³ sá»± kiá»‡n lá»‹ch
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ has_lunar_event and (sensor_entity_ids | length > 0) }}"
        sequence:
          - repeat:
              for_each: "{{ sensor_entity_ids }}"
              sequence:
                # Chuáº©n bá»‹ dá»¯ liá»‡u gá»‘c cá»§a lá»‹ch
                - variables:
                    sensor_state: "{{ states[repeat.item] }}"
                    event_name: "{{ state_attr(repeat.item, 'friendly_name') }}"
                    days_until: "{{ state_attr(repeat.item, 'days_until') | int }}"
                    nearest_date: "{{ state_attr(repeat.item, 'nearest_date') | default('N/A') }}"
                    ngay_am: "{{ state_attr(repeat.item, 'ngayam') | default('') }}"
                    thang_am: "{{ state_attr(repeat.item, 'thangam') | default('') }}"
                    mota: "{{ state_attr(repeat.item, 'mota') | default('') }}"
                    hour: "{{ now().hour }}"
                    time_prefix: >
                      {% if different_message_by_time %}
                        {% if hour | int < 12 %}ğŸŒ…
                        {% elif hour | int < 18 %}â˜€ï¸
                        {% else %}ğŸŒ™
                        {% endif %}
                      {% endif %}
                    original_title: >
                      {% set days = days_until | int %}
                      {% if days == 1 %}
                        {{ time_prefix }}âš ï¸ NGÃ€Y MAI: {{ event_name }}
                      {% elif days == 2 %}
                        {{ time_prefix }}ğŸ“… CÃ²n 2 ngÃ y: {{ event_name }}
                      {% elif days == 3 %}
                        {{ time_prefix }}ğŸ“Œ CÃ²n 3 ngÃ y: {{ event_name }}
                      {% elif days == 5 %}
                        {{ time_prefix }}ğŸ”” CÃ²n 5 ngÃ y: {{ event_name }}
                      {% elif days == 7 %}
                        {{ time_prefix }}ğŸ—“ï¸ CÃ²n 7 ngÃ y: {{ event_name }}
                      {% elif days == 15 %}
                        {{ time_prefix }}ğŸ“† CÃ²n 15 ngÃ y: {{ event_name }}
                      {% else %}
                        {{ time_prefix }}ğŸ“† CÃ²n {{ days }} ngÃ y: {{ event_name }}
                      {% endif %}
                    original_message: >
                      {% if different_message_by_time %}
                        {% if hour | int < 12 %}Nháº¯c nhá»Ÿ buá»•i sÃ¡ng
                        {% elif hour | int < 18 %}Nháº¯c nhá»Ÿ buá»•i trÆ°a
                        {% else %}Nháº¯c nhá»Ÿ buá»•i tá»‘i
                        {% endif %}

                      {% endif %}
                      ğŸ“… NgÃ y dÆ°Æ¡ng lá»‹ch: {{ nearest_date }}
                      {% if include_description and ngay_am %}
                      ğŸŒ™ NgÃ y Ã¢m lá»‹ch: {{ ngay_am }}{% if thang_am %}/{{ thang_am }}{% endif %}
                      {% endif %}
                      {% if include_description and mota %}

                      {{ mota }}
                      {% endif %}
                    tag: "lunar_{{ repeat.item | replace('.','_') }}_{{ days_until | int }}"

                # AI Message Editing (Lá»‹ch + Thá»i tiáº¿t)
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_ai_message_editing }}"
                      sequence:
                        - action: ai_task.generate_data
                          data:
                            task_name: "msg_edit_{{ repeat.item | replace('.','_') }}"
                            instructions: >
                              BiÃªn táº­p thÃ´ng bÃ¡o káº¿t há»£p Lá»‹ch Ã‚m vÃ  Thá»i Tiáº¿t.
                              
                              ğŸ“… THÃ”NG TIN Lá»ŠCH:
                              TiÃªu Ä‘á»: {{ original_title }}
                              Ná»™i dung: {{ original_message }}
                              TÃªn sá»± kiá»‡n: {{ event_name }}
                              CÃ²n {{ days_until }} ngÃ y
                              NgÃ y dÆ°Æ¡ng lá»‹ch: {{ nearest_date }}
                              {% if ngay_am %}NgÃ y Ã¢m lá»‹ch: {{ ngay_am }}{% if thang_am %}/{{ thang_am }}{% endif %}{% endif %}
                              {% if mota %}MÃ´ táº£: {{ mota }}{% endif %}
                              
                              ğŸŒ¤ï¸ THÃ”NG TIN THá»œI TIáº¾T:
                              {% if enable_weather_notification %}
                              TÃ¬nh tráº¡ng: {{ weather_state }}
                              Nhiá»‡t Ä‘á»™: {{ temperature }}Â°C
                              Äá»™ áº©m: {{ humidity }}%
                              GiÃ³: {{ wind_speed }} km/h
                              {% if aqi > 0 %}AQI: {{ aqi }}{% endif %}
                              {% if pm25 > 0 %}PM2.5: {{ pm25 }}{% endif %}
                              {% else %}
                              (KhÃ´ng cÃ³ thÃ´ng tin thá»i tiáº¿t)
                              {% endif %}
                              
                              YÃŠU Cáº¦U BIÃŠN Táº¬P:
                              âœ… Káº¾T Há»¢P cáº£ lá»‹ch vÃ  thá»i tiáº¿t má»™t cÃ¡ch tá»± nhiÃªn
                              âœ… GIá»® vÃ  tá»‘i Æ°u emoji (âš ï¸ğŸ“…ğŸ“ŒğŸ””ğŸ—“ï¸ğŸ“†ğŸŒ…â˜€ï¸ğŸŒ™ğŸ®ğŸ‹ğŸ•¯ï¸ğŸ’ğŸ™âœ¨ğŸŒ¤ï¸â›…â˜ï¸ğŸŒ§ï¸ğŸ’¨ğŸŒ¡ï¸)
                              âœ… Viáº¿t sinh Ä‘á»™ng, cÃ³ cáº£m xÃºc
                              âœ… Pháº§n lá»‹ch: giá»¯ Ä‘á»§ thÃ´ng tin (sá»‘ ngÃ y, ngÃ y dÆ°Æ¡ng, ngÃ y Ã¢m)
                              {% if enable_weather_notification %}
                              âœ… Pháº§n thá»i tiáº¿t: Ä‘Æ°a ra nháº¯c nhá»Ÿ, khuyáº¿n cÃ¡o phÃ¹ há»£p
                                 - Nhiá»‡t Ä‘á»™ cao: nháº¯c mang nÆ°á»›c, Ã´ che náº¯ng
                                 - MÆ°a: nháº¯c mang Ã¡o mÆ°a, Ã´
                                 - GiÃ³ máº¡nh: cáº©n tháº­n khi ra ngoÃ i
                                 - AQI cao: Ä‘eo kháº©u trang, háº¡n cháº¿ ra ngoÃ i
                              âœ… Káº¿t ná»‘i tá»± nhiÃªn giá»¯a lá»‹ch vÃ  thá»i tiáº¿t
                              {% endif %}
                              âœ… Äá»™ dÃ i 4-7 dÃ²ng (cÃ³ thá»i tiáº¿t)
                              
                              VÃ Dá»¤ Tá»T:
                              Title: âš ï¸ NHáº®C NHá»š QUAN TRá»ŒNG + Dá»° BÃO THá»œI TIáº¾T
                              Message:
                              ğŸ•¯ï¸ NgÃ y mai (15/02/2026) lÃ  ngÃ y giá»— Ã´ng ná»™i
                              ğŸŒ™ Ã‚m lá»‹ch: 17/01
                              
                              ğŸŒ¤ï¸ Thá»i tiáº¿t: Trá»i náº¯ng 28Â°C, Ä‘á»™ áº©m 65%
                              ğŸ’¡ Khuyáº¿n cÃ¡o: Mang theo nÆ°á»›c uá»‘ng vÃ  Ã´ che náº¯ng khi Ä‘i chá»£ sáº¯m lá»… váº­t
                              
                              ğŸ™ Xin nhá»› chuáº©n bá»‹ hÆ°Æ¡ng hoa Ä‘áº§y Ä‘á»§
                            structure:
                              title:
                                description: TiÃªu Ä‘á» (1 dÃ²ng, cÃ³ emoji)
                                required: true
                                selector:
                                  text: null
                              message:
                                description: Ná»™i dung (4-7 dÃ²ng, cÃ³ emoji, káº¿t há»£p lá»‹ch + thá»i tiáº¿t)
                                required: true
                                selector:
                                  text: null
                            entity_id: "{{ ai_task_entity }}"
                          response_variable: msg_edit_result
                        
                        - wait_template: |
                            {{ msg_edit_result is defined 
                               and msg_edit_result.data is defined
                               and msg_edit_result.data.title is defined 
                               and msg_edit_result.data.message is defined }}
                          timeout: "00:01:00"
                          continue_on_timeout: true
                        
                        - variables:
                            final_title: >
                              {% if wait.completed %}
                                {{ msg_edit_result.data.title | trim }}
                              {% else %}
                                {{ original_title }}
                              {% endif %}
                            final_message: >
                              {% if wait.completed %}
                                {{ msg_edit_result.data.message | trim }}
                              {% else %}
                                {{ original_message }}
                              {% endif %}
                  
                  default:
                    - variables:
                        final_title: "{{ original_title }}"
                        final_message: "{{ original_message }}"

                # Gá»­i thÃ´ng bÃ¡o (Mobile, Telegram, Zalo...)
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ include_mobile_notify and (notify_device | length > 0) }}"
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ is_ios_android == 'android_device' }}"
                              sequence:
                                - repeat:
                                    for_each: "{{ notify_device }}"
                                    sequence:
                                      - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                        data:
                                          title: "{{ final_title }}"
                                          message: "{{ final_message }}"
                                          data:
                                            priority: high
                                            notification_icon: !input mobile_notification_icon
                                            color: "{{ mobile_notification_color_hex }}"
                                            url: !input mobile_tap_action
                                            clickAction: !input mobile_tap_action
                                            tag: "{{ tag }}"
                            - conditions:
                                - condition: template
                                  value_template: "{{ is_ios_android == 'ios_device' }}"
                              sequence:
                                - repeat:
                                    for_each: "{{ notify_device }}"
                                    sequence:
                                      - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                        data:
                                          title: "{{ final_title }}"
                                          message: "{{ final_message }}"
                                          data:
                                            tag: "{{ tag }}"

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ include_telegram_notify }}"
                      sequence:
                        - service: telegram_bot.send_message
                          data: >
                            {% set data = {'config_entry_id': telegram_config_entry, 'message': final_title ~ '\n\n' ~ final_message} %}
                            {% if telegram_target != "" %}
                              {% set data = dict(data, target=telegram_target|int) %}
                            {% endif %}
                            {% if telegram_thread_id != "" %}
                              {% set data = dict(data, message_thread_id=telegram_thread_id|int) %}
                            {% endif %}
                            {{ data }}

                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_zalo_bot }}"
                      sequence:
                        - service: pyscript.send_zalo_message
                          data:
                            chat_id: "{{ zalo_bot_chat_id }}"
                            message: "{{ final_title }}\n\n{{ final_message }}"

                - variables:
                    zalo_custom_thread_id_1: !input zalo_custom_thread_id_1
                    zalo_custom_thread_id_2: !input zalo_custom_thread_id_2
                    zalo_custom_thread_id_3: !input zalo_custom_thread_id_3
                    zalo_custom_user_id_1: !input zalo_custom_user_id_1
                    zalo_custom_user_id_2: !input zalo_custom_user_id_2
                    zalo_custom_user_id_3: !input zalo_custom_user_id_3
                
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ enable_zalo_custom }}"
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_thread_id_1 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    thread_id: !input zalo_custom_thread_id_1
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl
                        
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_thread_id_2 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    thread_id: !input zalo_custom_thread_id_2
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl
                        
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_thread_id_3 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    thread_id: !input zalo_custom_thread_id_3
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl
                        
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_user_id_1 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    user_id: !input zalo_custom_user_id_1
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl
                        
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_user_id_2 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    user_id: !input zalo_custom_user_id_2
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl
                        
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ zalo_custom_user_id_3 | length > 0 }}"
                              sequence:
                                - service: zalo_bot.send_message
                                  data:
                                    account_selection: !input zalo_custom_account
                                    user_id: !input zalo_custom_user_id_3
                                    type: !input zalo_custom_receiver_type
                                    message: "{{ final_title }}\n\n{{ final_message }}"
                                    ttl: !input zalo_custom_ttl

                # TTS vá»›i AI editing
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ include_tts_announcement and (media_player | length > 0) }}"
                      sequence:
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ enable_ai_tts_editing }}"
                              sequence:
                                - action: ai_task.generate_data
                                  data:
                                    task_name: "tts_edit_{{ repeat.item | replace('.','_') }}"
                                    instructions: >
                                      BiÃªn táº­p thÃ´ng bÃ¡o TTS káº¿t há»£p Lá»‹ch Ã‚m vÃ  Thá»i Tiáº¿t.
                                      
                                      THÃ”NG TIN Lá»ŠCH:
                                      Sá»± kiá»‡n: {{ event_name }}
                                      CÃ²n {{ days_until }} ngÃ y
                                      NgÃ y dÆ°Æ¡ng lá»‹ch: {{ nearest_date }}
                                      {% if ngay_am %}NgÃ y Ã¢m lá»‹ch: {{ ngay_am }}{% if thang_am %}/{{ thang_am }}{% endif %}{% endif %}
                                      {% if mota %}MÃ´ táº£: {{ mota }}{% endif %}
                                      
                                      THÃ”NG TIN THá»œI TIáº¾T:
                                      {% if enable_weather_notification %}
                                      TÃ¬nh tráº¡ng: {{ weather_state }}
                                      Nhiá»‡t Ä‘á»™: {{ temperature }}Â°C
                                      Äá»™ áº©m: {{ humidity }}%
                                      GiÃ³: {{ wind_speed }} km/h
                                      {% if aqi > 0 %}AQI: {{ aqi }}{% endif %}
                                      {% if pm25 > 0 %}PM2.5: {{ pm25 }}{% endif %}
                                      {% endif %}
                                      
                                      YÃŠU Cáº¦U:
                                      âŒ LOáº I Bá» emoji
                                      âœ… Viáº¿t tá»± nhiÃªn dá»… nghe
                                      âœ… Chuyá»ƒn sá»‘ thÃ nh chá»¯
                                      âœ… Káº¿t há»£p lá»‹ch + thá»i tiáº¿t + khuyáº¿n cÃ¡o
                                      âœ… 3-4 cÃ¢u, ngáº¯n gá»n
                                      âœ… KHÃ”NG xuá»‘ng dÃ²ng
                                      
                                      VÃ Dá»¤:
                                      "Nháº¯c nhá»Ÿ quan trá»ng, ngÃ y mai lÃ  ngÃ y giá»— Ã´ng ná»™i vÃ o ngÃ y mÆ°á»i lÄƒm thÃ¡ng hai, theo Ã¢m lá»‹ch lÃ  ngÃ y mÆ°á»i báº£y thÃ¡ng giÃªng. Dá»± bÃ¡o thá»i tiáº¿t náº¯ng hai mÆ°Æ¡i tÃ¡m Ä‘á»™ C, Ä‘á»™ áº©m sÃ¡u mÆ°Æ¡i lÄƒm pháº§n trÄƒm. Xin nhá»› mang theo nÆ°á»›c uá»‘ng vÃ  Ã´ che náº¯ng khi Ä‘i chá»£ sáº¯m lá»… váº­t."
                                    structure:
                                      tts_text:
                                        description: Ná»™i dung TTS
                                        required: true
                                        selector:
                                          text: null
                                    entity_id: "{{ ai_task_entity }}"
                                  response_variable: tts_edit_result
                                
                                - wait_template: |
                                    {{ tts_edit_result is defined 
                                       and tts_edit_result.data is defined
                                       and tts_edit_result.data.tts_text is defined }}
                                  timeout: "00:01:00"
                                  continue_on_timeout: true
                                
                                - if:
                                    - condition: template
                                      value_template: "{{ wait.completed }}"
                                  then:
                                    - repeat:
                                        for_each: "{{ media_player }}"
                                        sequence:
                                          - service: media_player.volume_set
                                            data:
                                              volume_level: "{{ tts_volume }}"
                                            target:
                                              entity_id: "{{ repeat.item }}"
                                          - service: tts.speak
                                            data:
                                              entity_id: "{{ tts_engine }}"
                                              media_player_entity_id: "{{ repeat.item }}"
                                              message: "{{ tts_edit_result.data.tts_text | trim }}"
                                  else:
                                    - repeat:
                                        for_each: "{{ media_player }}"
                                        sequence:
                                          - service: media_player.volume_set
                                            data:
                                              volume_level: "{{ tts_volume }}"
                                            target:
                                              entity_id: "{{ repeat.item }}"
                                          - service: tts.speak
                                            data:
                                              entity_id: "{{ tts_engine }}"
                                              media_player_entity_id: "{{ repeat.item }}"
                                              message: "{{ event_name }}. {{ original_message }}"
                          
                          default:
                            - repeat:
                                for_each: "{{ media_player }}"
                                sequence:
                                  - service: media_player.volume_set
                                    data:
                                      volume_level: "{{ tts_volume }}"
                                    target:
                                      entity_id: "{{ repeat.item }}"
                                  - service: tts.speak
                                    data:
                                      entity_id: "{{ tts_engine }}"
                                      media_player_entity_id: "{{ repeat.item }}"
                                      message: "{{ event_name }}. {{ original_message }}"

  # Xá»­ lÃ½ khi KHÃ”NG cÃ³ sá»± kiá»‡n lá»‹ch nhÆ°ng cÃ³ thá»i tiáº¿t
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ not has_lunar_event and enable_weather_notification }}"
        sequence:
          - variables:
              hour: "{{ now().hour }}"
              time_prefix: >
                {% if different_message_by_time %}
                  {% if hour | int < 12 %}ğŸŒ…
                  {% elif hour | int < 18 %}â˜€ï¸
                  {% else %}ğŸŒ™
                  {% endif %}
                {% endif %}
              weather_title_base: >
                {% if hour | int < 12 %}
                  {{ time_prefix }} Dá»° BÃO THá»œI TIáº¾T BUá»”I SÃNG
                {% elif hour | int < 18 %}
                  {{ time_prefix }} Dá»° BÃO THá»œI TIáº¾T BUá»”I CHIá»€U
                {% else %}
                  {{ time_prefix }} Dá»° BÃO THá»œI TIáº¾T BUá»”I Tá»I
                {% endif %}
              weather_message_base: >
                ğŸŒ¤ï¸ TÃ¬nh tráº¡ng: {{ weather_state }}
                ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™: {{ temperature }}Â°C
                ğŸ’§ Äá»™ áº©m: {{ humidity }}%
                ğŸ’¨ GiÃ³: {{ wind_speed }} km/h
                {% if aqi > 0 %}
                ğŸ­ AQI: {{ aqi }}
                {% endif %}
                {% if pm25 > 0 %}
                âš ï¸ PM2.5: {{ pm25 }}
                {% endif %}

          # AI Weather Editing
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_ai_weather_editing }}"
                sequence:
                  - action: ai_task.generate_data
                    data:
                      task_name: "weather_only_edit"
                      instructions: >
                        BiÃªn táº­p thÃ´ng bÃ¡o THá»œI TIáº¾T vá»›i nháº¯c nhá»Ÿ vÃ  khuyáº¿n cÃ¡o.
                        
                        ğŸŒ¤ï¸ THÃ”NG TIN THá»œI TIáº¾T:
                        TÃ¬nh tráº¡ng: {{ weather_state }}
                        Nhiá»‡t Ä‘á»™: {{ temperature }}Â°C
                        Äá»™ áº©m: {{ humidity }}%
                        GiÃ³: {{ wind_speed }} km/h
                        {% if aqi > 0 %}AQI: {{ aqi }}{% endif %}
                        {% if pm25 > 0 %}PM2.5: {{ pm25 }}{% endif %}
                        
                        â° THá»œI GIAN:
                        {% if hour | int < 12 %}Buá»•i sÃ¡ng
                        {% elif hour | int < 18 %}Buá»•i chiá»u
                        {% else %}Buá»•i tá»‘i
                        {% endif %}
                        
                        YÃŠU Cáº¦U BIÃŠN Táº¬P:
                        âœ… GIá»® emoji thá»i tiáº¿t (ğŸŒ¤ï¸â›…â˜ï¸ğŸŒ§ï¸â›ˆï¸ğŸŒ¡ï¸ğŸ’§ğŸ’¨ğŸ­âš ï¸ğŸŒ…â˜€ï¸ğŸŒ™)
                        âœ… Viáº¿t sinh Ä‘á»™ng, dá»… Ä‘á»c
                        âœ… ÄÆ¯A RA nháº¯c nhá»Ÿ, khuyáº¿n cÃ¡o cá»¥ thá»ƒ:
                           - Nhiá»‡t Ä‘á»™ cao (>30Â°C): nháº¯c mang nÆ°á»›c, Ã´ che náº¯ng, trÃ¡nh ra ngoÃ i giá»¯a trÆ°a
                           - Nhiá»‡t Ä‘á»™ tháº¥p (<20Â°C): nháº¯c máº·c áº¥m, mang Ã¡o khoÃ¡c
                           - MÆ°a/sáº¯p mÆ°a: nháº¯c mang Ã¡o mÆ°a, Ã´
                           - GiÃ³ máº¡nh (>20 km/h): cáº©n tháº­n khi ra ngoÃ i
                           - Äá»™ áº©m cao (>80%): cáº£m giÃ¡c oi bá»©c
                           - AQI cao (>100): Ä‘eo kháº©u trang, háº¡n cháº¿ ra ngoÃ i
                           - PM2.5 cao: Ä‘áº·c biá»‡t nguy hiá»ƒm, trÃ¡nh hoáº¡t Ä‘á»™ng ngoÃ i trá»i
                        âœ… PhÃ¹ há»£p vá»›i buá»•i trong ngÃ y
                        âœ… Äá»™ dÃ i 4-6 dÃ²ng
                        
                        VÃ Dá»¤ Tá»T:
                        Title: ğŸŒ… Dá»° BÃO THá»œI TIáº¾T BUá»”I SÃNG
                        Message:
                        â˜€ï¸ HÃ´m nay trá»i náº¯ng nÃ³ng 32Â°C, Ä‘á»™ áº©m 70%
                        ğŸ’¨ GiÃ³ nháº¹ 8 km/h
                        
                        ğŸ’¡ Khuyáº¿n cÃ¡o:
                        - Mang theo nÆ°á»›c uá»‘ng Ä‘áº§y Ä‘á»§
                        - DÃ¹ng Ã´ hoáº·c mÅ© che náº¯ng khi ra ngoÃ i
                        - Háº¡n cháº¿ hoáº¡t Ä‘á»™ng ngoÃ i trá»i tá»« 11h-15h
                        
                        ğŸ™ ChÃºc báº¡n má»™t ngÃ y tá»‘t lÃ nh!
                      structure:
                        title:
                          description: TiÃªu Ä‘á» (1 dÃ²ng, cÃ³ emoji)
                          required: true
                          selector:
                            text: null
                        message:
                          description: Ná»™i dung (4-6 dÃ²ng, cÃ³ emoji, cÃ³ khuyáº¿n cÃ¡o)
                          required: true
                          selector:
                            text: null
                      entity_id: "{{ ai_task_entity }}"
                    response_variable: weather_edit_result
                  
                  - wait_template: |
                      {{ weather_edit_result is defined 
                         and weather_edit_result.data is defined
                         and weather_edit_result.data.title is defined 
                         and weather_edit_result.data.message is defined }}
                    timeout: "00:01:00"
                    continue_on_timeout: true
                  
                  - variables:
                      weather_final_title: >
                        {% if wait.completed %}
                          {{ weather_edit_result.data.title | trim }}
                        {% else %}
                          {{ weather_title_base }}
                        {% endif %}
                      weather_final_message: >
                        {% if wait.completed %}
                          {{ weather_edit_result.data.message | trim }}
                        {% else %}
                          {{ weather_message_base }}
                        {% endif %}
            
            default:
              - variables:
                  weather_final_title: "{{ weather_title_base }}"
                  weather_final_message: "{{ weather_message_base }}"

          # Gá»­i thÃ´ng bÃ¡o thá»i tiáº¿t
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ include_mobile_notify and (notify_device | length > 0) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ is_ios_android == 'android_device' }}"
                        sequence:
                          - repeat:
                              for_each: "{{ notify_device }}"
                              sequence:
                                - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                  data:
                                    title: "{{ weather_final_title }}"
                                    message: "{{ weather_final_message }}"
                                    data:
                                      priority: high
                                      notification_icon: !input mobile_notification_icon
                                      color: "{{ mobile_notification_color_hex }}"
                                      url: !input mobile_tap_action
                                      clickAction: !input mobile_tap_action
                                      tag: "weather_only"
                      - conditions:
                          - condition: template
                            value_template: "{{ is_ios_android == 'ios_device' }}"
                        sequence:
                          - repeat:
                              for_each: "{{ notify_device }}"
                              sequence:
                                - service: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
                                  data:
                                    title: "{{ weather_final_title }}"
                                    message: "{{ weather_final_message }}"
                                    data:
                                      tag: "weather_only"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ include_telegram_notify }}"
                sequence:
                  - service: telegram_bot.send_message
                    data: >
                      {% set data = {'config_entry_id': telegram_config_entry, 'message': weather_final_title ~ '\n\n' ~ weather_final_message} %}
                      {% if telegram_target != "" %}
                        {% set data = dict(data, target=telegram_target|int) %}
                      {% endif %}
                      {% if telegram_thread_id != "" %}
                        {% set data = dict(data, message_thread_id=telegram_thread_id|int) %}
                      {% endif %}
                      {{ data }}

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_zalo_bot }}"
                sequence:
                  - service: pyscript.send_zalo_message
                    data:
                      chat_id: "{{ zalo_bot_chat_id }}"
                      message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"

          - variables:
              zalo_custom_thread_id_1: !input zalo_custom_thread_id_1
              zalo_custom_thread_id_2: !input zalo_custom_thread_id_2
              zalo_custom_thread_id_3: !input zalo_custom_thread_id_3
              zalo_custom_user_id_1: !input zalo_custom_user_id_1
              zalo_custom_user_id_2: !input zalo_custom_user_id_2
              zalo_custom_user_id_3: !input zalo_custom_user_id_3
          
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ enable_zalo_custom }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_thread_id_1 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              thread_id: !input zalo_custom_thread_id_1
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl
                  
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_thread_id_2 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              thread_id: !input zalo_custom_thread_id_2
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl
                  
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_thread_id_3 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              thread_id: !input zalo_custom_thread_id_3
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl
                  
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_user_id_1 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              user_id: !input zalo_custom_user_id_1
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl
                  
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_user_id_2 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              user_id: !input zalo_custom_user_id_2
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl
                  
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ zalo_custom_user_id_3 | length > 0 }}"
                        sequence:
                          - service: zalo_bot.send_message
                            data:
                              account_selection: !input zalo_custom_account
                              user_id: !input zalo_custom_user_id_3
                              type: !input zalo_custom_receiver_type
                              message: "{{ weather_final_title }}\n\n{{ weather_final_message }}"
                              ttl: !input zalo_custom_ttl

          # TTS cho thá»i tiáº¿t
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ include_tts_announcement and (media_player | length > 0) }}"
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ enable_ai_tts_editing }}"
                        sequence:
                          - action: ai_task.generate_data
                            data:
                              task_name: "tts_weather_only"
                              instructions: >
                                BiÃªn táº­p thÃ´ng bÃ¡o TTS chá»‰ vá» THá»œI TIáº¾T.
                                
                                THÃ”NG TIN:
                                TÃ¬nh tráº¡ng: {{ weather_state }}
                                Nhiá»‡t Ä‘á»™: {{ temperature }}Â°C
                                Äá»™ áº©m: {{ humidity }}%
                                GiÃ³: {{ wind_speed }} km/h
                                {% if aqi > 0 %}AQI: {{ aqi }}{% endif %}
                                {% if pm25 > 0 %}PM2.5: {{ pm25 }}{% endif %}
                                
                                Buá»•i: {% if hour | int < 12 %}SÃ¡ng{% elif hour | int < 18 %}Chiá»u{% else %}Tá»‘i{% endif %}
                                
                                YÃŠU Cáº¦U:
                                âŒ LOáº I Bá» emoji
                                âœ… Viáº¿t tá»± nhiÃªn dá»… nghe
                                âœ… Chuyá»ƒn sá»‘ thÃ nh chá»¯
                                âœ… Báº¯t Ä‘áº§u: "Dá»± bÃ¡o thá»i tiáº¿t buá»•i [sÃ¡ng/chiá»u/tá»‘i]..."
                                âœ… ÄÆ°a ra khuyáº¿n cÃ¡o phÃ¹ há»£p
                                âœ… 2-3 cÃ¢u, ngáº¯n gá»n
                                âœ… KHÃ”NG xuá»‘ng dÃ²ng
                                
                                VÃ Dá»¤:
                                "Dá»± bÃ¡o thá»i tiáº¿t buá»•i sÃ¡ng hÃ´m nay, trá»i náº¯ng nÃ³ng ba mÆ°Æ¡i hai Ä‘á»™ C, Ä‘á»™ áº©m báº£y mÆ°Æ¡i pháº§n trÄƒm, giÃ³ nháº¹. Xin nhá»› mang theo nÆ°á»›c uá»‘ng vÃ  Ã´ che náº¯ng khi ra ngoÃ i. ChÃºc báº¡n má»™t ngÃ y tá»‘t lÃ nh."
                              structure:
                                tts_text:
                                  description: Ná»™i dung TTS
                                  required: true
                                  selector:
                                    text: null
                              entity_id: "{{ ai_task_entity }}"
                            response_variable: tts_weather_result
                          
                          - wait_template: |
                              {{ tts_weather_result is defined 
                                 and tts_weather_result.data is defined
                                 and tts_weather_result.data.tts_text is defined }}
                            timeout: "00:01:00"
                            continue_on_timeout: true
                          
                          - if:
                              - condition: template
                                value_template: "{{ wait.completed }}"
                            then:
                              - repeat:
                                  for_each: "{{ media_player }}"
                                  sequence:
                                    - service: media_player.volume_set
                                      data:
                                        volume_level: "{{ tts_volume }}"
                                      target:
                                        entity_id: "{{ repeat.item }}"
                                    - service: tts.speak
                                      data:
                                        entity_id: "{{ tts_engine }}"
                                        media_player_entity_id: "{{ repeat.item }}"
                                        message: "{{ tts_weather_result.data.tts_text | trim }}"
                            else:
                              - repeat:
                                  for_each: "{{ media_player }}"
                                  sequence:
                                    - service: media_player.volume_set
                                      data:
                                        volume_level: "{{ tts_volume }}"
                                      target:
                                        entity_id: "{{ repeat.item }}"
                                    - service: tts.speak
                                      data:
                                        entity_id: "{{ tts_engine }}"
                                        media_player_entity_id: "{{ repeat.item }}"
                                        message: "{{ weather_message_base }}"
                    
                    default:
                      - repeat:
                          for_each: "{{ media_player }}"
                          sequence:
                            - service: media_player.volume_set
                              data:
                                volume_level: "{{ tts_volume }}"
                              target:
                                entity_id: "{{ repeat.item }}"
                            - service: tts.speak
                              data:
                                entity_id: "{{ tts_engine }}"
                                media_player_entity_id: "{{ repeat.item }}"
                                message: "{{ weather_message_base }}"