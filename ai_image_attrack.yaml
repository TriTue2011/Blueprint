blueprint:
  name: Voice - AI Image Generator with Reference Image (Enhanced, Auto-Infer Size/Age)
  author: luuquangvu
  description: |
    Tool for generating images using AI based on a reference image and text descriptions.
    This enhanced version will ask the AI to infer age group, clothing size, and accessory scale
    when those inputs are left empty.
  domain: script
  homeassistant:
    min_version: 2025.8.0
  input:
    ai_task_settings:
      name: Settings for AI Task
      icon: mdi:robot-outline
      description: |
        These settings allow you to set up the AI Task responsible for handling the image
        generation task.
      collapsed: true
      input:
        ai_task_entity:
          name: AI Task Entity
          description: |
            If left empty, the system will use the default settings under System - General.
            Make sure to select an AI Task that supports image generation with reference images.
          selector:
            entity:
              filter:
                - domain:
                    - ai_task
              multiple: false
              reorder: false
          default:
    output_settings:
      name: Settings for Image Output
      icon: mdi:folder-image
      description: |
        Configure where generated images should be stored and how filenames are generated.
      collapsed: true
      input:
        output_directory:
          name: Output Directory
          description: |
            Absolute path where the generated image will be stored (default is /media).
          selector:
            text:
              multiple: false
              multiline: false
          default: /media
        filename_prefix:
          name: Filename Prefix
          description: |
            Prefix used when generating the image filename.
          selector:
            text:
              multiple: false
              multiline: false
          default: ai_generated_ref_
        file_extension:
          name: File Extension
          description: |
            File extension to use for the generated image (for example jpg or png).
          selector:
            text:
              multiple: false
              multiline: false
          default: png
    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: |
        You can use these settings to finetune the prompts for your specific LLM (model).
        In most cases the defaults should be fine.
      collapsed: true
      input:
        instructions_prompt:
          name: Instructions Prompt
          description: |
            The prompt used for the LLM to describe the image generation request with
            additional styling or context. Must include age and size requirements when relevant,
            or leave empty to let the AI infer them from the reference image.
          selector:
            text:
              multiline: true
              multiple: false
          default: |
            This argument is mandatory and must always be provided.

            Describe what changes or enhancements you want to apply to the reference
            image. You can specify new backgrounds, clothing, accessories, lighting, artistic styles,
            and optionally age and size requirements.

            Examples:
            - "Change the background to a luxury office, person wearing designer glasses, age: adult, clothing size: M"
            - "Transform to professional headshot with studio lighting"
            - "Place person in a beach setting with sunset lighting, make outfit casual"

            Note: The face, facial features, smile, skin tone, and hair from the reference
            image will ALWAYS be preserved exactly unless preservation mode requests otherwise.
        media_path_prompt:
          name: Media Path Prompt
          description: |
            The prompt which will be used for the LLM to provide the reference image path.
          selector:
            text:
              multiline: true
              multiple: false
          default: |
            This argument is mandatory and must always be provided.

            Always provide a media path that starts with `local/` (for example `local/photos/person.jpg`
            or `local/images/face.png`).

            This should be the path to the reference image whose face and identity
            will be preserved.
        mime_type_prompt:
          name: MIME Type Prompt
          description: |
            The prompt which will be used for the LLM to provide the MIME type of the reference image.
          selector:
            text:
              multiline: true
              multiple: false
          default: |
            This argument is mandatory and must always be provided.

            Always specify the MIME type of the reference image. Typically this should be image/jpeg or image/png.
        task_name_prompt:
          name: Task Name Prompt
          description: |
            The prompt for the LLM to provide a short and descriptive task name for the image generation.
          selector:
            text:
              multiline: true
              multiple: false
          default: |
            This argument is optional.

            Provide a short, natural, and descriptive task name for the image generation request.

            The name should reflect what you're generating (for example "Professional Portrait with Glasses",
            "Beach Sunset Portrait", "Formal Office Setting").

            If not provided, the name will be auto-generated based on the instructions.
        preservation_mode_prompt:
          name: Preservation Mode Prompt
          description: |
            The prompt for selecting what elements to preserve from the reference image.
          selector:
            text:
              multiline: true
              multiple: false
          default: |
            This argument is optional.

            Specify what you want to preserve from the reference image:

            - "face" (default): Preserve face, facial features, skin tone, hair
            - "product": Preserve product shape, color, texture, brand details
            - "accessory": Preserve accessories like bags, glasses, jewelry with original colors and design
            - "clothing": Preserve clothing items with fabric texture, color, pattern
            - "all": Preserve everything from reference image

            If not specified, defaults to "face" mode.
    age_and_size_settings:
      name: Age & Size settings
      icon: mdi:account-child
      description: |
        Cấu hình độ tuổi và kích thước quần áo / phụ kiện phù hợp.
        Nếu bỏ trống bất kỳ trường nào, AI sẽ tự suy đoán dựa trên ảnh tham khảo và mô tả.
      collapsed: true
      input:
        age_group:
          name: Age group (Nhóm tuổi)
          description: |
            Chọn nhóm tuổi mà hình ảnh, trang phục và phụ kiện phải phù hợp.
            Nếu để trống, AI sẽ tự suy đoán từ ảnh tham khảo.
          selector:
            select:
              options:
                - label: Child (0-12)
                  value: child
                - label: Teen (13-17)
                  value: teen
                - label: Young Adult (18-30)
                  value: young_adult
                - label: Adult (31-59)
                  value: adult
                - label: Senior (60+)
                  value: senior
          default: ""
        clothing_size:
          name: Clothing size (Kích thước trang phục)
          description: |
            Kích thước trang phục mong muốn (ví dụ: XS, S, M, L, XL hoặc số).
            Nếu để trống, AI sẽ suy luận kích thước phù hợp theo ảnh tham khảo và nhóm tuổi.
          selector:
            text:
              multiple: false
              multiline: false
          default: ""
        accessory_scale:
          name: Accessory scale (Tỉ lệ phụ kiện)
          description: |
            Kích thước/tỉ lệ phụ kiện so với người (ví dụ: proportional, oversized, petite).
            Nếu để trống, AI sẽ suy luận tỉ lệ phù hợp.
          selector:
            select:
              options:
                - label: Proportional
                  value: proportional
                - label: Petite
                  value: petite
                - label: Oversized
                  value: oversized
          default: ""
  source_url: https://github.com/luuquangvu/tutorials/blob/main/ai_image_generator_with_reference.yaml
mode: parallel
max: 10
max_exceeded: silent
variables:
  version: 20251113
fields:
  instructions:
    name: Instructions
    description: !input instructions_prompt
    selector:
      text:
        multiline: true
    required: true
  media_path:
    name: Reference Image Path
    description: !input media_path_prompt
    selector:
      text:
    required: true
  mime_type:
    name: MIME Type
    description: !input mime_type_prompt
    selector:
      text:
    required: true
  task_name:
    name: Task Name
    description: !input task_name_prompt
    selector:
      text:
    required: false
  preservation_mode:
    name: Preservation Mode
    description: !input preservation_mode_prompt
    selector:
      select:
        options:
          - label: Face (Default)
            value: face
          - label: Product
            value: product
          - label: Accessory
            value: accessory
          - label: Clothing
            value: clothing
          - label: All Elements
            value: all
    required: false
  age_group:
    name: Age Group
    description: |
      Chọn nhóm tuổi mà hình ảnh/ trang phục/ phụ kiện phải phù hợp
      (child, teen, young_adult, adult, senior). Để trống để AI tự suy đoán.
    selector:
      select:
        options:
          - label: Child (0-12)
            value: child
          - label: Teen (13-17)
            value: teen
          - label: Young Adult (18-30)
            value: young_adult
          - label: Adult (31-59)
            value: adult
          - label: Senior (60+)
            value: senior
    required: false
  clothing_size:
    name: Clothing Size
    description: |
      Kích thước trang phục mong muốn (XS, S, M, L, XL hoặc số).
      Để trống nếu muốn AI tự suy luận theo ảnh tham khảo.
    selector:
      text:
    required: false
  accessory_scale:
    name: Accessory Scale
    description: |
      Tỉ lệ/kiểu phụ kiện mong muốn: proportional, petite, oversized.
      Để trống để AI tự suy đoán.
    selector:
      select:
        options:
          - label: Proportional
            value: proportional
          - label: Petite
            value: petite
          - label: Oversized
            value: oversized
    required: false
sequence:
  - variables:
      ai_task_entity: !input ai_task_entity
      instructions_input: '{{ instructions | default("") | trim }}'
      media_path: '{{ media_path | default("") | trim }}'
      mime_type: '{{ mime_type | default("") | trim }}'
      task_name_input: '{{ task_name | default("") | trim }}'
      preservation_mode: '{{ preservation_mode | default("face") | trim }}'
      age_group: '{{ age_group | default("") | trim }}'
      clothing_size: '{{ clothing_size | default("") | trim }}'
      accessory_scale: '{{ accessory_scale | default("") | trim }}'
  - alias: Validate instructions
    if:
      - condition: template
        value_template: '{{ not instructions_input }}'
    then:
      - alias: Set variable for error message
        variables:
          response:
            error: Unable to generate image because instructions are missing or empty.
      - alias: Stop the script
        stop: Unable to generate image because instructions are missing or empty.
        response_variable: response
  - alias: Validate media path
    if:
      - condition: template
        value_template: '{{ (media_path | length == 0) or (not media_path.startswith("local/")) }}'
    then:
      - alias: Set variable for error message
        variables:
          response:
            error: Unable to generate image because reference image path is missing or invalid. Provide a path beginning with `local/`, such as `local/folder/image.jpg`.
      - alias: Stop the script
        stop: Unable to generate image because reference image path is missing or invalid.
        response_variable: response
  - alias: Validate MIME type
    if:
      - condition: template
        value_template: '{{ not mime_type.startswith("image/") }}'
    then:
      - alias: Set variable for error message
        variables:
          response:
            error: Unable to generate image because MIME type is missing or incorrect. Must be an image type (image/jpeg, image/png, etc.).
      - alias: Stop the script
        stop: Unable to generate image because MIME type is missing or incorrect.
        response_variable: response
  - variables:
      face_lock_instruction: >-
        QUAN TRỌNG TỐI CAO - LỆNH BẮT BUỘC GIỮ KHUÔN MẶT: Giữ nguyên 100% khuôn mặt,
        nét mặt, nụ cười, màu da, và mái tóc từ ảnh gốc. TUYỆT ĐỐI KHÔNG thay đổi
        bất kỳ đặc điểm, danh tính hay biểu cảm nào. CỰC KỲ QUAN TRỌNG: Mọi chi
        tiết độc nhất như sẹo, nốt ruồi, mụn, nếp nhăn, và kết cấu da PHẢI được giữ
        lại y hệt. Khuôn mặt đã được khóa hoàn toàn. face lock, identity lock, high fidelity face, do not change face, keep original face exactly, skin texture must be preserved, all marks like acne, scars, moles must be kept, facial expression locked.
      product_lock_instruction: >-
        QUAN TRỌNG TỐI CAO - LỆNH BẮT BUỘC GIỮ SẢN PHẨM: Giữ nguyên 100% hình dáng,
        kích thước, màu sắc, chất liệu, logo, nhãn hiệu, và mọi chi tiết thiết kế của sản phẩm
        từ ảnh gốc. TUYỆT ĐỐI KHÔNG thay đổi bất kỳ đặc điểm nào của sản phẩm. CỰC KỲ QUAN TRỌNG: Kết cấu bề mặt, độ bóng, họa tiết, và mọi chi tiết nhỏ PHẢI được giữ lại y hệt. product lock, keep original product, preserve product identity, maintain brand details, exact colors, exact shape, texture preserved, logo and labels must remain identical.
      accessory_lock_instruction: >-
        QUAN TRỌNG TỐI CAO - LỆNH BẮT BUỘC GIỮ PHỤ KIỆN: Giữ nguyên 100% hình dáng,
        màu sắc, chất liệu, thiết kế của TẤT CẢ phụ kiện (túi xách, kính mắt, trang sức, đồng hồ, mũ, khăn...)
        từ ảnh gốc. TUYỆT ĐỐI KHÔNG thay đổi kiểu dáng, màu sắc, logo hay chi tiết trang trí. CỰC KỲ QUAN TRỌNG: Kết cấu da, kim loại, vải, đá quý và mọi chi tiết nhỏ PHẢI được giữ lại y hệt. accessory lock, keep original accessories, preserve jewelry details, maintain bag design, glasses shape locked, exact colors and materials, texture and shine preserved, brand details kept.
      clothing_lock_instruction: >-
        QUAN TRỌNG TỐI CAO - LỆNH BẮT BUỘC GIỮ QUẦN ÁO: Giữ nguyên 100% kiểu dáng,
        màu sắc, họa tiết, chất liệu vải, đường may, logo và mọi chi tiết thiết kế của quần áo
        từ ảnh gốc. TUYỆT ĐỐI KHÔNG thay đổi phong cách, màu sắc, họa tiết hay form dáng. CỰC KỲ QUAN TRỌNG: Kết cấu vải, độ bóng, nếp gấp, nút áo, khóa kéo và mọi chi tiết nhỏ PHẢI được giữ lại y hệt. clothing lock, keep original outfit, preserve fabric texture, maintain clothing style, exact colors and patterns, brand logos kept, all design details preserved, garment structure locked.
      all_elements_instruction: >-
        QUAN TRỌNG TỐI CAO - LỆNH BẮT BUỘC GIỮ TẤT CẢ: Giữ nguyên 100% MỌI yếu tố
        từ ảnh gốc bao gồm: khuôn mặt, sản phẩm, phụ kiện, quần áo với tất cả các đặc điểm về hình dáng, màu sắc, chất liệu, chi tiết. TUYỆT ĐỐI KHÔNG thay đổi bất kỳ yếu tố nào. CỰC KỲ QUAN TRỌNG: Mọi chi tiết nhỏ nhất PHẢI được giữ lại y hệt. complete preservation, lock all elements, maintain everything exactly, preserve all details, no changes allowed to any element.
      age_suitability_instruction: >-
        QUAN TRỌNG - BỐI CẢNH VÀ TRANG PHỤC PHÙ HỢP ĐỘ TUỔI: Thiết kế trang phục, phụ kiện và bối cảnh phải phù hợp với nhóm tuổi '{{ age_group if age_group != "" else " (to be inferred by AI) " }}'.
        Nếu age_group == "child" hoặc "teen", đảm bảo phong cách, trang phục và phụ kiện TUYỆT ĐỐI thân thiện và phù hợp với tuổi (không hở hang, không trưởng thành quá mức); nếu "senior", ưu tiên kiểu trang phục chín chắn, vừa vặn, thoải mái; nếu "young_adult"/"adult", giữ phong cách phù hợp từng môi trường (chuyên nghiệp/giải trí). Context must match age: locations, props, and activities should be age-appropriate.
      size_instruction: >-
        KÍCH THƯỚC TRANG PHỤC & PHỤ KIỆN: Nếu 'clothing_size' được cung cấp ('{{ clothing_size if clothing_size != "" else " (to be inferred by AI) " }}'),
        hãy tạo trang phục đúng kích thước đó; nếu để trống, suy luận kích thước hợp lý cho người trong ảnh dựa trên tham chiếu.
        Đảm bảo phụ kiện (kính, túi, mũ, đồng hồ) tỉ lệ hợp lý theo 'accessory_scale' ('{{ accessory_scale if accessory_scale != "" else " (to be inferred by AI) " }}') và phù hợp về kích thước với người trong ảnh.
      # instruction for inference: included only when any of the three inputs is empty
      inference_instruction: >-
        {% if (age_group == "") or (clothing_size == "") or (accessory_scale == "") %}
        IMPORTANT: Some size/age inputs were left empty. Please analyze the reference image (attached) and the instructions above,
        then infer and decide the best values for the following:
        1) Age group (choose one: child, teen, young_adult, adult, senior) based on visual cues.
        2) Clothing size (a reasonable value like XS, S, M, L, XL or a numeric size) that fits the inferred body shape and age.
        3) Accessory scale (choose one: proportional, petite, oversized) appropriate for the person and the chosen clothing style.
        After inferring, proceed to generate the image using those inferred values (explicitly consider them when producing proportions, props, and scene).
        Provide the inferred values in the generation metadata or final prompt so they are applied precisely.
        {% else %}
        {% endif %}
      preservation_instruction: >-
        {% if preservation_mode == "product" %}
          {{ product_lock_instruction }}
        {% elif preservation_mode == "accessory" %}
          {{ accessory_lock_instruction }}
        {% elif preservation_mode == "clothing" %}
          {{ clothing_lock_instruction }}
        {% elif preservation_mode == "all" %}
          {{ all_elements_instruction }}
        {% else %}
          {{ face_lock_instruction }}
        {% endif %}
      quality_instruction: >-
        16K ultra-high definition, masterpiece, professional photography, photorealistic,
        high detail, sharp focus, natural lighting.
      negative_prompt: >-
        IMPORTANT NEGATIVE PROMPTS - AVOID: blurriness, low resolution, overexposure,
        underexposure, distorted faces, extra fingers, distorted hands, incorrect anatomy,
        unnatural poses, doll-like skin, plastic textures, cartoons, oversaturated colors,
        flat lighting, grain, noise, watermarks, text overlays, logos added, duplicated objects,
        cropped body parts, unrealistic shadows, floating objects, wrong colors, changed shapes,
        modified textures, altered designs, different materials, fake appearance.
      full_instructions: >-
        {{ inference_instruction }}
        {{ preservation_instruction }}
        {{ age_suitability_instruction }}
        {{ size_instruction }}
        {{ quality_instruction }}
        {{ instructions_input }}
        {{ negative_prompt }}
      auto_task_name: >-
        {% if task_name_input %}
          {{ task_name_input }}
        {% else %}
          {% set words = instructions_input.split()[:6] %}
          {{ words | join(' ') | truncate(80, True, '') }}
        {% endif %}
      attachments:
        media_content_id: 'media-source://media_source/{{ media_path }}'
        media_content_type: '{{ mime_type }}'
  - alias: Generate image using AI Task
    if:
      - condition: template
        value_template: '{{ not ai_task_entity }}'
    then:
      - action: ai_task.generate_image
        data:
          task_name: '{{ auto_task_name }}'
          instructions: '{{ full_instructions }}'
          attachments: '{{ attachments }}'
        response_variable: ai_result
    else:
      - action: ai_task.generate_image
        data:
          task_name: '{{ auto_task_name }}'
          instructions: '{{ full_instructions }}'
          attachments: '{{ attachments }}'
          entity_id: '{{ ai_task_entity }}'
        response_variable: ai_result
  - alias: Check if image generation was successful
    if:
      - condition: template
        value_template: '{{ ai_result is defined and ai_result.media_source_id is defined }}'
    then:
      - variables:
          image_path_from_media_source: >-
            {% set source_id = ai_result.media_source_id %}
            {% if source_id.startswith('media-source://ai_task/image/') %}
              {{ '/media/ai_task/image/' ~ source_id.split('/')[-1] }}
            {% else %}
              {{ source_id }}
            {% endif %}
          response:
            image_path: '{{ image_path_from_media_source }}'
            task_name: '{{ auto_task_name }}'
            instructions: '{{ full_instructions }}'
            reference_image: '{{ media_path }}'
            preservation_mode: '{{ preservation_mode }}'
            age_group: '{{ age_group if age_group != "" else "inferred_by_ai" }}'
            clothing_size: '{{ clothing_size if clothing_size != "" else "inferred_by_ai" }}'
            accessory_scale: '{{ accessory_scale if accessory_scale != "" else "inferred_by_ai" }}'
            status: 'Image generated successfully with {{ preservation_mode }} preservation'
            media_source_id: '{{ ai_result.media_source_id }}'
            url: '{{ ai_result.url | default("") }}'
            model: '{{ ai_result.model | default("") }}'
            revised_prompt: '{{ ai_result.revised_prompt | default("") }}'
    else:
      - alias: Set error response
        variables:
          response:
            error: Image generation failed. The AI Task did not return a valid image URL.
      - alias: Stop script with error
        stop: Image generation failed. The AI Task did not return a valid image URL.
        response_variable: response
  - stop: ''
    response_variable: response
