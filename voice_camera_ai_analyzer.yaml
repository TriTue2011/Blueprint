blueprint:
  name: Voice - Smart Camera AI Analyzer (Final)
  author: benbap
  description: |
    Smart AI-powered camera analysis - PRODUCTION READY
    
    Logic giống Capture Camera Snapshot blueprint:
    - Ưu tiên match EXACT friendly_name
    - Fallback sang alias match
    - Nếu không match → check ALL cameras (multi-mode)
    - Hỗ trợ từ khóa multi-camera rõ ràng
    
  domain: script
  homeassistant:
    min_version: 2025.8.0
  input:
    entity_aliases_settings:
      name: Settings for Entity Aliases
      icon: mdi:format-list-bulleted
      description: Sensor alias giống blueprint Capture Camera Snapshot
      input:
        entity_aliases:
          name: Entity Aliases
          selector:
            entity:
              filter:
              - domain:
                - sensor
                integration: template
              multiple: false
              reorder: false
    ai_task_settings:
      name: AI Task Settings
      icon: mdi:robot-outline
      collapsed: true
      input:
        ai_task_entity:
          name: AI Task Entity
          description: Leave empty to use system default AI Task
          selector:
            entity:
              filter:
              - domain:
                - ai_task
              multiple: false
              reorder: false
          default:
    prompt_settings:
      name: Prompt Settings
      icon: mdi:robot
      collapsed: true
      input:
        check_mode:
          name: Multi-Camera Check Mode
          description: 'Parallel: gửi tất cả camera cùng lúc. Sequential: kiểm tra từng camera một'
          selector:
            select:
              options:
                - label: Parallel (Fast)
                  value: parallel
                - label: Sequential (Detailed)
                  value: sequential
          default: sequential
        system_prompt:
          name: System Prompt
          selector:
            text:
              multiline: true
          default: |
            You are a Home Assistant AI analyzing live camera streams.
            
            RULES:
            1. Answer in VIETNAMESE with proper diacritics
            2. Keep responses under 100 characters
            3. Answer ONLY about what user asked
            4. Base answer ONLY on attached media
            
            USER QUESTION: "{user_question}"
            CAMERAS: {camera_list}
            
            ## Detection Targets:
            - "có người" / "có ai" → humans ONLY
            - "có mèo" → cats ONLY
            - "có chó" → dogs ONLY
            - "có xe" → vehicles ONLY
            - "thấy gì" → everything
            
            ## Single Camera Response:
            - Found: "Có [count] [target]"
            - Not found: "Không thấy [target]"
            - Error: "Lỗi: Camera tối"
            
            ## Multi Camera Response (Parallel):
            Structure:
            - overview: Brief summary
            - cameras_with_target: "Cam1: Có X | Cam2: Có Y"
            - cameras_no_target: "Cam3, Cam4"
            - cameras_error: "Cam5"
            - summary: Vietnamese sentence ≤100 chars
            
            ## Multi Camera Response (Sequential):
            "[Camera]: [Result]" per camera

mode: parallel
max_exceeded: silent
description: 'AI camera analysis: detect people, pets, vehicles in cameras'

variables:
  version: 20251207_production

fields:
  instructions:
    name: Camera Question
    description: Ask anything about cameras
    selector:
      text:
        multiline: true
    required: true

sequence:
- variables:
    entity_aliases: !input entity_aliases
    ai_task_entity: !input ai_task_entity
    system_prompt: !input system_prompt
    check_mode: !input check_mode
    user_question: '{{ instructions | default('''') | trim }}'

- if:
  - condition: template
    value_template: '{{ not user_question }}'
  then:
  - variables:
      response:
        error: Please provide a question
  - stop: Missing question
    response_variable: response

# ============================================
# GET ALL CAMERAS
# ============================================
- variables:
    all_cameras: >
      {{ states.camera | map(attribute='entity_id') | list }}
    camera_list_text: >
      {% set ns = namespace(list=[]) %}
      {% for cam in all_cameras %}
        {% set name = state_attr(cam, 'friendly_name') or cam %}
        {% set ns.list = ns.list + ['- ' ~ name ~ ' (' ~ cam ~ ')'] %}
      {% endfor %}
      {{ ns.list | join('\n') }}

# ============================================
# CAMERA MATCHING (giống Capture Camera Snapshot)
# ============================================
- variables:
    # Normalize user question để match dễ hơn
    user_question_for_matching: >
      {% set q = user_question | lower %}
      {% set q = q.replace('xem ', '').replace('kiểm tra ', '').replace('check ', '').replace('show ', '') %}
      {% set q = q.replace('camera ', '').replace('cam ', '') %}
      {% set q = q.replace(' có ai không', '').replace(' có người không', '').replace(' có gì', '').replace(' có đồ gì không', '') %}
      {% set q = q.replace(' không', '').replace(' hay không', '') %}
      {{ q | trim }}
    
    # Step 1: Try EXACT match with friendly_name
    friendly_match: >
      {% set matches = states.camera 
         | selectattr('attributes.friendly_name', '==', user_question) 
         | map(attribute='entity_id') 
         | list %}
      {{ matches[0] if matches | length > 0 else '' }}
    
    # Step 2: Try match with aliases
    alias_match: >
      {% set entities = state_attr(entity_aliases, 'entities') | default([]) %}
      {% set matches = entities 
         | selectattr('entity_id', 'match', 'camera\\.') 
         | selectattr('aliases', 'contains', user_question) 
         | map(attribute='entity_id') 
         | list %}
      {{ matches[0] if matches | length > 0 else '' }}
    
    # Step 3: Partial match IMPROVED - dùng normalized query
    partial_match: >
      {% set q_norm = user_question_for_matching %}
      {% if q_norm | length >= 3 %}
        {% set ns = namespace(found='', best_match='', best_score=0) %}
        {% for cam in all_cameras %}
          {% set fn = (state_attr(cam, 'friendly_name') or '') | lower %}
          {% set fn = fn.replace('camera ', '').replace('cam ', '') %}
          
          {# Exact match sau khi normalize #}
          {% if fn == q_norm %}
            {% set ns.found = cam %}
          
          {# Partial match với scoring #}
          {% elif q_norm in fn %}
            {% set score = (q_norm | length) * 100 / (fn | length) %}
            {% if score > ns.best_score %}
              {% set ns.best_score = score %}
              {% set ns.best_match = cam %}
            {% endif %}
          
          {# Reverse: friendly_name chứa trong query #}
          {% elif fn in q_norm and fn | length > 3 %}
            {% set score = (fn | length) * 100 / (q_norm | length) %}
            {% if score > ns.best_score %}
              {% set ns.best_score = score %}
              {% set ns.best_match = cam %}
            {% endif %}
          {% endif %}
        {% endfor %}
        
        {# Return exact match hoặc best partial match (nếu score > 50%) #}
        {{ ns.found if ns.found else (ns.best_match if ns.best_score > 50 else '') }}
      {% else %}
        {{ '' }}
      {% endif %}
    
    # Combined result
    matched_camera: >
      {% if friendly_match %}
        {{ friendly_match }}
      {% elif alias_match %}
        {{ alias_match }}
      {% elif partial_match %}
        {{ partial_match }}
      {% else %}
        {{ '' }}
      {% endif %}

# ============================================
# CHECK FOR MULTI-CAMERA KEYWORDS
# ============================================
- variables:
    # ULTIMATE FIX: Decode UTF-8 corruption trước khi check
    user_question_decoded: >
      {% set q = user_question %}
      {% if 'táº¥t' in q or 'cáº£' in q or 'cÃ¡c' in q or 'ngÆ°á»i' in q %}
        {# Text bị UTF-8 corruption, cần decode #}
        {% set q = q | replace('táº¥t', 'tất') | replace('cáº£', 'cả') %}
        {% set q = q | replace('cÃ¡c', 'các') | replace('ngÆ°á»i', 'người') %}
        {% set q = q | replace('cÃ³', 'có') | replace('khÃ´ng', 'không') %}
        {% set q = q | replace('xem', 'xem') %}
      {% endif %}
      {{ q }}
    
    # Check multi-camera keywords với decoded text
    has_multi_keyword: >
      {% set q = user_question_decoded | lower %}
      {% set found = namespace(result=false) %}
      
      {# Simple string matching sau khi decode #}
      {% if 'tất cả' in q or 'tat ca' in q %}
        {% set found.result = true %}
      {% elif 'các camera' in q or 'cac camera' in q %}
        {% set found.result = true %}
      {% elif 'camera nào' in q or 'camera nao' in q %}
        {% set found.result = true %}
      {% elif 'toàn bộ' in q or 'toan bo' in q %}
        {% set found.result = true %}
      {% elif 'những camera' in q or 'nhung camera' in q %}
        {% set found.result = true %}
      {% elif 'all camera' in q or 'check all' in q or 'which camera' in q %}
        {% set found.result = true %}
      {% endif %}
      
      {{ found.result }}

# ============================================
# DECISION LOGIC (inspired by Capture Camera Snapshot)
# ============================================
- variables:
    cameras_to_check: '{{ all_cameras }}'
    camera_count: '{{ cameras_to_check | length }}'
    
    # CORE LOGIC:
    # 1. Nếu có multi keyword → multi mode
    # 2. Nếu match được 1 camera cụ thể → single mode
    # 3. Nếu không match gì → multi mode (default safe behavior)
    use_single_camera: >
      {% if has_multi_keyword %}
        {{ false }}
      {% elif matched_camera %}
        {{ true }}
      {% else %}
        {{ false }}
      {% endif %}
    
    final_single_camera: >
      {% if matched_camera %}
        {{ matched_camera }}
      {% elif all_cameras | length > 0 %}
        {{ all_cameras[0] }}
      {% else %}
        {{ '' }}
      {% endif %}

# ============================================
# PREPARE ATTACHMENTS
# ============================================
- variables:
    single_attachment: >
      {
        "media_content_id": "media-source://camera/{{ final_single_camera }}",
        "media_content_type": "application/vnd.apple.mpegurl",
        "metadata": {
          "title": "{{ state_attr(final_single_camera, 'friendly_name') or final_single_camera }}",
          "thumbnail": "/api/camera_proxy/{{ final_single_camera }}",
          "media_class": "video"
        }
      }
    
    all_attachments: >
      {% set ns = namespace(items=[]) %}
      {% for cam in cameras_to_check %}
        {% if states(cam) is not none %}
          {% set name = state_attr(cam, 'friendly_name') or cam %}
          {% set item = {
            'media_content_id': 'media-source://camera/' ~ cam,
            'media_content_type': 'application/vnd.apple.mpegurl',
            'metadata': {
              'title': name,
              'thumbnail': '/api/camera_proxy/' ~ cam,
              'media_class': 'video'
            }
          } %}
          {% set ns.items = ns.items + [item] %}
        {% endif %}
      {% endfor %}
      {{ ns.items }}

- variables:
    final_prompt: >
      {{ system_prompt
         | replace('{camera_list}', camera_list_text)
         | replace('{user_question}', user_question) }}
    sequential_mode: '{{ check_mode == ''sequential'' and use_single_camera == false }}'

# ============================================
# EXECUTION
# ============================================
- choose:
  # MODE 1: SEQUENTIAL
  - conditions:
    - condition: template
      value_template: '{{ sequential_mode }}'
    sequence:
    - variables:
        sequential_results: []
    
    - repeat:
        for_each: '{{ cameras_to_check }}'
        sequence:
        - variables:
            current_camera: '{{ repeat.item }}'
            current_camera_name: '{{ state_attr(repeat.item, ''friendly_name'') or repeat.item }}'
            current_attachment: >
              {
                "media_content_id": "media-source://camera/{{ repeat.item }}",
                "media_content_type": "application/vnd.apple.mpegurl",
                "metadata": {
                  "title": "{{ state_attr(repeat.item, 'friendly_name') or repeat.item }}",
                  "thumbnail": "/api/camera_proxy/{{ repeat.item }}",
                  "media_class": "video"
                }
              }
            sequential_prompt: |
              You are analyzing camera: {{ current_camera_name }}
              
              User's original question: {{ user_question }}
              
              IMPORTANT: Analyze ONLY the camera {{ current_camera_name }}, not any other camera mentioned in the user's question.
              
              Target detection:
              - "có người"/"có ai" → humans ONLY
              - "có mèo" → cats ONLY
              - "có chó" → dogs ONLY
              - "có xe" → vehicles ONLY
              - "có gì"/"có đồ gì"/"thấy gì" → describe everything visible
              
              CRITICAL: Response format (NO extra text, NO questions):
              - Found target: "Có [count] [target]" or describe what you see
              - Not found: "Không có [target]" or "Không thấy gì đặc biệt"
              - Error: "Lỗi: [reason]"
              
              Vietnamese, under 100 chars, ONE LINE ONLY, NO questions about other cameras.
        
        - choose:
          - conditions:
            - condition: template
              value_template: '{{ not ai_task_entity }}'
            sequence:
            - action: ai_task.generate_data
              data:
                task_name: Sequential Camera Check
                instructions: '{{ sequential_prompt }}'
                attachments:
                  - '{{ current_attachment }}'
              response_variable: camera_result
          
          default:
          - action: ai_task.generate_data
            data:
              entity_id: '{{ ai_task_entity }}'
              task_name: Sequential Camera Check
              instructions: '{{ sequential_prompt }}'
              attachments:
                - '{{ current_attachment }}'
            response_variable: camera_result
        
        - variables:
            sequential_results: >
              {{ sequential_results + [{
                'camera': current_camera,
                'name': current_camera_name,
                'result': camera_result.data
              }] }}
    
    - variables:
        final_summary: >
          {% set ns = namespace(with_target=[], no_target=[], errors=[]) %}
          {% set q_lower = user_question | lower %}
          
          {# Detect target từ câu hỏi #}
          {% set target_keywords = {
            'nguoi': 'người', 'ai': 'người',
            'meo': 'mèo', 'mèo': 'mèo',
            'cho': 'chó', 'chó': 'chó',
            'xe': 'xe', 'oto': 'xe', 'ô tô': 'xe'
          } %}
          {% set detected_target = '' %}
          {% for key, value in target_keywords.items() %}
            {% if key in q_lower and not detected_target %}
              {% set detected_target = value %}
            {% endif %}
          {% endfor %}
          
          {# Phân loại kết quả - FIX: check cả "found:" và "có" #}
          {% for item in sequential_results %}
            {% set result = item.result | lower %}
            
            {# Check lỗi #}
            {% if 'lỗi' in result or 'error' in result or 'tối' in result or 'offline' in result %}
              {% set ns.errors = ns.errors + [item.name] %}
            
            {# Check phát hiện target - support nhiều format #}
            {% elif 'có' in result and detected_target %}
              {# Format: "Có 2 người" hoặc "Found: Có 2 người" #}
              {% if detected_target in result or 'found' in result %}
                {% set ns.with_target = ns.with_target + [item.name] %}
              {% else %}
                {% set ns.no_target = ns.no_target + [item.name] %}
              {% endif %}
            
            {# Check "found:" keyword (AI sometimes wraps response) #}
            {% elif 'found:' in result %}
              {% set ns.with_target = ns.with_target + [item.name] %}
            
            {# Mặc định: không phát hiện #}
            {% else %}
              {% set ns.no_target = ns.no_target + [item.name] %}
            {% endif %}
          {% endfor %}
          
          {# Tạo summary #}
          {% set target = detected_target if detected_target else 'mục tiêu' %}
          {% if ns.with_target | length > 0 %}
          Phát hiện {{ target }} tại: {{ ns.with_target | join(', ') }}
          {% else %}
          Không phát hiện {{ target }} ở {{ sequential_results | length }} camera
          {% endif %}
        
        ai_result:
          data:
            overview: Sequential check completed
            result: '{{ final_summary }}'
            summary: '{{ final_summary }}'
            sequential_details: '{{ sequential_results }}'
  
  # MODE 2: PARALLEL (default)
  default:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ not ai_task_entity }}'
      sequence:
      - action: ai_task.generate_data
        data:
          task_name: Camera Analysis
          instructions: '{{ final_prompt }}'
          attachments: >
            {% if use_single_camera %}
              {{ [single_attachment] }}
            {% else %}
              {{ all_attachments }}
            {% endif %}
          structure:
            overview:
              description: Brief status
              required: true
              selector:
                text: {}
            cameras_with_people:
              description: Cameras with target
              required: true
              selector:
                text: {}
            cameras_no_people:
              description: Cameras without target
              required: true
              selector:
                text: {}
            cameras_error:
              description: Cameras with errors
              required: true
              selector:
                text: {}
            summary:
              description: Vietnamese summary ≤100 chars
              required: true
              selector:
                text: {}
        response_variable: ai_result
    
    default:
    - action: ai_task.generate_data
      data:
        entity_id: '{{ ai_task_entity }}'
        task_name: Camera Analysis
        instructions: '{{ final_prompt }}'
        attachments: >
          {% if use_single_camera == true %}
            {{ [single_attachment] }}
          {% else %}
            {{ all_attachments }}
          {% endif %}
        structure:
          overview:
            description: Brief status
            required: true
            selector:
              text: {}
          cameras_with_people:
            description: Cameras with target
            required: true
            selector:
              text: {}
          cameras_no_people:
            description: Cameras without target
            required: true
            selector:
              text: {}
          cameras_error:
            description: Cameras with errors
            required: true
            selector:
              text: {}
          summary:
            description: Vietnamese summary ≤100 chars
            required: true
            selector:
              text: {}
      response_variable: ai_result

- variables:
    response:
      mode: '{{ ''sequential'' if sequential_mode == true else (''single'' if use_single_camera == true else ''parallel'') }}'
      camera_count: '{{ camera_count }}'
      debug:
        user_question_raw: '{{ user_question }}'
        user_question_decoded: '{{ user_question_decoded }}'
        user_question_for_matching: '{{ user_question_for_matching }}'
        has_multi_keyword: '{{ has_multi_keyword }}'
        matched_camera: '{{ matched_camera }}'
        check_mode: '{{ check_mode }}'
        sequential_mode: '{{ sequential_mode }}'
        use_single_camera: '{{ use_single_camera }}'
      data: '{{ ai_result.data }}'

- stop: ''
  response_variable: response
