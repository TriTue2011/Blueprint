{"createdAt":"2025-08-26T14:47:06.352Z","updatedAt":"2025-08-26T15:01:31.973Z","id":"p8SLxjRjsJMkPvVW","name":"zalo-bot","active":false,"isArchived":true,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[0,0],"id":"7fd0b653-d8ea-4c9c-a023-5c3ca1c0058b","name":"When chat message received","webhookId":"37e464be-d1a0-4011-abd1-539c54c1dbdd"},{"parameters":{"promptType":"define","text":"=Thời gian hiện tại: {{ $now }}. \nSếp Ben Bắp hỏi: \n{{ $json.rawData.body.message.text }}\n{{ $('to json').first().json.content }}\n{{ $('to json').item.json.content.title }}\n{{ $('to json').item.json.content.href }}\n{{ $json.text }}","needsFallback":true,"options":{"systemMessage":"# TRỢ LÝ AI THÔNG MINH - HƯỚNG DẪN VẬN HÀNH\n## Vai trò và quy trình xử lý\nBạn là trợ lý AI thông minh phục vụ Sếp Ben Bắp. Khi người dùng hỏi, hãy ưu tiên sử dụng các tool và làm theo quy trình sau cho mỗi yêu cầu: \n1. **PHÂN TÍCH YÊU CẦU**: Phân tích kỹ lưỡng yêu cầu người dùng\n2. **ĐÁNH GIÁ CÔNG CỤ**: Xác định công cụ phù hợp nhất\n3. **KIỂM TRA DỮ LIỆU**: Xác minh dữ liệu đầu vào đã đủ chưa\n4. **THỰC HIỆN**: Sử dụng công cụ đã chọn và xử lý kết quả\n5. **PHẢN HỒI**: Tạo phản hồi theo định dạng hướng dẫn bên dưới\n\n## Quy tắc phản hồi\n- Nêu rõ nguồn thông tin\n- Tập trung vào vấn đề chính, nội dung ngắn gọn, rõ ràng, dễ đọc\n- Thêm nhãn [AI suy luận] khi không sử dụng công cụ\n- Không trả lời các câu hỏi liên quan đến chính trị, tôn giáo, chủng tộc, khu vực, giới tính, tình dục (ngoại trừ tạo ảnh, tìm nhân viên manager)\n- Đối với các câu hỏi về nguồn gốc của AI, hãy trả lời \"Boss Ben Bắp\"\n- Kết hợp các xu hướng hiện tại, hài hước để cuộc trò chuyện thoải mái nhưng không làm sai lệch nội dung\n- Giữ giọng điệu thân thiện, vui tươi và ngắn gọn, hấp dẫn đối tượng trẻ\n- Không trả lời các thẻ url, markdown vì thiết bị của người hỏi chỉ hỗ trợ văn bản thuần túy và biểu tượng cảm xúc\n- Sau mỗi câu trả lời, hãy hỏi xem người dùng có cần thêm gì không, trừ khi họ nói rõ là họ không có yêu cầu nào khác; trong những trường hợp như vậy, đừng hỏi lại. Luôn đặt câu hỏi này ở câu cuối cùng, kết thúc bằng dấu chấm hỏi và không bao giờ thêm bất kỳ văn bản nào sau đó\n\n## Hướng dẫn xử lý theo loại yêu cầu\n### Phạt nguội giao thông\n- Nếu yêu cầu tra cứu phạt nguội, hãy sử dụng công cụ để tra cứu kết quả theo loại xe, biển số xe\n\n### Tin tức\n- Nếu hỏi về tin mới, tin tức thì hãy truy vấn ở bảng db có tên là vnnew, bao gồm các cột:\n  - title (tiêu đề của bài báo) \n  - link (địa chỉ url của bài báo) \n  - contentsnippet (nội dung tóm tắt của bài báo) \n  - isodate (thời gian, ví dụ: 2025-07-13T13:12:00.000Z)\n\n### Thời tiết\n- **Thời tiết hiện tại**: tra cứu theo vị trí → phản hồi duy nhất nhiệt độ, cảm giác, độ ẩm, gió, UV, chất lượng không khí, mô tả thời tiết hiện tại\n- **Dự báo thời tiết**: tra cứu theo vị trí → phản hồi duy nhất dự báo 3 giờ tiếp theo và 3 ngày tiếp theo\n- **Tra cứu lịch vạn niên**: âm lịch (từ dương lịch sang âm lịch) hoặc dương lịch (từ âm lịch sang dương lịch), hãy sử dụng công cụ tra cứu kết quả"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[384,512],"id":"606db4bd-603d-4c1e-8b42-c22a632f994e","name":"AI agent","retryOnFail":true,"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[176,928],"id":"dd81751a-83ef-488c-8b04-ba1ee3e97402","name":"DeepSeek","credentials":{"deepSeekApi":{"id":"nnHcWmUyC0Gmswgh","name":"DeepSeek account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[48,960],"id":"a08b4b55-6d33-44b5-8658-0f17a7b2be5f","name":"mit_bap","credentials":{"googlePalmApi":{"id":"BmSJpQbzqh1rnp4z","name":"NguyenViet"}}},{"parameters":{"endpointUrl":"http://192.168.1.220:5678/mcp/tracuu"},"type":"@n8n/n8n-nodes-langchain.mcpClientTool","typeVersion":1.1,"position":[480,960],"id":"18ba7249-8046-4470-8db2-0e87473a8962","name":"Tra_cuu"},{"parameters":{"sessionIdType":"customKey","sessionKey":"=\n{{ $('zalo_bot').item.json.body.message.chat.id }}","tableName":"n8n_zalo_histories"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[352,944],"id":"08a53def-a0c4-4dfa-b334-35808fe3f465","name":"zalo","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}}},{"parameters":{"method":"POST","url":"https://bot-api.zapps.me/bot1946930502372117579:VqbDvGiYbqdIVvbvaviLzkvKnElXjQURSQYoCPaAUQUbpcpQzVyEqtxaCYsNGnPC/setWebhook","sendBody":true,"bodyParameters":{"parameters":[{"name":"url","value":"https://n8n.vhtatn.io.vn/webhook/zalo-bot"},{"name":"secret_token","value":"mykey-AnhNhi0610"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1824,1184],"id":"74912dcd-36ca-4fc3-8308-92729a637d9c","name":"HTTP Request"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.rawData.body.event_name }}","rightValue":"=message.image.received","operator":{"type":"string","operation":"equals"},"id":"095dfe37-a092-4f15-bdb4-e91370baf458"}],"combinator":"and"},"renameOutput":true,"outputKey":"image"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"21406283-4b3f-40b9-86e2-bb5a55c7fbcf","leftValue":"={{ $json.rawData.body.event_name }}","rightValue":"=message.text.received","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-816,512],"id":"9a82882c-41dd-44c4-9543-193b7f07fae8","name":"Switch"},{"parameters":{"url":"={{ $json.rawData.body.message.photo_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-512,400],"id":"2baf146c-d9b1-4077-a8c2-5ad4cc63cb7a","name":"HTTP Request4"},{"parameters":{"method":"POST","url":"http://192.168.1.220:8000/analyze","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"prompt","value":"mô tả bức ảnh này"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-320,400],"id":"1a4036ed-ea5e-48a1-a56f-ca7724ff6360","name":"HTTP Request8"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"models/gemini-2.5-flash","mode":"list","cachedResultName":"models/gemini-2.5-flash"},"text":"Phân tích nội dung ảnh","imageUrls":"={{ $json.rawData.body.message.photo_url }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[-1248,1024],"id":"04149258-8acf-426c-b390-ee3ab4db343d","name":"Analyze image1","credentials":{"googlePalmApi":{"id":"BmSJpQbzqh1rnp4z","name":"NguyenViet"}}},{"parameters":{"method":"POST","url":"https://bot-api.zapps.me/bot1946930502372117579:VqbDvGiYbqdIVvbvaviLzkvKnElXjQURSQYoCPaAUQUbpcpQzVyEqtxaCYsNGnPC/sendMessage","sendBody":true,"bodyParameters":{"parameters":[{"name":"chat_id","value":"=4e7743fc1bb5f2ebaba4"},{"name":"text","value":"={{ $('AI agent').first().json.error }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[784,496],"id":"8da50bed-46c8-4ac6-967f-75fa8dcae874","name":"HTTP Request1"},{"parameters":{"jsCode":"// Lấy dữ liệu từ webhook\nconst webhookData = $input.item.json;\n\n// Lấy message object\nconst messageData = webhookData.body?.message || {};\n\n// Tạo object kết quả với các trường chính\nconst result = {\n  // Thông tin chung\n  event_name: webhookData.body?.event_name,\n  chatType: messageData.chat?.chat_type,\n  chatId: messageData.chat?.id,\n\n  // Thông tin tin nhắn\n  messageId: messageData.message_id,\n  text: messageData.text,\n  timestamp: messageData.date,\n\n  // Thông tin người gửi\n  fromId: messageData.from?.id,\n  fromName: messageData.from?.display_name,\n  isBot: messageData.from?.is_bot,\n\n  // Dữ liệu gốc để tham khảo\n  rawData: webhookData\n};\n\n// Trả về kết quả\nreturn {\n  json: result\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1056,512],"id":"e7190d3a-2cee-4838-bed7-effeb7381884","name":"data"},{"parameters":{"httpMethod":"POST","path":"zalo-bot","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-1312,512],"id":"1a9001b7-7fdb-4521-8e60-8ffa5dac5cdb","name":"Webhook","webhookId":"e6e02b23-5e40-4e17-957f-a0d829375049"}],"connections":{"When chat message received":{"main":[[]]},"AI agent":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"DeepSeek":{"ai_languageModel":[[{"node":"AI agent","type":"ai_languageModel","index":1}]]},"mit_bap":{"ai_languageModel":[[{"node":"AI agent","type":"ai_languageModel","index":0}]]},"Tra_cuu":{"ai_tool":[[{"node":"AI agent","type":"ai_tool","index":0}]]},"zalo":{"ai_memory":[[{"node":"AI agent","type":"ai_memory","index":0}]]},"Switch":{"main":[[{"node":"HTTP Request4","type":"main","index":0}],[{"node":"AI agent","type":"main","index":0}]]},"HTTP Request4":{"main":[[{"node":"HTTP Request8","type":"main","index":0}]]},"HTTP Request8":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"data":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"data","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"521d3ff0-02df-4f40-9799-4839c63ab1ad","triggerCount":0,"shared":[{"createdAt":"2025-08-26T14:47:06.352Z","updatedAt":"2025-08-26T14:47:06.352Z","role":"workflow:owner","workflowId":"p8SLxjRjsJMkPvVW","projectId":"Bsx4kBdHQHZGGC5J"}],"tags":[]}