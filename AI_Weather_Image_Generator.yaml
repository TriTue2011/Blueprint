blueprint:
  name: AI Weather Image vá»›i áº¢nh
  author: Enhanced by Claude - Fixed Entity Error
  description: |
    # Tá»± Ä‘á»™ng táº¡o áº£nh thá»i tiáº¿t 16:9 vá»›i áº£nh ná»n cÃ³ thá»ƒ thay Ä‘á»•i
    
    âœ¨ TÃ­nh nÄƒng nÃ¢ng cao:
    - Há»— trá»£ áº£nh ná»n tÃ¹y chá»‰nh (cÃ³ thá»ƒ thay Ä‘á»•i trong automation)
    - Prompt Ä‘Æ°á»£c tá»‘i Æ°u dá»±a trÃªn dá»¯ liá»‡u thá»i tiáº¿t thá»±c táº¿
    - Aspect ratio 16:9 chuáº©n cinematic
    - Há»— trá»£ Ä‘áº§y Ä‘á»§ sensors thá»i tiáº¿t vÃ  cháº¥t lÆ°á»£ng khÃ´ng khÃ­
    
    ðŸ”§ FIXED: Lá»—i hardcoded entity_id Ä‘Ã£ Ä‘Æ°á»£c sá»­a
    â° TRIGGER: Chá»‰ kÃ­ch hoáº¡t khi buá»•i trong ngÃ y thay Ä‘á»•i
    ðŸ“Š CÃ¡c sensor khÃ¡c chá»‰ dÃ¹ng Ä‘á»ƒ láº¥y dá»¯ liá»‡u, khÃ´ng trigger automation
    
  domain: automation
  homeassistant:
    min_version: 2024.8.0
  
  input:
    # ===== CÃ€I Äáº¶T THá»œI TIáº¾T =====
    weather_sensors:
      name: "ðŸŒ¤ï¸ Cáº£m biáº¿n thá»i tiáº¿t"
      icon: mdi:weather-partly-cloudy
      collapsed: false
      input:
        time_phase_sensor:
          name: Pha thá»i gian trong ngÃ y
          description: Sensor hiá»ƒn thá»‹ buá»•i trong ngÃ y (SÃ¡ng/Chiá»u/Tá»‘i)
          selector:
            entity:
              filter:
                - domain: [sensor]
              multiple: false
        
        weather_entity:
          name: Thá»±c thá»ƒ thá»i tiáº¿t
          description: Weather entity chÃ­nh (weather.*)
          selector:
            entity:
              filter:
                - domain: [weather]
              multiple: false
        
        temperature_sensor:
          name: Cáº£m biáº¿n nhiá»‡t Ä‘á»™ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
                  device_class: [temperature]
              multiple: false
        
        humidity_sensor:
          name: Cáº£m biáº¿n Ä‘á»™ áº©m (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
                  device_class: [humidity]
              multiple: false
        
        wind_speed_sensor:
          name: Cáº£m biáº¿n tá»‘c Ä‘á»™ giÃ³ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
              multiple: false
        
        pressure_sensor:
          name: Cáº£m biáº¿n Ã¡p suáº¥t (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
              multiple: false
    
    # ===== CHáº¤T LÆ¯á»¢NG KHÃ”NG KHÃ =====
    air_quality_sensors:
      name: "ðŸ­ Cáº£m biáº¿n cháº¥t lÆ°á»£ng khÃ´ng khÃ­"
      icon: mdi:air-filter
      collapsed: true
      input:
        aqi_sensor:
          name: AQI - Chá»‰ sá»‘ cháº¥t lÆ°á»£ng khÃ´ng khÃ­ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
                  device_class: [aqi]
              multiple: false
        
        pm25_sensor:
          name: PM2.5 (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: [sensor]
              multiple: false
    
    # ===== áº¢NH Ná»€N TÃ™Y CHá»ˆNH =====
    background_image:
      name: "ðŸ–¼ï¸ áº¢nh ná»n tÃ¹y chá»‰nh"
      icon: mdi:image
      collapsed: false
      input:
        use_background_image:
          name: Sá»­ dá»¥ng áº£nh ná»n
          description: Báº­t Ä‘á»ƒ sá»­ dá»¥ng áº£nh ná»n tÃ¹y chá»‰nh thay vÃ¬ táº¡o hoÃ n toÃ n má»›i
          default: false
          selector:
            boolean:
        
        use_preset_background:
          name: Sá»­ dá»¥ng áº£nh preset
          description: Chá»n tá»« danh sÃ¡ch áº£nh cÃ³ sáºµn hoáº·c nháº­p Ä‘Æ°á»ng dáº«n tÃ¹y chá»‰nh
          default: true
          selector:
            boolean:
        
        background_image_path:
          name: ÄÆ°á»ng dáº«n áº£nh ná»n tÃ¹y chá»‰nh
          description: |
            Nháº­p Ä‘Æ°á»ng dáº«n file áº£nh (chá»‰ dÃ¹ng khi "Sá»­ dá»¥ng áº£nh preset" táº¯t)
            
            Chá»‰ cáº§n nháº­p: local/folder/tenfile.jpg
            
            VÃ­ dá»¥:
            - local/weather/examples.png
            - local/backgrounds/countryside.jpg
            - local/my_photos/sunset.jpeg
            
            ðŸ’¡ Upload áº£nh vÃ o Media browser trÆ°á»›c khi dÃ¹ng
          default: ""
          selector:
            text:
              multiline: false
    
    # ===== CÃ€I Äáº¶T AI =====
    ai_settings:
      name: "ðŸ¤– CÃ i Ä‘áº·t AI"
      icon: mdi:robot-outline
      collapsed: false
      input:
        ai_task_entity:
          name: AI Task Entity
          description: Chá»n AI entity há»— trá»£ táº¡o áº£nh (Gemini 2.5 Flash Image recommended)
          selector:
            entity:
              domain:
              - ai_task
              multiple: false
              reorder: false
          default: []
        
        image_style:
          name: Phong cÃ¡ch áº£nh
          default: photorealistic
          selector:
            select:
              options:
                - label: áº¢nh chá»¥p chÃ¢n thá»±c (Photorealistic)
                  value: photorealistic
                - label: Phong cÃ¡ch nghá»‡ thuáº­t (Artistic)
                  value: artistic
                - label: Phong cÃ¡ch sá»‘ng Ä‘á»™ng (Vibrant)
                  value: vibrant
    
    # ===== LÆ¯U áº¢NH =====
    output_settings:
      name: "ðŸ’¾ CÃ i Ä‘áº·t lÆ°u áº£nh"
      icon: mdi:content-save
      collapsed: true
      input:
        save_image:
          name: LÆ°u áº£nh vÃ o thÆ° má»¥c
          default: true
          selector:
            boolean:
        
        output_directory:
          name: ThÆ° má»¥c Ä‘áº§u ra
          default: "/media/weather_images"
          selector:
            text:
        
        use_fixed_filename:
          name: Sá»­ dá»¥ng tÃªn file cá»‘ Ä‘á»‹nh
          description: Báº­t Ä‘á»ƒ ghi Ä‘Ã¨ file cÅ©
          default: true
          selector:
            boolean:
        
        fixed_filename:
          name: TÃªn file cá»‘ Ä‘á»‹nh
          description: TÃªn file khi dÃ¹ng cháº¿ Ä‘á»™ cá»‘ Ä‘á»‹nh
          default: "weather_current"
          selector:
            text:
        
        filename_prefix:
          name: Tiá»n tá»‘ tÃªn file
          description: Tiá»n tá»‘ khi táº¡o file má»›i
          default: "weather_"
          selector:
            text:
        
        file_extension:
          name: Pháº§n má»Ÿ rá»™ng file
          default: "png"
          selector:
            select:
              options:
                - png
                - jpg
                - jpeg
                - webp
        
        delete_ai_image:
          name: XÃ³a áº£nh AI sau khi lÆ°u
          description: Tá»± Ä‘á»™ng xÃ³a áº£nh do AI táº¡o ra sau khi copy xong
          default: true
          selector:
            boolean:

# ===== TRIGGER =====
trigger:
  - platform: state
    entity_id: !input time_phase_sensor

# ===== CONDITIONS =====
condition: []

# ===== ACTIONS =====
action:
  # Thu tháº­p dá»¯ liá»‡u thá»i tiáº¿t
  - variables:
      time_phase_sensor: !input time_phase_sensor
      time_phase: "{{ states(time_phase_sensor) }}"
      weather_entity: !input weather_entity
      weather_state: "{{ states(weather_entity) }}"
      
      # Nhiá»‡t Ä‘á»™ & Äá»™ áº©m
      temperature_sensor: !input temperature_sensor
      temperature: >-
        {% if temperature_sensor %}
          {{ states(temperature_sensor) | float(0) | round(1) }}
        {% else %}
          {{ state_attr(weather_entity, 'temperature') | float(0) | round(1) }}
        {% endif %}
      
      humidity_sensor: !input humidity_sensor
      humidity: >-
        {% if humidity_sensor %}
          {{ states(humidity_sensor) | int(0) }}
        {% else %}
          {{ state_attr(weather_entity, 'humidity') | int(0) }}
        {% endif %}
      
      # GiÃ³
      wind_speed_sensor: !input wind_speed_sensor
      wind_speed: >-
        {% if wind_speed_sensor %}
          {{ states(wind_speed_sensor) | float(0) | round(1) }}
        {% else %}
          {{ state_attr(weather_entity, 'wind_speed') | float(0) | round(1) }}
        {% endif %}
      
      # Ãp suáº¥t
      pressure_sensor: !input pressure_sensor
      pressure: >-
        {% if pressure_sensor %}
          {{ states(pressure_sensor) | float(0) | round(0) }}
        {% else %}
          {{ state_attr(weather_entity, 'pressure') | float(0) | round(0) }}
        {% endif %}
      
      # Cháº¥t lÆ°á»£ng khÃ´ng khÃ­
      aqi_sensor: !input aqi_sensor
      aqi: >-
        {% if aqi_sensor %}
          {{ states(aqi_sensor) | int(0) }}
        {% else %}
          0
        {% endif %}
      
      pm25_sensor: !input pm25_sensor
      pm25: >-
        {% if pm25_sensor %}
          {{ states(pm25_sensor) | float(0) | round(1) }}
        {% else %}
          0
        {% endif %}
  
  # PhÃ¢n tÃ­ch vÃ  tá»‘i Æ°u dá»¯ liá»‡u trÆ°á»›c khi Ä‘Æ°a vÃ o prompt
  - variables:
      # PhÃ¢n loáº¡i thá»i gian trong ngÃ y
      is_morning: "{{ 'sÃ¡ng' in time_phase.lower() or 'morning' in time_phase.lower() }}"
      is_afternoon: "{{ 'chiá»u' in time_phase.lower() or 'afternoon' in time_phase.lower() }}"
      is_evening: "{{ 'tá»‘i' in time_phase.lower() or 'evening' in time_phase.lower() }}"
      is_night: "{{ 'Ä‘Ãªm' in time_phase.lower() or 'night' in time_phase.lower() }}"
      
      # PhÃ¢n loáº¡i nhiá»‡t Ä‘á»™
      temp_desc: >-
        {% if temperature > 35 %}very hot
        {% elif temperature > 30 %}hot
        {% elif temperature > 25 %}warm
        {% elif temperature > 20 %}mild
        {% elif temperature > 15 %}cool
        {% else %}cold
        {% endif %}
      
      # PhÃ¢n loáº¡i Ä‘á»™ áº©m
      humidity_desc: >-
        {% if humidity > 80 %}very humid, misty atmosphere
        {% elif humidity < 30 %}dry, clear air
        {% else %}
        {% endif %}
      
      # PhÃ¢n loáº¡i giÃ³
      wind_desc: >-
        {% if wind_speed > 30 %}strong wind, trees swaying dramatically
        {% elif wind_speed > 15 %}moderate wind, leaves rustling
        {% elif wind_speed > 5 %}gentle breeze
        {% else %}
        {% endif %}
      
      # PhÃ¢n loáº¡i cháº¥t lÆ°á»£ng khÃ´ng khÃ­
      aqi_visibility: >-
        {% if aqi > 150 %}heavy haze, poor visibility
        {% elif aqi > 100 %}noticeable haze, reduced clarity
        {% elif aqi > 50 %}slight haze in distance
        {% else %}crystal clear visibility
        {% endif %}
      
      # Chá»n thá»i Ä‘iá»ƒm trong ngÃ y
      time_lighting: >-
        {% if is_morning %}
          Early morning golden hour, warm sunrise light from the east, long soft shadows, fresh atmosphere, dew on grass
        {% elif is_afternoon %}
          Late afternoon golden hour, warm sunlight from the west, long horizontal shadows, rich warm tones
        {% elif is_evening %}
          Evening twilight, fading sunlight, blue hour approaching, soft gradient sky from orange to deep blue
        {% elif is_night %}
          Night scene, dark sky with stars, moonlight illumination, warm house lights glowing, peaceful quiet atmosphere
        {% else %}
          Daytime natural lighting
        {% endif %}
      
      # Chá»n Ä‘iá»u kiá»‡n thá»i tiáº¿t
      weather_effects: >-
        {% set w = weather_state.lower() %}
        {% if 'rain' in w or 'mÆ°a' in w %}
          Rain falling across the scene, wet surfaces reflecting light, puddles on ground, water droplets visible
        {% elif 'cloud' in w or 'mÃ¢y' in w %}
          Cloudy sky with varied cloud formations, diffused soft lighting, atmospheric depth
        {% elif 'fog' in w or 'sÆ°Æ¡ng' in w %}
          Fog and mist reducing visibility, atmospheric haze, soft ethereal quality
        {% elif 'storm' in w or 'bÃ£o' in w %}
          Dramatic stormy atmosphere, dark clouds, strong wind effects, intense lighting
        {% elif 'clear' in w or 'náº¯ng' in w %}
          Clear sunny conditions, bright natural light, strong defined shadows, vibrant colors
        {% else %}
          Natural atmospheric conditions matching current weather
        {% endif %}
      
      # Settings
      use_background_image: !input use_background_image
      use_preset_background: !input use_preset_background
      custom_background_path: !input background_image_path
      
      # Quyáº¿t Ä‘á»‹nh dÃ¹ng preset hay custom
      background_image_path: >-
        {% if use_background_image %}
          {% if use_preset_background %}
            media-source://media_source/local/backgrounds/countryside.jpg
          {% else %}
            {% if custom_background_path %}
              {% if custom_background_path.startswith('media-source://') %}
                {{ custom_background_path }}
              {% else %}
                media-source://media_source/{{ custom_background_path }}
              {% endif %}
            {% else %}
              
            {% endif %}
          {% endif %}
        {% else %}
          
        {% endif %}
      
      # Convert media_content_id sang file path thá»±c táº¿
      background_file_path: >-
        {% if background_image_path %}
          {% if background_image_path.startswith('media-source://media_source/') %}
            /media/{{ background_image_path.replace('media-source://media_source/', '') }}
          {% else %}
            {{ background_image_path }}
          {% endif %}
        {% else %}
          
        {% endif %}
      
      # Tá»± Ä‘á»™ng nháº­n diá»‡n MIME type tá»« extension
      background_mime_type: >-
        {% if background_image_path %}
          {% set path_lower = background_image_path | lower %}
          {% if '.png' in path_lower %}
            image/png
          {% elif '.jpg' in path_lower or '.jpeg' in path_lower %}
            image/jpeg
          {% elif '.webp' in path_lower %}
            image/webp
          {% elif '.gif' in path_lower %}
            image/gif
          {% else %}
            image/jpeg
          {% endif %}
        {% else %}
          image/jpeg
        {% endif %}
      
      # Láº¥y tÃªn file tá»« media path (pháº§n sau dáº¥u / cuá»‘i cÃ¹ng)
      background_filename: >-
        {% if background_image_path %}
          {% set parts = background_image_path.split('/') %}
          {{ parts[-1] if parts else 'background.jpg' }}
        {% else %}
          background.jpg
        {% endif %}
      
      # Láº¥y folder path cho navigateIds
      background_folder_path: >-
        {% if background_image_path %}
          {% set full_path = background_image_path %}
          {% if full_path.startswith('media-source://media_source/') %}
            {% set parts = full_path.replace('media-source://media_source/', '').split('/') %}
            {% if parts | length > 1 %}
              media-source://media_source/{{ parts[:-1] | join('/') }}
            {% else %}
              media-source://media_source
            {% endif %}
          {% else %}
            media-source://media_source
          {% endif %}
        {% else %}
          media-source://media_source
        {% endif %}
      
      image_style: !input image_style
  
  # Táº¡o prompt tá»‘i Æ°u
  - variables:
      optimized_prompt: >-
        {% if use_background_image and background_image_path %}
        CRITICAL INSTRUCTION - USE PROVIDED BACKGROUND IMAGE:
        Use the provided reference image as the base canvas. This is a Vietnamese countryside scene.
        KEEP the background landscape, buildings, and composition EXACTLY as shown.
        ONLY ADD weather effects and atmospheric conditions as described below.
        DO NOT change the scene structure, buildings, or landscape elements.
        {% else %}
        Create a photorealistic 16:9 wide-angle view of a Vietnamese countryside village.
        Green rice fields, traditional houses with red tile roofs, dirt paths, banana trees.
        {% endif %}
        
        â° TIME & LIGHTING (16:9 PANORAMIC):
        {{ time_lighting }}
        
        ðŸŒ¤ï¸ WEATHER CONDITIONS (ACROSS ENTIRE 16:9 FRAME):
        Current weather: {{ weather_state }}
        {{ weather_effects }}
        {% if temp_desc %}Temperature: {{ temp_desc }} ({{ temperature }}Â°C){% endif %}
        {% if humidity_desc %}Humidity: {{ humidity_desc }}{% endif %}
        {% if wind_desc %}Wind: {{ wind_desc }}{% endif %}
        
        {% if aqi > 0 %}
        ðŸ­ AIR QUALITY (VISIBILITY ACROSS PANORAMA):
        AQI {{ aqi }}: {{ aqi_visibility }}
        {% if pm25 > 0 %}PM2.5 levels affect atmospheric clarity{% endif %}
        {% endif %}
        
        ðŸŽ¨ TECHNICAL REQUIREMENTS (16:9 CINEMATIC):
        - ASPECT RATIO: 16:9 landscape format MANDATORY (width >> height)
        - Professional DSLR quality, natural colors
        - Sharp focus across full width, appropriate depth of field
        - Proper exposure balanced across entire panoramic frame
        - HDR-style dynamic range
        {% if image_style == 'artistic' %}
        - Enhanced artistic interpretation with creative color grading
        {% elif image_style == 'vibrant' %}
        - Vibrant saturated colors, high contrast
        {% else %}
        - Photorealistic natural rendering
        {% endif %}
        
        â›” PROHIBITIONS:
        âŒ Square format (1:1)
        âŒ Portrait format (9:16)
        âŒ Text, watermarks, logos
        âŒ Modern elements (cars, phones, modern buildings)
        {% if is_night %}âŒ People visible (night scene must be empty){% endif %}
        
        ðŸŽ¯ VERIFICATION:
        âœ… 16:9 landscape (WIDER than tall)
        âœ… Weather accurately depicted
        âœ… Time-appropriate lighting
        âœ… Vietnamese countryside authentic
        
        Generate image in 16:9 LANDSCAPE format now.
      
      task_name: "Weather {{ time_phase }} - {{ weather_state }}"
  
  # Gá»i AI Ä‘á»ƒ táº¡o áº£nh - FIXED: Sá»­ dá»¥ng !input ai_task_entity thay vÃ¬ hardcoded
  - if:
      - condition: template
        value_template: "{{ use_background_image and background_image_path != '' }}"
    then:
      # TrÆ°á»ng há»£p CÃ“ áº£nh ná»n - Sá»­ dá»¥ng generate_image vá»›i attachments
      - action: ai_task.generate_image
        data:
          entity_id: !input ai_task_entity
          task_name: "{{ task_name }}"
          instructions: "{{ optimized_prompt }}"
          attachments:
            media_content_id: "{{ background_image_path }}"
            media_content_type: "{{ background_mime_type }}"
            metadata:
              title: "{{ background_filename }}"
              thumbnail: null
              media_class: image
              children_media_class: null
              navigateIds:
                - {}
                - media_content_type: app
                  media_content_id: media-source://media_source
                - media_content_type: ""
                  media_content_id: "{{ background_folder_path }}"
        response_variable: ai_result
    else:
      # TrÆ°á»ng há»£p KHÃ”NG cÃ³ áº£nh ná»n - Táº¡o áº£nh má»›i hoÃ n toÃ n
      - action: ai_task.generate_image
        data:
          entity_id: !input ai_task_entity
          task_name: "{{ task_name }}"
          instructions: "{{ optimized_prompt }}"
        response_variable: ai_result
  
  # LÆ°u áº£nh náº¿u Ä‘Æ°á»£c chá»n
  - if:
      - condition: template
        value_template: "{{ ai_result is defined and ai_result.media_source_id is defined }}"
    then:
      - variables:
          source_id: "{{ ai_result.media_source_id }}"
          image_path: >-
            {% if source_id.startswith('media-source://ai_task/image/') %}
              /media/ai_task/image/{{ source_id.split('/')[-1] }}
            {% elif source_id.startswith('media-source://') %}
              /media/{{ source_id.replace('media-source://', '').replace('//', '/') }}
            {% else %}
              {{ source_id }}
            {% endif %}
      
      - if:
          - condition: template
            value_template: !input save_image
        then:
          - variables:
              timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
              use_fixed_filename: !input use_fixed_filename
              fixed_filename: !input fixed_filename
              output_directory: !input output_directory
              filename_prefix: !input filename_prefix
              file_extension: !input file_extension
              delete_ai_image: !input delete_ai_image
              filename: >-
                {% if use_fixed_filename %}
                  {{ fixed_filename }}.{{ file_extension }}
                {% else %}
                  {{ filename_prefix }}{{ timestamp }}.{{ file_extension }}
                {% endif %}
              dest_path: "{{ output_directory }}/{{ filename }}"
          
          - action: shell_command.copy_weather_image
            data:
              source: "{{ image_path }}"
              destination: "{{ dest_path }}"
          
          # XÃ³a file AI sau khi copy xong
          - if:
              - condition: template
                value_template: "{{ delete_ai_image }}"
            then:
              - action: delete.file
                data:
                  file: "{{ image_path }}"
                continue_on_error: true

mode: single
max_exceeded: silent
