blueprint:
  name: AI Weather Image Generator (Enhanced)
  author: TriTue2011 - Optimized
  description: |
    # Tá»± Ä‘á»™ng táº¡o áº£nh thá»i tiáº¿t báº±ng AI vá»›i prompt chi tiáº¿t
    
    âœ¨ TÃ­nh nÄƒng:
    - Tá»± Ä‘á»™ng táº¡o áº£nh khi thá»i tiáº¿t hoáº·c pha thá»i gian thay Ä‘á»•i
    - Há»— trá»£ Ä‘áº§y Ä‘á»§ cáº£m biáº¿n: nhiá»‡t Ä‘á»™, Ä‘á»™ áº©m, giÃ³, cháº¥t lÆ°á»£ng khÃ´ng khÃ­
    - Prompt thÃ´ng minh mÃ´ táº£ chÃ¢n thá»±c thá»i tiáº¿t Viá»‡t Nam
    - TÃ¹y chá»n lÆ°u áº£nh linh hoáº¡t
    
  domain: automation
  homeassistant:
    min_version: 2024.8.0
  
  source_url: https://github.com/your-repo/weather-ai-generator

  input:
    weather_sensors:
      name: ðŸŒ¤ï¸ Cáº£m biáº¿n thá»i tiáº¿t
      icon: mdi:weather-partly-cloudy
      collapsed: false
      input:
        time_phase_sensor:
          name: Pha thá»i gian trong ngÃ y
          description: Sensor hiá»ƒn thá»‹ buá»•i trong ngÃ y (SÃ¡ng, Chiá»u, Tá»‘i...)
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        weather_entity:
          name: Thá»±c thá»ƒ thá»i tiáº¿t
          description: Weather entity chÃ­nh (weather.*)
          selector:
            entity:
              filter:
                - domain: weather
              multiple: false
        
        temperature_sensor:
          name: Cáº£m biáº¿n nhiá»‡t Ä‘á»™ (tÃ¹y chá»n)
          description: Äá»ƒ trá»‘ng náº¿u khÃ´ng cÃ³
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: temperature
              multiple: false
        
        humidity_sensor:
          name: Cáº£m biáº¿n Ä‘á»™ áº©m (tÃ¹y chá»n)
          description: Äá»ƒ trá»‘ng náº¿u khÃ´ng cÃ³
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: humidity
              multiple: false
        
        wind_speed_sensor:
          name: Cáº£m biáº¿n tá»‘c Ä‘á»™ giÃ³ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        wind_gust_sensor:
          name: Cáº£m biáº¿n giÃ³ giáº­t (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        wind_bearing_sensor:
          name: Cáº£m biáº¿n hÆ°á»›ng giÃ³ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        pressure_sensor:
          name: Cáº£m biáº¿n Ã¡p suáº¥t (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
    
    air_quality_sensors:
      name: ðŸ­ Cáº£m biáº¿n cháº¥t lÆ°á»£ng khÃ´ng khÃ­
      icon: mdi:air-filter
      collapsed: true
      input:
        pm25_sensor:
          name: PM2.5 (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        pm10_sensor:
          name: PM10 (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        carbon_monoxide_sensor:
          name: Carbon Monoxide - CO (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        sulfur_dioxide_sensor:
          name: Sulfur Dioxide - SOâ‚‚ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        ozone_sensor:
          name: Ozone - Oâ‚ƒ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
              multiple: false
        
        aqi_sensor:
          name: AQI - Chá»‰ sá»‘ cháº¥t lÆ°á»£ng khÃ´ng khÃ­ (tÃ¹y chá»n)
          default: ""
          selector:
            entity:
              filter:
                - domain: sensor
                  device_class: aqi
              multiple: false
    
    ai_settings:
      name: ðŸ¤– CÃ i Ä‘áº·t AI
      icon: mdi:robot-outline
      collapsed: false
      input:
        ai_task_entity:
          name: AI Task Entity
          description: Chá»n AI entity Ä‘á»ƒ táº¡o áº£nh
          selector:
            entity:
              filter:
                - domain: ai_task
              multiple: false
        
        image_style:
          name: Phong cÃ¡ch áº£nh
          description: Chá»n phong cÃ¡ch áº£nh muá»‘n táº¡o
          default: photorealistic
          selector:
            select:
              options:
                - label: áº¢nh chá»¥p chÃ¢n thá»±c (Photorealistic)
                  value: photorealistic
                - label: Phong cÃ¡ch nghá»‡ thuáº­t (Artistic)
                  value: artistic
                - label: Phong cÃ¡ch anime/váº½ tay
                  value: anime
                - label: Phong cÃ¡ch sá»‘ng Ä‘á»™ng (Vibrant)
                  value: vibrant
        
        image_resolution:
          name: Äá»™ phÃ¢n giáº£i áº£nh
          default: 1024x1024
          selector:
            select:
              options:
                - label: 1024x1024 (VuÃ´ng - Chuáº©n)
                  value: 1024x1024
                - label: 1792x1024 (Ngang - Wide)
                  value: 1792x1024
                - label: 1024x1792 (Dá»c - Portrait)
                  value: 1024x1792
    
    output_settings:
      name: ðŸ’¾ CÃ i Ä‘áº·t lÆ°u áº£nh
      icon: mdi:folder-image
      collapsed: true
      input:
        save_image:
          name: LÆ°u áº£nh vÃ o thÆ° má»¥c
          description: Báº­t Ä‘á»ƒ tá»± Ä‘á»™ng lÆ°u áº£nh vÃ o thÆ° má»¥c
          default: true
          selector:
            boolean:
        
        output_directory:
          name: ThÆ° má»¥c Ä‘áº§u ra
          description: ÄÆ°á»ng dáº«n thÆ° má»¥c lÆ°u áº£nh
          default: /media/weather
          selector:
            text:
        
        use_fixed_filename:
          name: Sá»­ dá»¥ng tÃªn file cá»‘ Ä‘á»‹nh
          description: Báº­t Ä‘á»ƒ ghi Ä‘Ã¨ file cÅ©
          default: true
          selector:
            boolean:
        
        fixed_filename:
          name: TÃªn file cá»‘ Ä‘á»‹nh
          description: TÃªn file khi dÃ¹ng cháº¿ Ä‘á»™ cá»‘ Ä‘á»‹nh
          default: weather_current
          selector:
            text:
        
        filename_prefix:
          name: Tiá»n tá»‘ tÃªn file
          description: Tiá»n tá»‘ khi táº¡o file má»›i
          default: weather_
          selector:
            text:
        
        file_extension:
          name: Äá»‹nh dáº¡ng file
          default: png
          selector:
            select:
              options:
                - png
                - jpg
                - jpeg
                - webp
    
    prompt_settings:
      name: ðŸ“ TÃ¹y chá»‰nh Prompt
      icon: mdi:text-box
      collapsed: true
      input:
        use_custom_prompt:
          name: Sá»­ dá»¥ng prompt tÃ¹y chá»‰nh
          description: Báº­t Ä‘á»ƒ dÃ¹ng prompt cá»§a báº¡n
          default: false
          selector:
            boolean:
        
        custom_prompt:
          name: Prompt tÃ¹y chá»‰nh
          description: Sá»­ dá»¥ng {weather_info} Ä‘á»ƒ chÃ¨n thÃ´ng tin thá»i tiáº¿t
          default: ""
          selector:
            text:
              multiline: true
              type: text

variables:
  time_phase_sensor: !input time_phase_sensor
  weather_entity: !input weather_entity
  temperature_sensor: !input temperature_sensor
  humidity_sensor: !input humidity_sensor
  wind_speed_sensor: !input wind_speed_sensor
  wind_gust_sensor: !input wind_gust_sensor
  wind_bearing_sensor: !input wind_bearing_sensor
  pressure_sensor: !input pressure_sensor
  pm25_sensor: !input pm25_sensor
  pm10_sensor: !input pm10_sensor
  carbon_monoxide_sensor: !input carbon_monoxide_sensor
  sulfur_dioxide_sensor: !input sulfur_dioxide_sensor
  ozone_sensor: !input ozone_sensor
  aqi_sensor: !input aqi_sensor
  ai_task_entity: !input ai_task_entity
  image_style: !input image_style
  image_resolution: !input image_resolution
  save_image: !input save_image
  output_directory: !input output_directory
  use_fixed_filename: !input use_fixed_filename
  fixed_filename: !input fixed_filename
  filename_prefix: !input filename_prefix
  file_extension: !input file_extension
  use_custom_prompt: !input use_custom_prompt
  custom_prompt: !input custom_prompt

triggers:
  - trigger: state
    entity_id: !input weather_entity
    id: weather_change
  
  - trigger: state
    entity_id: !input time_phase_sensor
    id: time_phase_change

conditions: []

actions:
  - variables:
      time_phase: "{{ states(time_phase_sensor) if time_phase_sensor and states(time_phase_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      weather_state: "{{ states(weather_entity) if weather_entity and states(weather_entity) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      temperature: "{{ states(temperature_sensor) if temperature_sensor and states(temperature_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      humidity: "{{ states(humidity_sensor) if humidity_sensor and states(humidity_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      wind_speed: "{{ states(wind_speed_sensor) if wind_speed_sensor and states(wind_speed_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      wind_gust: "{{ states(wind_gust_sensor) if wind_gust_sensor and states(wind_gust_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      wind_bearing: "{{ states(wind_bearing_sensor) if wind_bearing_sensor and states(wind_bearing_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      pressure: "{{ states(pressure_sensor) if pressure_sensor and states(pressure_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      pm25: "{{ states(pm25_sensor) if pm25_sensor and states(pm25_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      pm10: "{{ states(pm10_sensor) if pm10_sensor and states(pm10_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      carbon_monoxide: "{{ states(carbon_monoxide_sensor) if carbon_monoxide_sensor and states(carbon_monoxide_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      sulfur_dioxide: "{{ states(sulfur_dioxide_sensor) if sulfur_dioxide_sensor and states(sulfur_dioxide_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      ozone: "{{ states(ozone_sensor) if ozone_sensor and states(ozone_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"
      aqi: "{{ states(aqi_sensor) if aqi_sensor and states(aqi_sensor) not in ['unknown', 'unavailable', 'none', ''] else '' }}"

  - variables:
      weather_info: >-
        {% set parts = [] %}
        {% if time_phase %}
          {% set parts = parts + ['Thá»i gian: ' ~ time_phase] %}
        {% endif %}
        {% if weather_state %}
          {% set parts = parts + ['Thá»i tiáº¿t: ' ~ weather_state] %}
        {% endif %}
        {% if temperature %}
          {% set parts = parts + ['Nhiá»‡t Ä‘á»™: ' ~ temperature ~ 'Â°C'] %}
        {% endif %}
        {% if humidity %}
          {% set parts = parts + ['Äá»™ áº©m: ' ~ humidity ~ '%'] %}
        {% endif %}
        {% if wind_speed %}
          {% set parts = parts + ['Tá»‘c Ä‘á»™ giÃ³: ' ~ wind_speed ~ ' km/h'] %}
        {% endif %}
        {% if wind_gust %}
          {% set parts = parts + ['GiÃ³ giáº­t: ' ~ wind_gust ~ ' km/h'] %}
        {% endif %}
        {% if wind_bearing %}
          {% if wind_bearing is number or wind_bearing | regex_match('^[0-9.]+$') %}
            {# Náº¿u lÃ  sá»‘ thÃ¬ chuyá»ƒn Ä‘á»•i #}
            {% set bearing = wind_bearing | float %}
            {% if bearing >= 337.5 or bearing < 22.5 %}
              {% set direction = 'Báº¯c' %}
            {% elif bearing >= 22.5 and bearing < 67.5 %}
              {% set direction = 'ÄÃ´ng Báº¯c' %}
            {% elif bearing >= 67.5 and bearing < 112.5 %}
              {% set direction = 'ÄÃ´ng' %}
            {% elif bearing >= 112.5 and bearing < 157.5 %}
              {% set direction = 'ÄÃ´ng Nam' %}
            {% elif bearing >= 157.5 and bearing < 202.5 %}
              {% set direction = 'Nam' %}
            {% elif bearing >= 202.5 and bearing < 247.5 %}
              {% set direction = 'TÃ¢y Nam' %}
            {% elif bearing >= 247.5 and bearing < 292.5 %}
              {% set direction = 'TÃ¢y' %}
            {% else %}
              {% set direction = 'TÃ¢y Báº¯c' %}
            {% endif %}
            {% set parts = parts + ['HÆ°á»›ng giÃ³: ' ~ direction ~ ' (' ~ bearing ~ 'Â°)'] %}
          {% else %}
            {# Náº¿u lÃ  chá»¯ thÃ¬ hiá»ƒn thá»‹ luÃ´n #}
            {% set parts = parts + ['HÆ°á»›ng giÃ³: ' ~ wind_bearing] %}
          {% endif %}
        {% endif %}
        {% if aqi %}
          {% set aqi_val = aqi | float %}
          {% if aqi_val <= 50 %}
            {% set aqi_text = 'Tá»‘t' %}
          {% elif aqi_val <= 100 %}
            {% set aqi_text = 'Trung bÃ¬nh' %}
          {% elif aqi_val <= 150 %}
            {% set aqi_text = 'KÃ©m' %}
          {% elif aqi_val <= 200 %}
            {% set aqi_text = 'Xáº¥u' %}
          {% elif aqi_val <= 300 %}
            {% set aqi_text = 'Ráº¥t xáº¥u' %}
          {% else %}
            {% set aqi_text = 'Nguy háº¡i' %}
          {% endif %}
          {% set parts = parts + ['Cháº¥t lÆ°á»£ng khÃ´ng khÃ­: ' ~ aqi_text ~ ' (AQI: ' ~ aqi ~ ')'] %}
        {% endif %}
        {% if pm25 %}
          {% set parts = parts + ['PM2.5: ' ~ pm25 ~ ' Âµg/mÂ³'] %}
        {% endif %}
        {% if pm10 %}
          {% set parts = parts + ['PM10: ' ~ pm10 ~ ' Âµg/mÂ³'] %}
        {% endif %}
        {% if carbon_monoxide %}
          {% set parts = parts + ['CO: ' ~ carbon_monoxide ~ ' ppm'] %}
        {% endif %}
        {% if sulfur_dioxide %}
          {% set parts = parts + ['SOâ‚‚: ' ~ sulfur_dioxide ~ ' ppb'] %}
        {% endif %}
        {% if ozone %}
          {% set parts = parts + ['Oâ‚ƒ: ' ~ ozone ~ ' ppb'] %}
        {% endif %}
        {{ parts | join(', ') }}

  - variables:
      default_prompt: |
        Dá»® LIá»†U THá»œI TIáº¾T HIá»†N Táº I:
        {weather_info}

        YÃŠU Cáº¦U Táº O áº¢NH:
        Táº¡o má»™t bá»©c áº£nh phong cáº£nh lÃ ng quÃª Viá»‡t Nam vá»›i Ä‘á»™ chÃ¢n thá»±c cao (photorealistic), pháº£n Ã¡nh chÃ­nh xÃ¡c cÃ¡c Ä‘iá»u kiá»‡n thá»i tiáº¿t vÃ  thá»i gian trong ngÃ y dá»±a trÃªn dá»¯ liá»‡u trÃªn.

        CHI TIáº¾T Cá»¤ THá»‚:

        ðŸŒ… ÃNH SÃNG & THá»œI GIAN:
        - Dá»±a vÃ o thá»i gian trong ngÃ y Ä‘á»ƒ táº¡o Ã¡nh sÃ¡ng phÃ¹ há»£p:
          + Ráº¡ng sÃ¡ng/BÃ¬nh minh: Ãnh sÃ¡ng vÃ ng cam nháº¡t, báº§u trá»i chuyá»ƒn mÃ u, sÆ°Æ¡ng mÃ¹ nháº¹
          + Buá»•i sÃ¡ng: Ãnh sÃ¡ng tráº¯ng vÃ ng tÆ°Æ¡i sÃ¡ng, bÃ³ng dÃ i, khÃ´ng khÃ­ trong lÃ nh
          + Buá»•i trÆ°a: Ãnh sÃ¡ng chÃ³i chang, bÃ³ng ngáº¯n, nhiá»‡t Ä‘á»™ cao
          + Buá»•i chiá»u: Ãnh sÃ¡ng vÃ ng áº¥m, bÃ³ng dÃ i, khÃ´ng khÃ­ dá»‹u hÆ¡n
          + HoÃ ng hÃ´n: Ãnh sÃ¡ng vÃ ng Ä‘á», báº§u trá»i gradient Ä‘áº¹p, bÃ³ng ráº¥t dÃ i
          + Buá»•i tá»‘i/ÄÃªm: Ãnh Ä‘Ã¨n nhÃ  cá»­a, trÄƒng sao, Ã¡nh sÃ¡ng nhÃ¢n táº¡o
        - Pháº£n chiáº¿u Ã¡nh sÃ¡ng trÃªn nÆ°á»›c, lÃ¡ cÃ¢y, máº·t Ä‘áº¥t pháº£i chÃ­nh xÃ¡c
        - Äá»™ tÆ°Æ¡ng pháº£n vÃ  mÃ u sáº¯c phÃ¹ há»£p vá»›i giá» trong ngÃ y

        â˜ï¸ THá»œI TIáº¾T & KHÃ QUYá»‚N:
        - MÃ´ táº£ chÃ­nh xÃ¡c Ä‘iá»u kiá»‡n thá»i tiáº¿t (náº¯ng, mÆ°a, mÃ¢y, sÆ°Æ¡ng mÃ¹...)
        - Náº¿u cÃ³ mÆ°a: ThÃªm vÅ©ng nÆ°á»›c, bÃ¹n, ngÆ°á»i máº·c Ã¡o mÆ°a, giá»t mÆ°a rÃµ rÃ ng
        - Náº¿u cÃ³ giÃ³: CÃ¢y cá»‘i nghiÃªng, quáº§n Ã¡o phÆ¡i tung bay, gá»£n sÃ³ng trÃªn nÆ°á»›c
        - Náº¿u nhiá»‡t Ä‘á»™ cao: KhÃ´ng khÃ­ nÃ³ng bá»©c, ngÆ°á»i má»“ hÃ´i, tÃ¬m bÃ³ng mÃ¡t
        - Náº¿u nhiá»‡t Ä‘á»™ tháº¥p: NgÆ°á»i máº·c áº¥m, khÃ³i tá»« báº¿p lá»­a, sÆ°Æ¡ng mÃ¹
        - Äá»™ áº©m cao: KhÃ´ng khÃ­ áº©m, giá»t sÆ°Æ¡ng, cáº£m giÃ¡c náº·ng ná»

        ðŸŒ¾ Cáº¢NH Váº¬T & MÃ”I TRÆ¯á»œNG:
        - Ruá»™ng lÃºa: Xanh mÆ¡n má»Ÿn (mÃ¹a máº¡), vÃ ng Ã³ng (mÃ¹a gáº·t), hoáº·c khÃ´ rÃ¡o (mÃ¹a khÃ´)
        - Ao há»“: Pháº£n chiáº¿u báº§u trá»i, cÃ³ vá»‹t bÆ¡i, thuyá»n nan, cÃ¢y tre bÃªn bá»
        - ÄÆ°á»ng lÃ ng: Äáº¥t Ä‘á» hoáº·c xi mÄƒng, cÃ³ váº¿t bÃ¡nh xe, vÅ©ng nÆ°á»›c náº¿u mÆ°a
        - NhÃ  cá»­a: Kiá»ƒu nhÃ  cáº¥p 4, mÃ¡i ngÃ³i Ä‘á», tÆ°á»ng vÃ´i vÃ ng, cÃ³ chuá»“ng gÃ , vÆ°á»n rau
        - CÃ¢y cá»‘i: CÃ¢y dá»«a, chuá»‘i, tre, ná»©a, cÃ¢y Äƒn quáº£ (xoÃ i, nhÃ£n, váº£i)

        ðŸ‘¥ CON NGÆ¯á»œI & SINH HOáº T:
        - Hoáº¡t Ä‘á»™ng phÃ¹ há»£p thá»i gian: LÃ m ruá»™ng buá»•i sÃ¡ng, nghá»‰ trÆ°a, chÄƒn trÃ¢u chiá»u
        - Trang phá»¥c: Ão ba ba, nÃ³n lÃ¡, Ã¡o mÆ°a khi mÆ°a, Ã¡o dÃ y khi láº¡nh
        - NgÆ°á»i nÃ´ng dÃ¢n Ä‘ang lÃ m viá»‡c: Cáº¥y lÃºa, gáº·t lÃºa, tÃ¡t nÆ°á»›c, chÄƒn trÃ¢u
        - Tráº» em chÆ¡i Ä‘Ã¹a: Táº¯m ao, tháº£ diá»u, chÆ¡i bi, báº¯t chuá»“n chuá»“n
        - NgÆ°á»i giÃ : Ngá»“i uá»‘ng trÃ , nÃ³i chuyá»‡n, phÆ¡i náº¯ng

        ðŸ„ Äá»˜NG Váº¬T:
        - TrÃ¢u bÃ² tháº£ á»Ÿ ruá»™ng hoáº·c bá» ao
        - GÃ  vá»‹t cháº¡y nháº£y quanh sÃ¢n
        - Chim bay trÃªn trá»i hoáº·c Ä‘áº­u trÃªn cÃ nh
        - ChÃ³ mÃ¨o náº±m ngá»§ hoáº·c Ä‘i láº¡i

        ðŸ­ CHáº¤T LÆ¯á»¢NG KHÃ”NG KHÃ:
        - Náº¿u AQI tá»‘t (<50): KhÃ´ng khÃ­ trong lÃ nh, táº§m nhÃ¬n xa, mÃ u sáº¯c tÆ°Æ¡i sÃ¡ng
        - Náº¿u AQI trung bÃ¬nh (50-100): HÆ¡i má» nháº¹, mÃ u sáº¯c bÃ¬nh thÆ°á»ng
        - Náº¿u AQI kÃ©m (100-150): SÆ°Æ¡ng mÃ¹ nháº¹, táº§m nhÃ¬n giáº£m, mÃ u sáº¯c xÃ¡m hÆ¡n
        - Náº¿u AQI xáº¥u (>150): SÆ°Æ¡ng mÃ¹ Ä‘áº­m, khÃ³i bá»¥i rÃµ, cÃ³ thá»ƒ tháº¥y nhÃ  mÃ¡y xa xa, ngÆ°á»i Ä‘eo kháº©u trang

        ðŸŽ¨ Ká»¸ THUáº¬T NHIáº¾P áº¢NH:
        - Phong cÃ¡ch: Photorealistic, nhÆ° áº£nh chá»¥p báº±ng mÃ¡y DSLR chuyÃªn nghiá»‡p
        - Äá»™ phÃ¢n giáº£i: Cao, chi tiáº¿t sáº¯c nÃ©t
        - Depth of field: LÃ m má» ná»n Ä‘á»ƒ táº¡o chiá»u sÃ¢u
        - Motion blur: Má» chuyá»ƒn Ä‘á»™ng khi cÃ³ giÃ³ máº¡nh hoáº·c mÆ°a
        - Composition: Quy táº¯c tam phÃ¢n, cÃ¢n báº±ng, dáº«n máº¯t ngÆ°á»i xem
        - Texture: Chi tiáº¿t bá» máº·t rÃµ rÃ ng (lÃ¡ cÃ¢y, Ä‘áº¥t, nÆ°á»›c, gá»—, váº£i)
        - Lighting: ChÃ­nh xÃ¡c vá» phÆ°Æ¡ng hÆ°á»›ng, cÆ°á»ng Ä‘á»™, mÃ u sáº¯c
        - Color grading: Tá»± nhiÃªn, khÃ´ng quÃ¡ bÃ£o hÃ²a, phÃ¹ há»£p thá»i gian

        ðŸš« LÆ¯U Ã TRÃNH:
        - STRICTLY NO text, letters, words, signatures, logos, watermarks, or any written characters anywhere in the image
        - ABSOLUTELY NO branding, company names, or identification marks of any kind
        - KHÃ”NG cÃ³ yáº¿u tá»‘ hiá»‡n Ä‘áº¡i (Ã´ tÃ´, Ä‘iá»‡n thoáº¡i, quáº£ng cÃ¡o)
        - KHÃ”NG cÃ³ chi tiáº¿t phi thá»±c táº¿ hoáº·c ká»³ áº£o
        - KHÃ”NG lÃ m má» hoáº·c pixel hÃ³a
        - KHÃ”NG cÃ³ lá»—i giáº£i pháº«u (ngÆ°á»i, Ä‘á»™ng váº­t)
        - The image must be completely clean without any overlay text or graphics

        ðŸŽ¯ Má»¤C TIÃŠU CUá»I CÃ™NG:
        Táº¡o má»™t bá»©c áº£nh mÃ  ngÆ°á»i xem cÃ³ thá»ƒ "cáº£m nháº­n" Ä‘Æ°á»£c thá»i tiáº¿t, thá»i gian, vÃ  khÃ´ng khÃ­ cá»§a lÃ ng quÃª Viá»‡t Nam qua tá»«ng chi tiáº¿t nhá». áº¢nh pháº£i chÃ¢n thá»±c Ä‘áº¿n má»©c nhÆ° thá»ƒ Ä‘Æ°á»£c chá»¥p bá»Ÿi má»™t nhiáº¿p áº£nh gia chuyÃªn nghiá»‡p Ä‘ang Ä‘á»©ng táº¡i hiá»‡n trÆ°á»ng.

      final_prompt: >-
        {% if use_custom_prompt and custom_prompt %}
          {{ custom_prompt | replace('{weather_info}', weather_info) }}
        {% else %}
          {{ default_prompt | replace('{weather_info}', weather_info) }}
        {% endif %}

      task_name: "Weather - {{ time_phase if time_phase else 'Unknown' }} - {{ weather_state if weather_state else 'Unknown' }}"

  - action: ai_task.generate_image
    data:
      entity_id: "{{ ai_task_entity }}"
      task_name: "{{ task_name }}"
      instructions: "{{ final_prompt }}"
    response_variable: ai_result

  - if:
      - condition: template
        value_template: "{{ ai_result is defined and ai_result.media_source_id is defined }}"
    then:
      - variables:
          source_id: "{{ ai_result.media_source_id }}"
          image_path: >-
            {% if source_id.startswith('media-source://ai_task/image/') %}
              /media/ai_task/image/{{ source_id.split('/')[-1] }}
            {% elif source_id.startswith('media-source://') %}
              /media/{{ source_id.replace('media-source://', '').replace('//', '/') }}
            {% else %}
              {{ source_id }}
            {% endif %}

      - if:
          - condition: template
            value_template: "{{ save_image }}"
        then:
          - variables:
              timestamp: "{{ now().strftime('%Y%m%d_%H%M%S') }}"
              filename: >-
                {% if use_fixed_filename %}
                  {{ fixed_filename }}.{{ file_extension }}
                {% else %}
                  {{ filename_prefix }}{{ timestamp }}.{{ file_extension }}
                {% endif %}
              dest_path: "{{ output_directory }}/{{ filename }}"


          - action: shell_command.copy_weather_image
            data:
              source: "{{ image_path }}"
              destination: "{{ dest_path }}"

mode: single
max_exceeded: silent