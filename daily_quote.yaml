blueprint:
  name: AI Quote Generator - T·ª± ƒë·ªông l·∫•y danh ng√¥n
  description: >
    T·ª± ƒë·ªông l·∫•y c√¢u danh ng√¥n, ch√¢m ng√¥n, ca dao, t·ª•c ng·ªØ ng·∫´u nhi√™n t·ª´ AI v√† c·∫≠p nh·∫≠t v√†o input_text.
    
    ‚ú® T√≠nh nƒÉng:
    - L·∫•y quote theo kho·∫£ng th·ªùi gian t√πy ch·ªânh
    - ƒêa d·∫°ng ngu·ªìn: danh ng√¥n qu·ªëc t·∫ø, ca dao, t·ª•c ng·ªØ Vi·ªát Nam
    - T·ª± ƒë·ªông c·∫≠p nh·∫≠t v√†o input_text helper
    - AI ch·ªçn ng·∫´u nhi√™n, tr√°nh l·∫∑p l·∫°i
    
  domain: automation
  homeassistant:
    min_version: 2024.8.0

  input:
    basic_settings:
      name: ‚öôÔ∏è C√†i ƒë·∫∑t c∆° b·∫£n
      icon: mdi:cog
      collapsed: false
      input:
        update_interval:
          name: ‚è±Ô∏è Kho·∫£ng th·ªùi gian c·∫≠p nh·∫≠t
          description: Ch·ªçn t·∫ßn su·∫•t l·∫•y quote m·ªõi
          default: every_hour
          selector:
            select:
              options:
                - label: "M·ªói 15 ph√∫t"
                  value: "15min"
                - label: "M·ªói 20 ph√∫t"
                  value: "20min"
                - label: "M·ªói 30 ph√∫t"
                  value: "30min"
                - label: "M·ªói 1 gi·ªù"
                  value: "every_hour"
                - label: "M·ªói 2 gi·ªù"
                  value: "2hours"
                - label: "M·ªói 3 gi·ªù"
                  value: "3hours"
                - label: "M·ªói 6 gi·ªù"
                  value: "6hours"
                - label: "M·ªói 12 gi·ªù"
                  value: "12hours"
                - label: "M·ªói ng√†y (0:00 AM)"
                  value: "daily"

        target_input_text:
          name: üìù Input Text Helper
          description: Ch·ªçn input_text ƒë·ªÉ l∆∞u quote
          selector:
            entity:
              filter:
                - domain: input_text

    quote_settings:
      name: üí¨ C√†i ƒë·∫∑t Quote
      icon: mdi:format-quote-close
      collapsed: true
      input:
        quote_types:
          name: üìö Lo·∫°i quote mu·ªën l·∫•y
          description: Ch·ªçn c√°c ngu·ªìn quote
          default:
            - famous_quotes
            - vietnamese_proverbs
            - vietnamese_folk_poems
          selector:
            select:
              multiple: true
              options:
                - label: "Danh ng√¥n n·ªïi ti·∫øng th·∫ø gi·ªõi"
                  value: "famous_quotes"
                - label: "T·ª•c ng·ªØ Vi·ªát Nam"
                  value: "vietnamese_proverbs"
                - label: "Ca dao Vi·ªát Nam"
                  value: "vietnamese_folk_poems"
                - label: "Ch√¢m ng√¥n s·ªëng"
                  value: "life_wisdom"
              sort: false

        include_emoji:
          name: üòä Th√™m emoji v√†o quote
          description: B·∫≠t ƒë·ªÉ AI th√™m emoji ph√π h·ª£p v√†o quote
          default: false
          selector:
            boolean:

        allow_multiline:
          name: üìÑ Cho ph√©p xu·ªëng d√≤ng
          description: B·∫≠t n·∫øu mu·ªën quote c√≥ th·ªÉ xu·ªëng d√≤ng (v·ªõi quote d√†i)
          default: false
          selector:
            boolean:

    ai_settings:
      name: ü§ñ C√†i ƒë·∫∑t AI
      icon: mdi:robot
      collapsed: true
      input:
        ai_task_entity:
          name: üß† AI Task Entity
          description: Ch·ªçn AI entity ƒë·ªÉ t·∫°o quote
          default: ai_task.google_ai_task
          selector:
            entity:
              filter:
                - domain: ai_task

        custom_instructions:
          name: üìù H∆∞·ªõng d·∫´n t√πy ch·ªânh (t√πy ch·ªçn)
          description: Th√™m y√™u c·∫ßu ri√™ng cho AI (v√≠ d·ª• "ch·ªâ l·∫•y quote v·ªÅ thi√™n nhi√™n")
          default: ''
          selector:
            text:
              multiline: true
              type: text

    notification_settings:
      name: üîî Th√¥ng b√°o (t√πy ch·ªçn)
      icon: mdi:bell
      collapsed: true
      input:
        enable_notification:
          name: ‚úÖ B·∫≠t th√¥ng b√°o khi c√≥ quote m·ªõi
          default: false
          selector:
            boolean:

        notification_service:
          name: üì± Notification Service
          description: Ch·ªçn service th√¥ng b√°o (v√≠ d·ª• notify.mobile_app_...)
          default: ''
          selector:
            text:

mode: single
max_exceeded: silent

variables:
  update_interval: !input update_interval
  target_input_text: !input target_input_text
  quote_types: !input quote_types
  include_emoji: !input include_emoji
  allow_multiline: !input allow_multiline
  ai_task_entity: !input ai_task_entity
  custom_instructions: !input custom_instructions
  enable_notification: !input enable_notification
  notification_service: !input notification_service

trigger:
  - platform: time_pattern
    minutes: "/15"
    id: trigger_15min
  - platform: time_pattern
    minutes: "/20"
    id: trigger_20min
  - platform: time_pattern
    minutes: "/30"
    id: trigger_30min
  - platform: time_pattern
    hours: "/1"
    id: trigger_1hour
  - platform: time_pattern
    hours: "/2"
    id: trigger_2hours
  - platform: time_pattern
    hours: "/3"
    id: trigger_3hours
  - platform: time_pattern
    hours: "/6"
    id: trigger_6hours
  - platform: time_pattern
    hours: "/12"
    id: trigger_12hours
  - platform: time
    at: "00:00:00"
    id: trigger_daily

condition:
  - condition: template
    value_template: >
      {% set interval = update_interval %}
      {% set trigger_id = trigger.id %}
      {% if interval == '15min' and trigger_id == 'trigger_15min' %}
        true
      {% elif interval == '20min' and trigger_id == 'trigger_20min' %}
        true
      {% elif interval == '30min' and trigger_id == 'trigger_30min' %}
        true
      {% elif interval == 'every_hour' and trigger_id == 'trigger_1hour' %}
        true
      {% elif interval == '2hours' and trigger_id == 'trigger_2hours' %}
        true
      {% elif interval == '3hours' and trigger_id == 'trigger_3hours' %}
        true
      {% elif interval == '6hours' and trigger_id == 'trigger_6hours' %}
        true
      {% elif interval == '12hours' and trigger_id == 'trigger_12hours' %}
        true
      {% elif interval == 'daily' and trigger_id == 'trigger_daily' %}
        true
      {% else %}
        false
      {% endif %}

action:
  - variables:
      quote_sources: >
        {% set sources = [] %}
        {% if 'famous_quotes' in quote_types %}
          {% set sources = sources + ['danh ng√¥n n·ªïi ti·∫øng t·ª´ c√°c nh√¢n v·∫≠t l·ªãch s·ª≠, tri·∫øt gia, nh√† vƒÉn, nh√† khoa h·ªçc tr√™n th·∫ø gi·ªõi'] %}
        {% endif %}
        {% if 'vietnamese_proverbs' in quote_types %}
          {% set sources = sources + ['t·ª•c ng·ªØ Vi·ªát Nam'] %}
        {% endif %}
        {% if 'vietnamese_folk_poems' in quote_types %}
          {% set sources = sources + ['ca dao Vi·ªát Nam'] %}
        {% endif %}
        {% if 'life_wisdom' in quote_types %}
          {% set sources = sources + ['ch√¢m ng√¥n v·ªÅ cu·ªôc s·ªëng, suy ng·∫´m, tri·∫øt l√Ω s·ªëng'] %}
        {% endif %}
        {{ sources | join(', ') }}
      
      ai_instructions: >
        H√£y ch·ªçn ng·∫´u nhi√™n 1 c√¢u t·ª´ c√°c ngu·ªìn sau: {{ quote_sources }}.
        
        Y√äU C·∫¶U:
        - ∆Øu ti√™n ƒëa d·∫°ng qu·ªëc gia, t√°c gi·∫£, ngu·ªìn g·ªëc
        - Tr√°nh l·∫∑p l·∫°i c√°c nh√¢n v·∫≠t qu√° ph·ªï bi·∫øn (n·∫øu v·ª´a ch·ªçn Einstein l·∫ßn tr∆∞·ªõc th√¨ l·∫ßn n√†y ch·ªçn ng∆∞·ªùi kh√°c)
        - N·∫øu c√≥ t√°c gi·∫£ x√°c ƒë·ªãnh: ghi r√µ t√™n t√°c gi·∫£
        - N·∫øu kh√¥ng c√≥ t√°c gi·∫£: ghi th·ªÉ lo·∫°i (Danh ng√¥n, T·ª•c ng·ªØ, Ca dao, Ch√¢m ng√¥n)
        - Vi·∫øt ti·∫øng Vi·ªát c√≥ d·∫•u ƒë·∫ßy ƒë·ªß
        {% if not include_emoji %}
        - KH√îNG d√πng emoji
        {% else %}
        - C√≥ th·ªÉ th√™m 1-2 emoji ph√π h·ª£p
        {% endif %}
        {% if not allow_multiline %}
        - KH√îNG xu·ªëng d√≤ng, vi·∫øt tr√™n 1 d√≤ng
        {% else %}
        - C√≥ th·ªÉ xu·ªëng d√≤ng n·∫øu quote d√†i
        {% endif %}
        {% if custom_instructions %}
        
        Y√äU C·∫¶U B·ªî SUNG:
        {{ custom_instructions }}
        {% endif %}
        
        H√£y ch·ªçn quote hay, √Ω nghƒ©a, truy·ªÅn c·∫£m h·ª©ng ho·∫∑c s√¢u s·∫Øc.

  - action: ai_task.generate_data
    data:
      task_name: daily_quote_generator
      instructions: "{{ ai_instructions }}"
      structure:
        quote:
          description: C√¢u n√≥i n·ªïi ti·∫øng
          required: true
          selector:
            text: null
        author:
          description: T√°c gi·∫£ ho·∫∑c th·ªÉ lo·∫°i
          required: true
          selector:
            text: null
      entity_id: "{{ ai_task_entity }}"
    response_variable: quote_result

  - wait_template: |
      {{ quote_result is defined and quote_result.data is defined
         and quote_result.data.quote is defined and quote_result.data.author is defined }}
    timeout: "00:01:00"
    continue_on_timeout: true

  - if:
      - condition: template
        value_template: "{{ wait.completed }}"
    then:
      - variables:
          final_quote: "{{ quote_result.data.quote | trim }}"
          final_author: "{{ quote_result.data.author | trim }}"
          full_text: "{{ final_quote }} - ({{ final_author }})"

      - action: input_text.set_value
        target:
          entity_id: "{{ target_input_text }}"
        data:
          value: "{{ full_text }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ enable_notification and notification_service != '' }}"
            sequence:
              - action: "{{ notification_service }}"
                data:
                  title: "üí¨ Quote m·ªõi"
                  message: "{{ full_text }}"
    else:
      - stop: "AI Task kh√¥ng tr·∫£ k·∫øt qu·∫£ k·ªãp th·ªùi"