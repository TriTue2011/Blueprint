{"createdAt":"2025-08-03T13:06:32.238Z","updatedAt":"2025-08-28T17:07:16.962Z","id":"Ps6Wn2rH2JJ13Sb1","name":"zalo test","active":false,"isArchived":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"hass-zalo-bot","responseMode":"lastNode","options":{}},"name":"Webhook","id":"27624e56-58e5-47f1-a256-a58aec7c9a86","typeVersion":1,"position":[16,32],"type":"n8n-nodes-base.webhook","webhookId":"a0bd7c12-569b-42dc-8baa-19f74b9de7ca"},{"parameters":{"resource":"service","operation":"call","domain":"zalo_bot","service":"send_message","serviceAttributes":{"attributes":[{"name":"message","value":"={{ $json.message }}"},{"name":"thread_id","value":"={{ $('to json').item.json.rawData.threadId }}"},{"name":"account_selection","value":"=+84947762285"},{"name":"type","value":"0"}]}},"type":"n8n-nodes-base.homeAssistant","typeVersion":1,"position":[2608,-176],"id":"b4ce7346-2e1d-4513-88c4-f05ba34329de","name":"Call a service","credentials":{"homeAssistantApi":{"id":"1lV5PEu2rtjuQlDB","name":"Home Assistant account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"59d4e8fc-8cfa-44a7-93b5-52a792f7a335","leftValue":"={{ $json.msgType }}","rightValue":"=webchat","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[576,96],"id":"fda10db1-0b43-43fa-8bcf-9d24d52f13cb","name":"If text"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c6ec428a-2e31-43e8-b824-61abcf52adcf","leftValue":"={{ $json.msgType }}","rightValue":"chat.voice","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[576,272],"id":"2ff56ca9-f8ec-4789-8400-c3994435fffd","name":"If voice"},{"parameters":{"jsCode":"const items = $input.all();\nlet inputData = items[0].json;\n\n// Lấy nội dung cần xử lý\nlet msg = inputData.output;\n\n// Loại bỏ phần <think>...</think>\nmsg = msg.replace(/<think>[\\s\\S]*?<\\/think>/gi, '');\n\n// Xóa các ký tự đặc biệt: backtick và dấu sao\nmsg = msg.replace(/`/g, '').replace(/\\*/g, '');\n\n// Loại bỏ khoảng trắng thừa ở đầu và cuối\nmsg = msg.trim();\n\n// Phân tách tin nhắn dài\nconst maxLen = 3000;\nlet messages = [];\n\nfor (let i = 0; i < msg.length; i += maxLen) {\n  let part = msg.substring(i, i + maxLen);\n  messages.push({ \n    json: { \n      message: part, \n      quote: { thumb: \"\" } \n    } \n  });\n}\n\nreturn messages.length ? messages : [{ \n  json: { \n    message: \"Không có thông tin để hiển thị\", \n    quote: { thumb: \"\" } \n  } \n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2208,-352],"id":"868cd623-4d14-4f9e-a799-1435370adf02","name":"maxLen"},{"parameters":{"jsCode":"return items.map(item => {\n  const text = item.json.content.parts?.[0]?.text || '';\n  return {\n    json: {\n      content: text\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,256],"id":"1125abbf-6c49-4e80-9695-a2dabaee0e1a","name":"Code"},{"parameters":{"resource":"audio","modelId":{"__rl":true,"value":"models/gemini-2.0-flash-lite","mode":"list","cachedResultName":"models/gemini-2.0-flash-lite"},"audioUrls":"={{ $json.content.href }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[848,256],"id":"149910fd-b3fd-4e70-83aa-71e92d27ea2b","name":"stt","credentials":{"googlePalmApi":{"id":"BmSJpQbzqh1rnp4z","name":"NguyenViet"}}},{"parameters":{"sseEndpoint":"http://192.168.1.220:5678/mcp/google"},"type":"@n8n/n8n-nodes-langchain.mcpClientTool","typeVersion":1,"position":[2208,272],"id":"d4e54d9a-6a68-48d5-abf4-b73e93672b72","name":"google","disabled":true},{"parameters":{"description":"Use this tool to download files, documents","workflowId":{"__rl":true,"value":"T1gzDhDncq21FOJB","mode":"list","cachedResultName":"Download"},"workflowInputs":{"mappingMode":"defineBelow","value":{"idzalo":"{{ $('to json').item.json.rawData.threadId }}","idfile":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('idfile', `- idfile: ID of file, document`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"idfile","displayName":"idfile","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"idzalo","displayName":"idzalo","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2464,432],"id":"28ec2660-2d27-43cd-8e90-2d4104fddaf1","name":"download","disabled":true},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[1312,-656],"id":"a7db67ac-52b7-4b51-b3ce-0b76b283878c","name":"When chat message received","webhookId":"37e464be-d1a0-4011-abd1-539c54c1dbdd"},{"parameters":{"jsCode":"// Lấy dữ liệu từ webhook\nconst webhookData = $input.item.json;\n\n// Lấy chuỗi message\nconst messageString = webhookData.originalMessage || webhookData.body.message;\n\n// Parse chuỗi message thành object\nlet messageData;\ntry {\n  // Xử lý các giá trị Python không tương thích với JSON\n  let jsonCompatible = messageString\n    .replace(/'/g, '\"')          // Thay thế dấu nháy đơn bằng dấu nháy kép\n    .replace(/False/g, 'false')  // Thay thế False của Python thành false của JSON\n    .replace(/True/g, 'true')    // Thay thế True của Python thành true của JSON\n    .replace(/None/g, 'null');   // Thay thế None của Python thành null của JSON\n  \n  // Xử lý các chuỗi JSON lồng nhau đã được escape\n  jsonCompatible = jsonCompatible.replace(/\"{/g, '{').replace(/}\"/g, '}');\n  \n  // Parse chuỗi thành object\n  messageData = JSON.parse(jsonCompatible);\n} catch (error) {\n  // Nếu vẫn không parse được, thử cách khác\n  try {\n    // Đôi khi chuỗi có thể chứa các ký tự escape không hợp lệ\n    const evalString = messageString\n      .replace(/'/g, '\"')\n      .replace(/False/g, 'false')\n      .replace(/True/g, 'true')\n      .replace(/None/g, 'null');\n    \n    // Sử dụng eval một cách an toàn để parse chuỗi\n    messageData = JSON.parse(evalString);\n  } catch (err) {\n    // Nếu không parse được, trả về lỗi chi tiết\n    return {\n      json: {\n        error: \"Không thể parse dữ liệu message\",\n        originalMessage: messageString,\n        errorDetails: error.message,\n        secondAttemptError: err.message\n      }\n    };\n  }\n}\n\n// Tạo object kết quả với các trường chính\nconst result = {\n  // Thông tin chung\n  type: messageData.type,\n  isSelf: messageData.isSelf,\n  threadId: messageData.threadId,\n  accountId: messageData._accountId,\n  \n  // Thông tin tin nhắn\n  actionId: messageData.data?.actionId,\n  msgId: messageData.data?.msgId,\n  cliMsgId: messageData.data?.cliMsgId,\n  msgType: messageData.data?.msgType,\n  \n  // Thông tin người gửi/nhận\n  uidFrom: messageData.data?.uidFrom,\n  idTo: messageData.data?.idTo,\n  dName: messageData.data?.dName,\n  \n  // Nội dung tin nhắn\n  content: messageData.data?.content,\n  timestamp: messageData.data?.ts,\n  status: messageData.data?.status,\n  \n  // Thông tin trích dẫn nếu có\n  quote: messageData.data?.quote ? {\n    ownerId: messageData.data.quote.ownerId,\n    message: messageData.data.quote.msg,\n    timestamp: messageData.data.quote.ts,\n    fromName: messageData.data.quote.fromD\n  } : null,\n  \n  // Thông tin mentions nếu có\n  mentions: messageData.data?.mentions || [],\n  \n  // Dữ liệu gốc để tham khảo\n  rawData: messageData\n};\n\n// Trả về kết quả\nreturn {\n  json: result\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[304,48],"id":"d240e346-21a6-47bd-a85f-317badd79453","name":"to json"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('to json').item.json.threadId }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[1616,256],"id":"88895d8d-973b-4744-88ec-9eed9a78cd47","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}}},{"parameters":{"description":"Use this tool to create an image","workflowId":{"__rl":true,"value":"MkjYDmFAbCalYYca","mode":"list","cachedResultName":"taoanh"},"workflowInputs":{"mappingMode":"defineBelow","value":{"prompt":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('prompt', `prompt: yêu cầu tạo ảnh`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"prompt","displayName":"prompt","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2496,256],"id":"ed72c81d-714a-4e24-a3ea-592624713d21","name":"taoanh","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6af2676d-1c0b-4a31-97a1-f28ce71596a2","leftValue":"={{ $json.msgType }}","rightValue":"chat.location.new","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[576,-64],"id":"db289222-40be-4ed2-9745-fe194d8e6bc0","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"626261bb-ae79-4fac-a875-cb37dbce9f75","name":"thời tiết","value":"=thời tiết {{ $json.content.description }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[880,-96],"id":"4c266bd1-3527-468e-90cb-bbd1cbaffad3","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d35f523e-09af-4a9c-a866-d123a96f790b","leftValue":"={{ $json.msgType }}","rightValue":"chat.photo","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"bca28b7b-6b1e-490b-960d-ad4a52146fad","leftValue":"={{ $json.uidFrom }}","rightValue":"6643404425553198601","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[560,-256],"id":"bcb41d01-e033-4bb4-a233-f34843b9a03f","name":"If img1"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"models/gemini-2.5-flash","mode":"list","cachedResultName":"models/gemini-2.5-flash"},"text":"Chỉ trích xuất đúng và đầy đủ thông tin theo một trong ba nhóm sau (không thêm dữ liệu ngoài yêu cầu):\n\nThông tin phương tiện:\nLoại xe: ô tô, xe máy hoặc xe điện\nBiển số xe\n\nThông tin vé số:\nKhu vực (miền Bắc, miền Trung, miền Nam hoặc tên tỉnh/thành)\nDãy số vé\nNgày mở thưởng\nThông tin tem kiểm định:\nMã/Thông tin tem kiểm định\nNếu không có thông tin khớp với các thông tin trên thì mô tả 1-2 câu về bức ảnh","imageUrls":"={{ $json.content.href }}","options":{}},"type":"@n8n/n8n-nodes-langchain.googleGemini","typeVersion":1,"position":[976,-368],"id":"da2918f2-dc46-4c48-9ec5-051e855dea88","name":"Analyze image","credentials":{"googlePalmApi":{"id":"BmSJpQbzqh1rnp4z","name":"NguyenViet"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d35f523e-09af-4a9c-a866-d123a96f790b","leftValue":"={{ $json.msgType }}","rightValue":"share.file","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"bca28b7b-6b1e-490b-960d-ad4a52146fad","leftValue":"={{ $json.uidFrom }}","rightValue":"6643404425553198601","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[560,-416],"id":"6224aca9-7007-4d94-920d-a75daf5819a9","name":"If img"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1760,1568],"id":"9c42acfc-6061-438e-b20d-9bd63153faee","name":"Delete table or rows","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}}},{"parameters":{"sseEndpoint":"http://192.168.1.220:5678/mcp/tracuu"},"type":"@n8n/n8n-nodes-langchain.mcpClientTool","typeVersion":1,"position":[2336,256],"id":"f2921e4c-500f-49b1-b58d-9face94e562f","name":"Lookup","disabled":true},{"parameters":{"operation":"executeQuery","query":"SELECT * \nFROM vnnew\nLIMIT 10;\n","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2656,224],"id":"9f5c4af3-fa20-4af3-94ad-9e6a98e13478","name":"vnnew","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}},"disabled":true},{"parameters":{"description":"Sử dụng công cụ này Tìm ghẹ theo tỉnh, quận huyện, giá, nhân viên.","workflowId":{"__rl":true,"value":"prLlQTFWp6skvdWf","mode":"list","cachedResultName":"ghe"},"workflowInputs":{"mappingMode":"defineBelow","value":{"tinh":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('tinh', `province\nIf no information, leave it as 0`, 'string') }}","huyen":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('huyen', `district\nIf no information, leave it as 0`, 'string') }}","gia":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('gia', `price\nIf no information, leave it as 0`, 'string') }}","nhanvien":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nhanvien', `person\nIf no information, leave it as 0`, 'string') }}"},"matchingColumns":[],"schema":[{"id":"tinh","displayName":"tinh","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"huyen","displayName":"huyen","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"gia","displayName":"gia","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true},{"id":"nhanvien","displayName":"nhanvien","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2832,224],"id":"3dc8a5c2-f989-4443-9ab4-1819d1e61360","name":"masager","disabled":true},{"parameters":{"method":"POST","url":"http://192.168.1.220:8000/generate","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"prompt","value":"=tôi cần tạo 1 ảnh với yêu cầu 𝑀𝑜̣̂𝑡 𝑏𝑢̛́𝑐 𝑎̉𝑛ℎ 𝑝ℎ𝑜𝑡𝑜𝑟𝑒𝑎𝑙𝑖𝑠𝑡𝑖𝑐 𝑐ℎ𝑎̂𝑛 𝑑𝑢𝑛𝑔 𝑡𝑜𝑎̀𝑛 𝑡ℎ𝑎̂𝑛 𝑐𝑢̉𝑎 𝑚𝑜̣̂𝑡 𝑛𝑔ư𝑜̛̀𝑖 𝑝ℎ𝑢̣ 𝑛𝑢̛̃ 𝐶ℎ𝑎̂𝑢 𝐴́ 𝑡𝑟𝑒̉ 𝑡𝑢𝑜̂̉𝑖, 𝑞𝑢𝑦𝑒̂́𝑛 𝑟𝑢̃, 𝑘ℎ𝑜𝑎̉𝑛𝑔 20-22 𝑡𝑢𝑜̂̉𝑖, 𝑣𝑜̛́𝑖 𝑣𝑜̛́𝑖 𝑙𝑎̀𝑛 𝑑𝑎 𝑡𝑟𝑎̆́𝑛𝑔 ℎ𝑜̂̀𝑛𝑔 𝑚𝑖̣𝑛 𝑚𝑎̀𝑛𝑔 𝑚𝑎́𝑖 𝑡𝑜́𝑐 đ𝑒𝑛 𝑑𝑎̀𝑖. 𝐶𝑜̂ 𝑎̂́𝑦 đ𝑎𝑛𝑔 đ𝑢̛́𝑛𝑔 𝑜̛̉ 𝑚𝑜̣̂𝑡 𝑘ℎ𝑢 𝑣𝑢̛̣𝑐 𝑟𝑢̛̉𝑎 𝑥𝑒 𝑛𝑔𝑜𝑎̀𝑖 𝑡𝑟𝑜̛̀𝑖, 𝑛𝑔𝑎̂̉𝑛𝑔 đ𝑎̂̀𝑢 𝑙𝑒̂𝑛, 𝑛ℎ𝑎̆́𝑚 𝑚𝑎̆́𝑡 𝑣𝑎̀ ℎ𝑒́ 𝑚𝑜̂𝑖, 𝑡𝑎̣̂𝑛 ℎư𝑜̛̉𝑛𝑔 𝑛ℎ𝑢̛̃𝑛𝑔 𝑔𝑖𝑜̣𝑡 𝑛ư𝑜̛́𝑐 𝑚𝑎́𝑡 𝑙𝑎̣𝑛ℎ 𝑐ℎ𝑎̉𝑦 𝑡𝑢̛̀ 𝑡𝑜́𝑐 ư𝑜̛́𝑡 𝑠𝑢̃𝑛𝑔 𝑥𝑢𝑜̂́𝑛𝑔 𝑚𝑎̣̆𝑡 𝑣𝑎̀ 𝑛𝑔𝑢̛̣𝑐, 𝑡𝑎̣𝑜 ℎ𝑖ệ𝑢 𝑢̛́𝑛𝑔 𝑔𝑖𝑜̣𝑡 𝑛ư𝑜̛́𝑐 𝑙𝑎̂́𝑝 𝑙𝑎́𝑛ℎ 𝑣𝑎̀ 𝑏𝑜̣𝑡 𝑥𝑎̀ 𝑝ℎ𝑜̀𝑛𝑔 𝑏𝑎́𝑚 𝑡𝑟𝑒̂𝑛 𝑑𝑎. 𝐶𝑜̂ 𝑎̂́𝑦 𝑚𝑎̣̆𝑐 𝑚𝑜̣̂𝑡 𝑐ℎ𝑖𝑒̂́𝑐 𝑎́𝑜 𝑡ℎ𝑢𝑛 𝑡𝑟𝑎̆́𝑛𝑔 𝑐𝑜̂̉ 𝑐ℎ𝑢̛̃ 𝑉 𝑠𝑎̂𝑢 ư𝑜̛́𝑡 𝑠𝑢̃𝑛𝑔 𝑣𝑎̀ 𝑏𝑎́𝑚 𝑠𝑎́𝑡 𝑐𝑜̛ 𝑡ℎ𝑒̂̉, ℎ𝑜̛𝑖 𝑡𝑟𝑜𝑛𝑔 𝑠𝑢𝑜̂́𝑡 đ𝑒̂̉ 𝑙𝑜̣̂ đư𝑜̛̀𝑛𝑔 𝑛𝑒́𝑡 𝑐𝑜̛ 𝑡ℎ𝑒̂̉, 𝑐𝑢̀𝑛𝑔 𝑞𝑢𝑎̂̀𝑛 𝑙𝑜́𝑡 𝑏𝑖𝑘𝑖𝑛𝑖 𝑚𝑎̀𝑢 đ𝑒𝑛 𝑐𝑎̣𝑝 𝑡ℎ𝑎̂́𝑝. 𝐶𝑜̂ 𝑎̂́𝑦 đ𝑎𝑛𝑔 𝑑𝑢̀𝑛𝑔 𝑚𝑜̣̂𝑡 𝑚𝑖𝑒̂́𝑛𝑔 𝑏𝑜̣𝑡 𝑏𝑖𝑒̂̉𝑛 𝑚𝑎̀𝑢 𝑥𝑎𝑛ℎ đ𝑎̣̂𝑚 đ𝑒̂̉ 𝑙𝑎𝑢 𝑚𝑜̣̂𝑡 𝑐ℎ𝑖𝑒̂́𝑐 𝑥𝑒 𝑑𝑒𝑎𝑤𝑜𝑜 𝑚𝑎𝑡𝑖𝑧 2007 𝑚𝑎̀𝑢 đ𝑜̉ 𝑏𝑖𝑒̂̉𝑛 𝑠𝑜̂́ 64𝐴-088.72. 𝑁𝑒̂̀𝑛 𝑙𝑎̀ 𝑚𝑜̣̂𝑡 𝑏𝑢̛́𝑐 𝑡ư𝑜̛̀𝑛𝑔 𝑚𝑎̀𝑢 𝑏𝑒/𝑥𝑎́𝑚 𝑛ℎ𝑎̣𝑡 𝑘𝑒̂́𝑡 𝑐𝑎̂́𝑢 𝑡ℎ𝑜̂ 𝑣𝑎̀ 𝑝ℎ𝑎̂̀𝑛 𝑚𝑎́𝑖 𝑐ℎ𝑒 𝑘𝑖𝑚 𝑙𝑜𝑎̣𝑖 𝑚𝑎̀𝑢 𝑡𝑜̂́𝑖 𝑜̛̉ 𝑝ℎ𝑖́𝑎 𝑡𝑟𝑒̂𝑛 𝑐𝑢̀𝑛𝑔 𝑐𝑢̉𝑎 𝑘ℎ𝑢𝑛𝑔 ℎ𝑖̀𝑛ℎ, 𝑣𝑜̛́𝑖 𝑚𝑜̣̂𝑡 𝑐ℎ𝑖𝑒̂́𝑐 𝑥𝑜̂ 𝑛ℎ𝑢̛̣𝑎 𝑚𝑎̀𝑢 𝑥𝑎́𝑚 𝑣𝑎̀ 𝑚𝑜̣̂𝑡 𝑑𝑎̂𝑦 𝑡ư𝑜̛́𝑖 𝑚𝑎̀𝑢 𝑥𝑎𝑛ℎ 𝑙𝑎́ 𝑐𝑎̂𝑦 𝑐𝑢𝑜̣̂𝑛 𝑙𝑎̣𝑖 𝑡𝑟𝑒𝑜 𝑡𝑟𝑒̂𝑛 𝑡ư𝑜̛̀𝑛𝑔 𝑜̛̉ 𝑥𝑎 𝑏𝑒̂𝑛 𝑡𝑟𝑎́𝑖. 𝐴́𝑛ℎ 𝑠𝑎́𝑛𝑔 𝑡𝑢̛̣ 𝑛ℎ𝑖𝑒̂𝑛 𝑚𝑎̣𝑛ℎ 𝑚𝑒̃ 𝑡𝑢̛̀ 𝑝ℎ𝑖́𝑎 𝑠𝑎𝑢 𝑣𝑎̀ 𝑏𝑒̂𝑛 𝑝ℎ𝑎̉𝑖 𝑡𝑎̣𝑜 ℎ𝑖ệ𝑢 𝑢̛́𝑛𝑔 𝑣𝑖𝑒̂̀𝑛 𝑠𝑎́𝑛𝑔 (𝑟𝑖𝑚 𝑙𝑖𝑔ℎ𝑡) 𝑟𝑢̛̣𝑐 𝑟𝑜̛̃ 𝑞𝑢𝑎𝑛ℎ 𝑛𝑔ư𝑜̛̀𝑖 𝑐𝑜̂ 𝑎̂́𝑦, 𝑙𝑎̀𝑚 𝑛𝑜̂̉𝑖 𝑏𝑎̣̂𝑡 đư𝑜̛̀𝑛𝑔 𝑛𝑒́𝑡 𝑐𝑜̛ 𝑡ℎ𝑒̂̉ 𝑣𝑎̀ 𝑛ℎ𝑢̛̃𝑛𝑔 𝑔𝑖𝑜̣𝑡 𝑛ư𝑜̛́𝑐, đ𝑜̂̀𝑛𝑔 𝑡ℎ𝑜̛̀𝑖 𝑡𝑎̣𝑜 𝑟𝑎 𝑛ℎ𝑢̛̃𝑛𝑔 𝑝ℎ𝑎̉𝑛 𝑐ℎ𝑖𝑒̂́𝑢 𝑐ℎ𝑜́𝑖 𝑙𝑜́𝑎 𝑡𝑟𝑒̂𝑛 𝑏𝑒̂̀ 𝑚𝑎̣̆𝑡 𝑐ℎ𝑟𝑜𝑚𝑒 𝑏𝑜́𝑛𝑔 𝑏𝑎̂̉𝑦 𝑐𝑢̉𝑎 𝑥𝑒 ℎ𝑜̛𝑖, 𝑡𝑎̂́𝑡 𝑐𝑎̉ đư𝑜̛̣𝑐 𝑏𝑎𝑜 𝑝ℎ𝑢̉ 𝑡𝑟𝑜𝑛𝑔 𝑘ℎ𝑜̂𝑛𝑔 𝑘ℎ𝑖́ 𝑎̂́𝑚 𝑎́𝑝 𝑐𝑢̉𝑎 𝑔𝑖𝑜̛̀ 𝑣𝑎̀𝑛𝑔 (𝑔𝑜𝑙𝑑𝑒𝑛 ℎ𝑜𝑢𝑟). 𝑀𝑎̣̆𝑡 𝑠𝑎̀𝑛 𝑏𝑒̂ 𝑡𝑜̂𝑛𝑔 ư𝑜̛́𝑡 𝑠𝑢̃𝑛𝑔 𝑝ℎ𝑎̉𝑛 𝑐ℎ𝑖𝑒̂́𝑢 𝑎́𝑛ℎ 𝑠𝑎́𝑛𝑔 𝑣𝑜̛́𝑖 𝑛ℎ𝑖𝑒̂̀𝑢 𝑏𝑜̣𝑡 𝑥𝑎̀ 𝑝ℎ𝑜̀𝑛𝑔 𝑡𝑟𝑎̆́𝑛𝑔 𝑙𝑖 𝑡𝑖. 𝐵𝑜̂́ 𝑐𝑢̣𝑐 𝑡𝑜𝑎̀𝑛 𝑡ℎ𝑎̂𝑛, 𝑔𝑜́𝑐 𝑚𝑎́𝑦 𝑛𝑔𝑎𝑛𝑔 𝑡𝑎̂̀𝑚 𝑚𝑎̆́𝑡 ℎ𝑜𝑎̣̆𝑐 ℎ𝑜̛𝑖 𝑡ℎ𝑎̂́𝑝 ℎ𝑜̛𝑛 𝑚𝑜̣̂𝑡 𝑐ℎ𝑢́𝑡, 𝑡𝑎̣̂𝑝 𝑡𝑟𝑢𝑛𝑔 𝑣𝑎̀𝑜 𝑐ℎ𝑢̉ 𝑡ℎ𝑒̂̉ 𝑣𝑜̛́𝑖 đ𝑜̣̂ 𝑠𝑎̂𝑢 𝑡𝑟ư𝑜̛̀𝑛𝑔 𝑎̉𝑛ℎ 𝑛𝑜̂𝑛𝑔 𝑛ℎ𝑒̣, 𝑐ℎ𝑖 𝑡𝑖𝑒̂́𝑡 𝑐𝑢̛̣𝑐 𝑘ỳ 𝑠𝑎̆́𝑐 𝑛𝑒́𝑡, 𝑐ℎ𝑎̂́𝑡 𝑙ư𝑜̛̣𝑛𝑔 𝑎̉𝑛ℎ 𝑐𝑎𝑜 𝑐𝑎̂́𝑝, 𝑚𝑎̀𝑢 𝑠𝑎̆́𝑐 𝑟𝑢̛̣𝑐 𝑟𝑜̛̃, đ𝑜̣̂ 𝑡ư𝑜̛𝑛𝑔 𝑝ℎ𝑎̉𝑛 𝑚𝑎̣𝑛ℎ 𝑚𝑒̃, 𝑡𝑜̂𝑛𝑔 𝑚𝑎̀𝑢 𝑑𝑎 𝑐ℎ𝑎̂𝑛 𝑡ℎ𝑢̛̣𝑐, 𝑝ℎ𝑜𝑡𝑜𝑟𝑒𝑎𝑙𝑖𝑠𝑡𝑖𝑐, 𝑐𝑖𝑛𝑒𝑚𝑎𝑡𝑖𝑐 𝑙𝑖𝑔ℎ𝑡𝑖𝑛𝑔, 8𝑘, ℎ𝑦𝑝𝑒𝑟𝑑𝑒𝑡𝑎𝑖𝑙𝑒𝑑, 𝑝𝑟𝑜𝑓𝑒𝑠𝑠𝑖𝑜𝑛𝑎𝑙 𝑝ℎ𝑜𝑡𝑜𝑔𝑟𝑎𝑝ℎ𝑦, 𝑡𝑖̉ 𝑙ệ 9:16."}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1680,480],"id":"96363651-68cc-437b-893e-cc66fa6556e5","name":"text"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[1328,256],"id":"6cc7f298-ac7f-4503-872b-b605066a4188","name":"Google Gemini Chat Model1","credentials":{"googlePalmApi":{"id":"Iu2pwTGpG2LSxJWb","name":"Mitbap"}}},{"parameters":{"jsCode":"const items = $input.all();\nlet inputData = items[0].json;\n\n// Lấy nội dung cần xử lý\nlet msg = inputData.output;\n\n// Xóa các ký tự đặc biệt: backtick và dấu sao\nmsg = msg.replace(/`/g, '').replace(/\\*/g, '');\n\n// Phân tách tin nhắn dài\nconst maxLen = 3000;\nlet messages = [];\n\nfor (let i = 0; i < msg.length; i += maxLen) {\n  let part = msg.substring(i, i + maxLen);\n  messages.push({ json: { message: part, quote: { thumb: \"\" } } });\n}\n\nreturn messages.length ? messages : [{ json: { message: \"Không có thông tin để hiển thị\", quote: { thumb: \"\" } } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2384,-176],"id":"9ae8bd02-6d1d-4101-a1ca-f119f6e9409b","name":"maxLen1"},{"parameters":{"operation":"executeQuery","query":"SELECT * \nFROM n8n_zalo_histories\nLIMIT 10;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[2304,16],"id":"57ad63e1-4d19-4f2f-bb2c-e7e809dad41e","name":"Execute a SQL query","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}}},{"parameters":{"promptType":"define","text":"=Thời gian hiện tại: {{ $now }}. \nXếp Black hỏi: \n{{ $('to json').item.json.rawData.data.content }}\n{{ $('to json').item.json.content.title }}\n{{ $('to json').item.json.content.href }}\n","needsFallback":true,"options":{"systemMessage":"#TRỢ LÝ AI THÔNG MINH - HƯỚNG DẪN VẬN HÀNH\n##Vai trò và quy trình xử lý\nBạn là trợ lý AI thông minh phục vụ Sếp Ben Bắp. Làm theo quy trình sau cho mỗi yêu cầu: \n1. **PHÂN TÍCH YÊU CẦU**: Phân tích kỹ lưỡng yêu cầu người dùng\n3. **ĐÁNH GIÁ CÔNG CỤ**: Xác định công cụ phù hợp nhất\n4. **KIỂM TRA DỮ LIỆU**: Xác minh dữ liệu đầu vào đã đủ chưa\n5. **THỰC HIỆN**: Sử dụng công cụ đã chọn và xử lý kết quả\n6. **PHẢN HỒI**: Tạo phản hồi theo định dạng hướng dẫn bên dưới\n- Nêu rõ nguồn thông tin\n- Tập trung vào vấn đề chính, nội dung ngắn gọn, rõ ràng, dễ đọc\n- Thêm nhãn [AI suy luận] khi không sử dụng công cụ\n- Không trả lời các câu hỏi liên quan đến chính trị, tôn giáo, chủng tộc, khu vực, giới tính, Giới tính, Tình dục, Ngoại trừ tạo ảnh, tìm nhân viên masager\n- Đối với các câu hỏi về nguồn gốc của AI, hãy trả lời \"Boss Ben Bắp\"\n- Kết hợp các xu hướng hiện tại, Xu hướng, hài hước để cuộc trò chuyện thoải mái nhưng không làm sai lệch nội dung.\n- Không trả lời các thẻ url, markdown vì thiết bị của người hỏi chỉ hỗ trợ văn bản thuần túy và biểu tượng cảm xúc.\n- Nếu yêu cầu tra cứu phạt nguội, hãy sử dụng công cụ Lookup để tra cứu kết quả theo loại xe, biển số xe"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1536,-144],"id":"8ebc80c5-aa40-4ca3-9602-fea2522ac962","name":"AI agent","retryOnFail":true,"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatDeepSeek","typeVersion":1,"position":[1472,256],"id":"089dfd68-e0bf-49eb-a819-eebfa644ec18","name":"DeepSeek Chat Model1","credentials":{"deepSeekApi":{"id":"nnHcWmUyC0Gmswgh","name":"DeepSeek account"}}},{"parameters":{"endpointUrl":"http://192.168.1.220:5678/mcp/phatnguoi"},"type":"@n8n/n8n-nodes-langchain.mcpClientTool","typeVersion":1.1,"position":[1824,256],"id":"3a1c13b5-72bd-48d0-99dd-5a802c4b84dc","name":"phat_nguoi"},{"parameters":{"url":"={{ $json.content.params.hd }}","options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[880,-576],"id":"ee185148-fa1d-420e-8478-3dd6af1bab21","name":"HTTP Request3"},{"parameters":{"method":"POST","url":"http://192.168.1.220:8000/analyze","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"prompt","value":"mô tả bức ảnh này"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1056,-576],"id":"d5d1e34e-4a1c-407c-a616-710151700a19","name":"HTTP Request7"},{"parameters":{"model":{"__rl":true,"value":"gemini-2.5-pro","mode":"list","cachedResultName":"gemini-2.5-pro"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1136,112],"id":"fcc72dfe-ad78-48e7-ac74-d0acb2ab98f9","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"0vhR5RV6RzHVkgzl","name":"OpenAi account 2"}}},{"parameters":{"url":"http://192.168.1.220:8000/health","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1712,640],"id":"ed885bf8-acfa-41aa-93bb-ac9c9b97e3c9","name":"health"},{"parameters":{"operation":"executeQuery","query":"SELECT * \nFROM vnnew\nLIMIT 10;\n","options":{}},"type":"n8n-nodes-base.postgresTool","typeVersion":2.6,"position":[2016,256],"id":"5e6ae96d-9907-412c-8f88-b62e46cc89d2","name":"vnnew2","credentials":{"postgres":{"id":"vDBK6XLC0TBpoMww","name":"Postgres account"}}}],"connections":{"Webhook":{"main":[[{"node":"to json","type":"main","index":0}]]},"If text":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"If voice":{"main":[[{"node":"stt","type":"main","index":0}]]},"maxLen":{"main":[[{"node":"Call a service","type":"main","index":0}]]},"Code":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"stt":{"main":[[{"node":"Code","type":"main","index":0}]]},"google":{"ai_tool":[[]]},"download":{"ai_tool":[[]]},"When chat message received":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"to json":{"main":[[{"node":"If text","type":"main","index":0},{"node":"If","type":"main","index":0},{"node":"If img1","type":"main","index":0},{"node":"If voice","type":"main","index":0},{"node":"If img","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI agent","type":"ai_memory","index":0}]]},"taoanh":{"ai_tool":[[]]},"If":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"If img1":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"AI agent","type":"main","index":0}]]},"If img":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"Lookup":{"ai_tool":[[]]},"vnnew":{"ai_tool":[[]]},"masager":{"ai_tool":[[]]},"Google Gemini Chat Model1":{"ai_languageModel":[[{"node":"AI agent","type":"ai_languageModel","index":0}]]},"maxLen1":{"main":[[{"node":"Call a service","type":"main","index":0}]]},"AI agent":{"main":[[]]},"DeepSeek Chat Model1":{"ai_languageModel":[[{"node":"AI agent","type":"ai_languageModel","index":1}]]},"phat_nguoi":{"ai_tool":[[{"node":"AI agent","type":"ai_tool","index":0}]]},"HTTP Request3":{"main":[[{"node":"HTTP Request7","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[]]},"health":{"main":[[]]},"vnnew2":{"ai_tool":[[{"node":"AI agent","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"ef5b607a-80a5-4919-9055-0fd9e3dfaa1b","triggerCount":2,"shared":[{"createdAt":"2025-08-03T13:06:32.238Z","updatedAt":"2025-08-03T13:06:32.238Z","role":"workflow:owner","workflowId":"Ps6Wn2rH2JJ13Sb1","projectId":"Bsx4kBdHQHZGGC5J"}],"tags":[]}