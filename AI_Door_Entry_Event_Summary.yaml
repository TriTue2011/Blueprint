blueprint:
  name: AI Door Entry Event Summary with Zalo (v1.2.2)
  author: Custom
  homeassistant:
    min_version: 2024.10.0
  description: AI-powered summaries for door entry events with person detection and Zalo notification support. Analyzes camera when door opens and person is detected in the area.
  domain: automation
  source_url: https://github.com/custom/door-entry-ai-summary

  input:
    door_contact_sensor:
      name: Door Contact Sensor
      selector:
        entity:
          filter:
            - domain: binary_sensor
    door_from_state:
      name: Door From State
      default: "off"
      selector:
        select:
          options: ["off","on"]
          custom_value: true
    door_to_state:
      name: Door To State
      default: "on"
      selector:
        select:
          options: ["on","off"]
          custom_value: true

    person_occupancy_sensor:
      name: Person Occupancy Sensor
      selector:
        entity:
          filter:
            - domain: binary_sensor
    person_detected_state:
      name: Person Detected State
      default: "on"
      selector:
        select:
          options: ["on","off"]
          custom_value: true
    wait_for_person:
      name: Wait for Person Detection
      default: true
      selector:
        boolean: {}
    person_wait_time:
      name: Person Detection Wait Time
      default:
        hours: 0
        minutes: 0
        seconds: 0
      selector:
        duration: {}
    max_wait_time:
      name: Maximum Wait Time (Optional)
      description: 0 = unlimited
      default: 0
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds
          mode: box
          step: 1

    run_conditions:
      name: Run Conditions
      default: []
      selector:
        condition: {}

    cooldown:
      name: Cooldown
      default:
        minutes: 10
      selector:
        duration: {}

    camera_sensor_section:
      name: Camera & Sensor Settings
      icon: mdi:camera
      input:
        camera_entities:
          name: Camera Entities
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: camera
        duration:
          name: Duration
          default: 5
          selector:
            number:
              min: 1
              max: 60
              step: 1
        max_frames:
          name: Max Frames
          default: 3
          selector:
            number:
              min: 1
              max: 60
              step: 1

    ai_section:
      name: AI Settings
      icon: mdi:brain
      collapsed: true
      input:
        remember:
          name: Store in Timeline
          default: true
          selector:
            boolean: {}
        use_memory:
          name: Use Memory
          default: false
          selector:
            boolean: {}
        message:
          name: Prompt
          default: "Analyze the door entry event. Identify who entered (person description, clothing, items carried), their actions, and any notable details. If multiple people are present, describe each person. Focus on security-relevant information. Present the information naturally without mentioning images."
          selector:
            text:
              multiline: true
        provider:
          name: Provider
          selector:
            config_entry:
              integration: llmvision
        model:
          name: Model
          selector:
            text: {}
        target_width:
          name: Target Width
          default: 1280
          selector:
            number:
              min: 512
              max: 3840
              step: 1
        max_tokens:
          name: Maximum Tokens
          default: 5000
          selector:
            number:
              step: 1
              mode: box

    notification_section:
      name: Notification Settings
      icon: mdi:bell
      collapsed: true
      input:
        notify:
          name: Notify
          default: true
          selector:
            boolean: {}
        take_snapshot:
          name: Take Snapshot
          description: Chụp ảnh từ camera khi cửa mở để dùng cho notify/Zalo
          default: true
          selector:
            boolean: {}
        condition_notify:
          name: Condition to Notify
          default: []
          selector:
            condition: {}
        notify_device:
          name: Notify Device
          default: []
          selector:
            device:
              multiple: true
              filter:
                - integration: mobile_app
        notification_delivery:
          name: Notification Delivery
          default: Dynamic
          selector:
            select:
              options:
                - Dynamic
                - Consolidated
        preview_mode:
          name: Preview Mode
          default: Snapshot
          selector:
            select:
              options:
                - Snapshot
                - Live Preview
        analysis_mode:
          name: Analysis Mode
          default: Snapshot
          selector:
            select:
              options:
                - Snapshot
                - Live Preview
        notification_time:
          name: Notification Time
          default: ''
          selector:
            select:
              options:
                - label: No Time Added
                  value: ''
                - label: 12 Hour
                  value: "at {{ now().strftime('%-I:%M %p') }}"
                - label: 24 Hour
                  value: "at {{ now().strftime('%H:%M') }}"
        file_path:
          name: File Path
          default: /media/llmvision/snapshots/{{ camera_file_path }}/last_entry.jpg
          selector:
            select:
              options:
                - label: Media Folder - Secured
                  value: /media/llmvision/snapshots/{{ camera_file_path }}/last_entry.jpg
                - label: Public Folder - Unsecured
                  value: /config/www/snapshots/{{ camera_file_path }}/last_entry.jpg
              custom_value: true
        tap_navigate:
          name: Tap Navigate
          default: /lovelace/0
          selector:
            text: {}
        delay_notification:
          name: Notification Cooldown
          default: 60
          selector:
            number:
              min: 0
              max: 86400
              step: 1
              mode: box
        notification_sticky:
          name: Sticky - Android Only
          default: true
          selector:
            boolean: {}
        notification_color:
          name: Notification Color - Android Only
          default: "#03a9f4"
          selector:
            select:
              options:
                - label: Steelblue - #03a9f4
                  value: "#03a9f4"
                - label: Red - #f44336
                  value: "#f44336"
                - label: Orange - #ff9800
                  value: "#ff9800"
                - label: Green - #4caf50
                  value: "#4caf50"
              custom_value: true
        notification_icon:
          name: Notification Icon - Android Only
          default: mdi:door-open
          selector:
            icon: {}
        notification_channel:
          name: Notification Channel - Android Only
          default: "Door Entry"
          selector:
            text: {}
        notification_sound:
          name: Notification Sound - iOS Only
          default: default
          selector:
            select:
              options:
                - label: Default
                  value: default
                - label: None
                  value: none
              custom_value: true
        notification_volume:
          name: Volume Sound - iOS Only
          default: 1
          selector:
            number:
              min: 0
              max: 1
              step: 0.1
        notification_critical:
          name: Critical Notification - iOS Only
          default: false
          selector:
            boolean: {}

    zalo_settings:
      name: Zalo Notifications Settings
      icon: mdi:message-image-outline
      collapsed: true
      input:
        include_zalo_notify:
          name: Use Zalo Notifications
          default: false
          selector:
            boolean: {}
        zalo_group_id:
          name: Zalo Group ID
          default: ''
          selector:
            text: {}
        zalo_phone:
          name: Zalo Acc
          default: '+84000000000'
          selector:
            text: {}
        zalo_types:
          name: Zalo Type
          default: '0'
          selector:
            select:
              options:
                - label: User
                  value: '0'
                - label: Group
                  value: '1'
        zalo_ttl:
          name: TTL
          default: 0
          selector:
            number:
              min: 0
              max: 86400000
              step: 1000
              unit_of_measurement: seconds

    experimental_section:
      name: Additional Settings
      icon: mdi:cog
      collapsed: true
      input:
        additional_actions:
          name: Additional Actions
          default: []
          selector:
            action: {}

variables:
  door_contact: !input door_contact_sensor
  door_from_state: !input door_from_state
  door_to_state: !input door_to_state
  person_sensor: !input person_occupancy_sensor
  person_detected_state: !input person_detected_state
  wait_for_person: !input wait_for_person
  person_wait_time: !input person_wait_time
  max_wait_time: !input max_wait_time
  remember: !input remember
  cooldown: !input cooldown
  preview_mode: !input preview_mode
  analysis_mode: !input analysis_mode
  notify_devices: !input notify_device
  notification_delivery: !input notification_delivery
  notification_sticky: !input notification_sticky
  notification_color: !input notification_color
  notification_icon: !input notification_icon
  notification_channel: !input notification_channel
  notification_sound: !input notification_sound
  notification_volume: !input notification_volume
  notification_critical: !input notification_critical
  additional_actions: !input additional_actions
  notify: !input notify
  condition_notify: !input condition_notify
  delay_notification: !input delay_notification
  include_zalo_notify: !input include_zalo_notify
  zalo_group_id: !input zalo_group_id
  zalo_phone: !input zalo_phone
  zalo_types: !input zalo_types
  zalo_ttl: !input zalo_ttl
  take_snapshot: !input take_snapshot

  camera_entities_list: !input camera_entities
  camera_entity: "{{ camera_entities_list[0] if camera_entities_list else '' }}"
  camera_entity_snapshot: "{{ camera_entities_list[0] if camera_entities_list else '' }}"
  camera_file_path: "{{ camera_entity_snapshot.replace('camera.','') }}"
  file_path: !input file_path
  snapshot_access_file_path: "{{ file_path | replace('/config/www','/local') | replace('/media','/media/local') }}"
  snapshot_access_file_path_social: "{{ file_path | replace('/media/local','/media') }}"
  tag: "{{ camera_entity + int(as_timestamp(now())) | string }}"
  label: "Door Entry Detected"
  notification_time: !input notification_time

  device_name_map: >
    {% set ns = namespace(device_names=[]) %}
    {% for device_id in notify_devices %}
      {% set device_name = device_attr(device_id, "name") %}
      {% set sanitized_name = "mobile_app_" + device_name | slugify %}
      {% set ns.device_names = ns.device_names + [sanitized_name] %}
    {% endfor %}
    {{ ns.device_names }}

max_exceeded: silent
mode: single

trigger:
  - platform: state
    entity_id: !input door_contact_sensor
    id: door
    from: !input door_from_state
    to: !input door_to_state

condition:
  - condition: and
    conditions: !input run_conditions

action:
  # 1. Chờ người (nếu bật)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ wait_for_person }}"
        sequence:
          - if:
              - condition: state
                entity_id: !input person_occupancy_sensor
                state: !input person_detected_state
            then: []
            else:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ max_wait_time == 0 }}"
                    sequence:
                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input person_occupancy_sensor
                            to: !input person_detected_state
                        continue_on_timeout: true
                  - conditions:
                      - condition: template
                        value_template: "{{ max_wait_time > 0 }}"
                    sequence:
                      - wait_for_trigger:
                          - platform: state
                            entity_id: !input person_occupancy_sensor
                            to: !input person_detected_state
                        timeout:
                          seconds: "{{ max_wait_time }}"
                        continue_on_timeout: true

  # 2. Notify ban đầu (nếu bật)
  - if:
      - condition: template
        value_template: "{{ notify }}"
    then:
      - if:
          - condition: !input condition_notify
        then:
          - if:
              - condition: template
                value_template: "{{ not this.attributes.last_triggered or (now() - this.attributes.last_triggered).seconds > delay_notification }}"
            then:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ notification_delivery == 'Dynamic' }}"
                    sequence:
                      # 2a. chụp snapshot nếu được bật và chế độ là snapshot
                      - if:
                          - condition: template
                            value_template: "{{ take_snapshot and preview_mode == 'Snapshot' }}"
                        then:
                          - service: camera.snapshot
                            target:
                              entity_id: !input camera_entities
                            data:
                              filename: !input file_path
                      # 2b. gửi notify
                      - repeat:
                          for_each: "{{ device_name_map }}"
                          sequence:
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ take_snapshot and preview_mode == 'Snapshot' }}"
                                  sequence:
                                    - action: "notify.{{ repeat.item }}"
                                      data:
                                        title: "{{ label }} {{ notification_time }}"
                                        message: "Door opened, analyzing entry..."
                                        data:
                                          url: !input tap_navigate
                                          clickAction: !input tap_navigate
                                          tag: "{{ tag }}"
                                          group: !input notification_channel
                                          alert_once: true
                                          ttl: 0
                                          priority: high
                                          channel: !input notification_channel
                                          color: !input notification_color
                                          notification_icon: !input notification_icon
                                          sticky: !input notification_sticky
                                          image: "{{ snapshot_access_file_path }}"
                                          attachment:
                                            url: "{{ snapshot_access_file_path }}"
                                            content_type: JPEG
                                          push:
                                            interruption-level: active
                                            sound:
                                              name: !input notification_sound
                                              volume: !input notification_volume
                                              critical: "{{ notification_critical }}"
                                - conditions:
                                    - condition: template
                                      value_template: "{{ preview_mode == 'Live Preview' }}"
                                  sequence:
                                    - action: "notify.{{ repeat.item }}"
                                      data:
                                        title: "{{ label }} {{ notification_time }}"
                                        message: "Door opened, analyzing entry..."
                                        data:
                                          entity_id: "{{ camera_entity }}"
                                          url: !input tap_navigate
                                          tag: "{{ tag }}"
                                          group: !input notification_channel
                                          alert_once: true
                                          ttl: 0
                                          priority: high
                                          push:
                                            interruption-level: active
                                            sound:
                                              name: !input notification_sound
                                              volume: !input notification_volume
                                              critical: "{{ notification_critical }}"
                                - conditions: []
                                  sequence:
                                    - action: "notify.{{ repeat.item }}"
                                      data:
                                        title: "{{ label }} {{ notification_time }}"
                                        message: "Door opened, analyzing entry..."
                                        data:
                                          url: !input tap_navigate
                                          tag: "{{ tag }}"
                                          group: !input notification_channel
                                          alert_once: true

  # 3. Gọi AI phân tích
  - alias: Analyze door entry event
    action: llmvision.stream_analyzer
    data:
      image_entity: "{{ [camera_entity] }}"
      duration: !input duration
      provider: !input provider
      model: !input model
      message: !input message
      use_memory: !input use_memory
      remember: !input remember
      expose_images: "{{ preview_mode == 'Snapshot' or remember }}"
      generate_title: !input remember
      include_filename: true
      max_frames: !input max_frames
      target_width: !input target_width
      max_tokens: !input max_tokens
    response_variable: response

  # 4. Cập nhật label
  - variables:
      label: "{{ response.title }}"

  # 5. Cập nhật notify bằng summary
  - if:
      - condition: template
        value_template: "{{ notify }}"
    then:
      - if:
          - condition: !input condition_notify
        then:
          - if:
              - condition: template
                value_template: "{{ not this.attributes.last_triggered or (now() - this.attributes.last_triggered).seconds > delay_notification }}"
            then:
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ analysis_mode == 'Snapshot' }}"
                    sequence:
                      - repeat:
                          for_each: "{{ device_name_map }}"
                          sequence:
                            - action: "notify.{{ repeat.item }}"
                              data:
                                title: "{{ label }} {{ notification_time }}"
                                message: "{{ response.response_text }}"
                                data:
                                  image: "{{ response.key_frame.replace('/media','/media/local') }}"
                                  url: !input tap_navigate
                                  clickAction: !input tap_navigate
                                  tag: "{{ tag }}"
                                  group: !input notification_channel
                                  alert_once: true
                                  ttl: 0
                                  priority: high
                                  channel: !input notification_channel
                                  color: !input notification_color
                                  notification_icon: !input notification_icon
                                  sticky: !input notification_sticky
                                  push:
                                    interruption-level: "{{ 'passive' if notification_delivery == 'Dynamic' else 'active' }}"
                                    sound:
                                      name: !input notification_sound
                                      volume: !input notification_volume
                                      critical: "{{ notification_critical }}"
                                  actions:
                                    - action: URI
                                      title: See Snapshot
                                      uri: "{{ response.key_frame.replace('/media','/media/local') }}"
                  - conditions:
                      - condition: template
                        value_template: "{{ analysis_mode == 'Live Preview' }}"
                    sequence:
                      - repeat:
                          for_each: "{{ device_name_map }}"
                          sequence:
                            - action: "notify.{{ repeat.item }}"
                              data:
                                title: "{{ label }} {{ notification_time }}"
                                message: "{{ response.response_text }}"
                                data:
                                  entity_id: "{{ camera_entity }}"
                                  url: !input tap_navigate
                                  tag: "{{ tag }}"
                                  group: !input notification_channel
                                  alert_once: true
                                  ttl: 0
                                  priority: high
                                  push:
                                    interruption-level: active
                                    sound:
                                      name: !input notification_sound
                                      volume: !input notification_volume
                                      critical: "{{ notification_critical }}"
                                  actions:
                                    - action: URI
                                      title: See Snapshot
                                      uri: "{{ response.key_frame.replace('/media','/media/local') }}"

  # 6. Gửi Zalo (có 3 trường hợp tách rõ)
  - if:
      - condition: template
        value_template: "{{ include_zalo_notify }}"
    then:
      - choose:
          # 6.1. Có key_frame từ AI
          - conditions:
              - condition: template
                value_template: "{{ response.key_frame is defined and response.key_frame != '' }}"
            sequence:
              - action: zalo_bot.send_image
                data:
                  type: !input zalo_types
                  ttl: !input zalo_ttl
                  image_path: "{{ response.key_frame.replace('/media/local','/media') }}"
                  message: "{{ response.response_text }}"
                  thread_id: !input zalo_group_id
                  account_selection: !input zalo_phone
          # 6.2. Không có key_frame nhưng có snapshot
          - conditions:
              - condition: template
                value_template: "{{ take_snapshot }}"
            sequence:
              - action: zalo_bot.send_image
                data:
                  type: !input zalo_types
                  ttl: !input zalo_ttl
                  image_path: "{{ snapshot_access_file_path_social }}"
                  message: "{{ response.response_text }}"
                  thread_id: !input zalo_group_id
                  account_selection: !input zalo_phone
        default:
          - action: zalo_bot.send_image
            data:
              type: !input zalo_types
              ttl: !input zalo_ttl
              image_path: ""
              message: "{{ response.response_text }}"
              thread_id: !input zalo_group_id
              account_selection: !input zalo_phone

  # 7. Additional actions
  - choose: []
    default: !input additional_actions

  # 8. Cooldown
  - delay: !input cooldown
