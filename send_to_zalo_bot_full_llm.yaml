blueprint:
  name: Voice - Send to Zalo (Ultimate)
  author: luuquangvu + ultimate merge
  source_url: https://github.com/luuquangvu/tutorials/blob/main/send_to_zalo_bot_full_llm.yaml
  description: |-
    Ultimate Zalo sender for Voice Assistant.
    Supports information, location, image.
    Resolves local paths and safely deletes temporary images after sending.
  domain: script

  homeassistant:
    min_version: 2024.10.0

  input:
    zalo_settings:
      name: Settings for Zalo
      icon: mdi:alpha-z-circle-outline
      input:
        chat_id:
          name: Chat ID
          selector:
            text:
        delete_after_send:
          name: Delete Image After Sending
          description: Only deletes snapshot/tmp images
          selector:
            boolean: {}
          default: true
        delete_delay:
          name: Delete Delay (seconds)
          selector:
            number:
              min: 0
              max: 30
              step: 1
          default: 5

    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      collapsed: true
      input:
        summary_prompt:
          name: Summary Prompt
          selector:
            text:
              multiline: true
          default: |-
            Mandatory.
            Short summary (<=10 words).
            No emojis, markdown, or commentary.
            If image, write concise caption.
            Return plain text only.

        detail_prompt:
          name: Detail Prompt
          selector:
            text:
              multiline: true
          default: |-
            Optional detail text.
            No links, markdown, emojis.
            Do not repeat summary.
            Return plain text only.

        content_type_prompt:
          name: Content Type Prompt
          selector:
            text:
              multiline: true
          default: |-
            Mandatory.
            Return exactly one: information, location, image.

        location_prompt:
          name: Location Prompt
          selector:
            text:
              multiline: true
          default: |-
            Optional. Use only when content_type is location.
            Return address name only.

        image_path_prompt:
          name: Image Path Prompt
          selector:
            text:
              multiline: true
          default: |-
            Optional. Use only when content_type is image.
            Provide existing local/ or /media/ path.
            Do not guess.

        chat_id_override_prompt:
          name: Chat ID Override Prompt
          selector:
            text:
              multiline: true
          default: |-
            Optional.
            Use only when user explicitly specifies another chat.
            Return exact chat ID only.

mode: queued
max: 30
max_exceeded: silent

variables:
  version: 20251116

fields:
  summary:
    name: Summary
    description: !input summary_prompt
    selector:
      text:
    required: true

  detail:
    name: Detail
    description: !input detail_prompt
    selector:
      text:

  content_type:
    name: Content Type
    description: !input content_type_prompt
    selector:
      select:
        options:
          - information
          - location
          - image
    required: true

  location:
    name: Location
    description: !input location_prompt
    selector:
      text:

  image_path:
    name: Image Path
    description: !input image_path_prompt
    selector:
      text:

  target_chat_id:
    name: Override Chat ID
    description: !input chat_id_override_prompt
    selector:
      text:

sequence:
  - variables:
      default_chat_id: !input chat_id
      delete_after_send: !input delete_after_send
      delete_delay: !input delete_delay

      summary: "{{ summary | trim }}"
      detail: "{{ detail | default('') | trim }}"
      content_type: "{{ content_type | trim }}"
      location: "{{ location | default('') | trim }}"
      image_path: "{{ image_path | default('') | trim }}"
      override_chat_id: "{{ target_chat_id | default('') | trim }}"

      chat_id_value: >-
        {% set c = override_chat_id if override_chat_id else default_chat_id %}
        {{ c | string | trim if c else '' }}

      image_path_resolved: >-
        {% if image_path.startswith('local/') %}
          {{ '/media/' ~ image_path[6:] }}
        {% else %}
          {{ image_path }}
        {% endif %}

      is_temp_image: >-
        {{
          image_path_resolved.startswith('/media/snapshot')
          or image_path_resolved.startswith('/media/tmp')
        }}

  - alias: Validate inputs
    if:
      - condition: template
        value_template: >-
          {{
            not summary
            or content_type not in ['information','location','image']
            or not chat_id_value
            or (content_type == 'location' and not location)
            or (content_type == 'image' and not image_path)
          }}
    then:
      - stop: Invalid input for sending Zalo message.

  - choose:
      - conditions: "{{ content_type == 'information' }}"
        sequence:
          - action: pyscript.send_zalo_message
            data:
              chat_id: "{{ chat_id_value }}"
              message: |-
                {{ summary }}{% if detail %}

                {{ detail }}{% endif %}

                {% set q = summary.split() | join('+') %}
                Google Search (https://www.google.com/search?q={{ q }})
            response_variable: zalo_response

      - conditions: "{{ content_type == 'location' }}"
        sequence:
          - action: pyscript.send_zalo_message
            data:
              chat_id: "{{ chat_id_value }}"
              message: |-
                {{ summary }}{% if detail %}

                {{ detail }}{% endif %}

                {% set p = (summary ~ ' ' ~ location).split() | join('+') %}
                Google Maps (https://www.google.com/maps/search/?api=1&query={{ p }})
            response_variable: zalo_response

      - conditions: "{{ content_type == 'image' }}"
        sequence:
          - action: pyscript.send_zalo_photo
            data:
              chat_id: "{{ chat_id_value }}"
              file_path: "{{ image_path_resolved }}"
              caption: |-
                {{ summary }}{% if detail %}

                {{ detail }}{% endif %}
            response_variable: zalo_response

          - if:
              - condition: template
                value_template: "{{ delete_after_send and is_temp_image }}"
            then:
              - delay:
                  seconds: "{{ delete_delay }}"
              - action: delete.file
                data:
                  file: "{{ image_path_resolved }}"

  - stop: ""
    response_variable: zalo_response
